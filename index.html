<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cozy Capital - Inventory & Delivery Management</title>

    <!-- PWA Configuration -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ296eSBDYXBpdGFsIiwic2hvcnRfbmFtZSI6IkNvenlfQ2FwaXRhbCIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjMWU0MGFmIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIWnBaWGRDYjNnOUlqQWdNQ0E0TkRnZ09EUTRJajQ4Y21WamRDQjRQU0l6TWlJZ2VUMGlNeklpSUhkcFpIUm9QU0kzT0RRaUlHaGxhV2RvZEQwaU56ZzBJaUJtYVd4c1BTSWpNV1UwTUdGbUlqNDhMM0psWTNRK1BIQmhkR2dnWkQwaVRUUXlNQ0ExTkRKcVpEZzRlRVF3SURRME1HZ3RNVGs0Ympjek9Dd3hNallpSUdacGJHdzlJaU5tWm1abWJXWWlQand2Y0dGMGFENDhMM04yWno0PSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            color: #1f2937;
        }

        body.dragging {
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #1e40af;
        }

        .header h1 {
            font-size: 1.875rem;
            color: #1e40af;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header .subtitle {
            color: #6b7280;
            font-size: 0.95rem;
            margin-bottom: 20px;
        }

        .main-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .main-tab {
            background: #f3f4f6;
            color: #4b5563;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .main-tab:hover {
            background: #e5e7eb;
            border-color: #1e40af;
        }

        .main-tab.active {
            background: #1e40af;
            color: white;
            border-color: #1e40af;
        }

        .main-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            min-height: 65vh;
        }

        .section-title {
            font-size: 1.5rem;
            color: #1f2937;
            margin-bottom: 24px;
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .action-button {
            width: 100%;
            background: #1e40af;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 14px 24px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 24px;
        }

        .action-button:hover {
            background: #1e3a8a;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
        }

        .stat-icon {
            font-size: 1.75rem;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .item-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px;
            transition: all 0.2s ease;
        }

        .item-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-color: #1e40af;
        }

        .item-image {
            width: 100%;
            height: 200px;
            background: #f3f4f6;
            border-radius: 4px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #9ca3af;
            border: 2px dashed #d1d5db;
            cursor: pointer;
            overflow: hidden;
        }

        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .item-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }

        .item-description {
            color: #6b7280;
            margin-bottom: 16px;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .cost-breakdown {
            background: #f9fafb;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 0.875rem;
        }

        .cost-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            color: #4b5563;
        }

        .cost-row.total {
            font-weight: 600;
            color: #1f2937;
            padding-top: 6px;
            border-top: 1px solid #e5e7eb;
            margin-top: 6px;
        }

        .cost-row.profit {
            font-weight: 700;
            font-size: 0.95rem;
            padding-top: 8px;
            border-top: 2px solid #e5e7eb;
            margin-top: 8px;
        }

        .item-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .action-btn {
            padding: 10px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .send-btn {
            background: #1e40af;
            color: white;
        }

        .send-btn:hover {
            background: #1e3a8a;
        }

        .edit-btn {
            background: #f59e0b;
            color: white;
        }

        .edit-btn:hover {
            background: #d97706;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 32px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.15);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 {
            color: #1f2937;
            margin-bottom: 24px;
            font-size: 1.5rem;
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #1e40af;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .expense-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .expense-section h4 {
            font-size: 1rem;
            color: #1f2937;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .photo-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 6px;
            padding: 32px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #f9fafb;
        }

        .photo-upload-area:hover {
            border-color: #1e40af;
            background: #f3f4f6;
        }

        .photo-upload-area.has-file {
            border-color: #10b981;
            background: #d1fae5;
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            display: block;
        }

        .upload-text {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #1e40af;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3a8a;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.7;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 12px;
            color: #374151;
        }

        .empty-state p {
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Route Stops Section */
        .route-section {
            background: #f0f4ff;
            border: 1px solid #c7d2fe;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .route-header h3 {
            color: #1e40af;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .quick-add-bar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .quick-add-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-add-btn.errand {
            background: #fed7aa;
            color: #9a3412;
        }

        .quick-add-btn.errand:hover {
            background: #fdba74;
        }

        .quick-add-btn.pickup {
            background: #bbf7d0;
            color: #166534;
        }

        .quick-add-btn.pickup:hover {
            background: #86efac;
        }

        /* Route Cards */
        .route-cards-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .route-card {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            min-height: 72px;
            transition: box-shadow 0.2s ease, opacity 0.2s ease;
            overflow: hidden;
            position: relative;
        }

        .route-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .route-card.dragging {
            opacity: 0.6;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }

        .route-card.completed {
            opacity: 0.5;
            background: #f9fafb;
        }

        .route-card.completed .route-card-title,
        .route-card.completed .route-card-address {
            text-decoration: line-through;
        }

        .route-card-color-bar {
            width: 6px;
            align-self: stretch;
            flex-shrink: 0;
        }

        .type-delivery .route-card-color-bar { background: #1e40af; }
        .type-errand .route-card-color-bar { background: #ea580c; }
        .type-pickup .route-card-color-bar { background: #16a34a; }
        .type-restock .route-card-color-bar { background: #7c3aed; }

        .route-card-grab {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            flex-shrink: 0;
            cursor: grab;
            color: #9ca3af;
            font-size: 1.2rem;
            align-self: stretch;
            touch-action: none;
        }

        .route-card-grab:active {
            cursor: grabbing;
        }

        .route-card-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            margin-right: 12px;
        }

        .type-delivery .route-card-number { background: #1e40af; }
        .type-errand .route-card-number { background: #ea580c; }
        .type-pickup .route-card-number { background: #16a34a; }
        .type-restock .route-card-number { background: #7c3aed; }

        .route-card-body {
            flex: 1;
            padding: 10px 0;
            min-width: 0;
        }

        .route-card-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .route-card-address {
            font-size: 0.8rem;
            color: #6b7280;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        .route-card-time {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 2px;
        }

        .route-card-check {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            flex-shrink: 0;
            align-self: stretch;
            cursor: pointer;
        }

        .route-card-check input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #16a34a;
        }

        .route-card-delete {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            flex-shrink: 0;
            align-self: stretch;
            cursor: pointer;
            color: #d1d5db;
            font-size: 1rem;
            transition: color 0.2s;
        }

        .route-card-delete:hover {
            color: #ef4444;
        }

        .drag-placeholder {
            border: 2px dashed #93c5fd;
            border-radius: 8px;
            min-height: 72px;
            background: #eff6ff;
            margin: 4px 0;
        }

        /* Status Pipeline */
        .status-pipeline {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 4px;
            -webkit-overflow-scrolling: touch;
        }

        .status-pill {
            padding: 8px 16px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .status-pill:hover {
            background: #e5e7eb;
        }

        .status-pill.active {
            background: #1e40af;
            color: white;
            border-color: #1e40af;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.sourced { background: #dbeafe; color: #1e40af; }
        .status-badge.fixing { background: #fef3c7; color: #92400e; }
        .status-badge.listed { background: #d1fae5; color: #065f46; }
        .status-badge.pending { background: #fce7f3; color: #9d174d; }

        .category-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            background: #f3f4f6;
            color: #6b7280;
        }

        /* Quick-Add Modal (minimal) */
        .quick-modal .modal-content {
            max-width: 400px;
        }

        /* Inventory button row */
        .inventory-actions-row {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .inventory-actions-row .action-button {
            margin-bottom: 0;
        }

        .quick-add-inventory-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 14px 24px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .quick-add-inventory-btn:hover {
            background: #059669;
        }

        /* Delivery Section (legacy compat) */
        .delivery-section {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .delivery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .delivery-header h3 {
            color: #991b1b;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .delivery-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .delivery-info {
            color: #4b5563;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .complete-delivery-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }

        .complete-delivery-btn:hover {
            background: #059669;
        }

        /* History Section */
        .history-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .filter-btn.active {
            background: #1e40af;
            color: white;
            border-color: #1e40af;
        }

        .history-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .history-item-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 1rem;
        }

        .history-item-date {
            color: #6b7280;
            font-size: 0.8rem;
        }

        .profit-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .profit-badge.positive {
            background: #d1fae5;
            color: #065f46;
        }

        .profit-badge.negative {
            background: #fee2e2;
            color: #991b1b;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header, .main-content {
                padding: 16px;
            }

            .inventory-grid {
                grid-template-columns: 1fr;
            }

            .main-tabs {
                grid-template-columns: 1fr 1fr;
            }

            .modal-content {
                padding: 24px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .inventory-actions-row {
                flex-direction: column;
            }

            .route-card-title {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üè¢ Cozy Capital</h1>
            <div class="subtitle">Professional Inventory & Delivery Management</div>
            <div class="main-tabs">
                <button class="main-tab active" onclick="switchTab('furniture')">
                    üì¶ Inventory
                </button>
                <button class="main-tab" onclick="switchTab('airbnb')">
                    üè† Airbnb
                </button>
                <button class="main-tab" onclick="switchTab('history')">
                    üìä History
                </button>
                <button class="main-tab" onclick="switchTab('finances')">
                    üí∞ Finances
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Furniture Section -->
            <div id="furniture-section">
                <h2 class="section-title">Current Inventory</h2>

                <!-- Route Stops -->
                <div id="route-section" class="route-section hidden">
                    <div class="route-header">
                        <h3>üó∫Ô∏è Today's Route</h3>
                        <div class="quick-add-bar">
                            <button class="quick-add-btn errand" onclick="showErrandModal()">+ Errand</button>
                            <button class="quick-add-btn pickup" onclick="showPickupModal()">+ Pickup</button>
                        </div>
                    </div>
                    <div id="route-cards-list" class="route-cards-list">
                        <!-- Route cards rendered here -->
                    </div>
                    <div id="route-empty" class="hidden" style="text-align:center; padding: 20px; color: #6b7280; font-size: 0.9rem;">
                        No stops yet. Create a delivery or add an errand/pickup.
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="total-items">0</div>
                        <div class="stat-label">Total Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="total-invested">$0</div>
                        <div class="stat-label">Total Invested</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-value" id="potential-revenue">$0</div>
                        <div class="stat-label">Potential Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-value" id="potential-profit">$0</div>
                        <div class="stat-label">Expected Profit</div>
                    </div>
                </div>

                <!-- Status Pipeline -->
                <div class="status-pipeline">
                    <button class="status-pill active" onclick="filterByStatus('all')">All</button>
                    <button class="status-pill" onclick="filterByStatus('sourced')">Sourced</button>
                    <button class="status-pill" onclick="filterByStatus('fixing')">Fixing Up</button>
                    <button class="status-pill" onclick="filterByStatus('listed')">Listed</button>
                    <button class="status-pill" onclick="filterByStatus('pending')">Pending Sale</button>
                </div>

                <div class="inventory-actions-row">
                    <button class="action-button" onclick="showAddItemModal()" style="flex:1;">
                        ‚ûï Add New Item
                    </button>
                    <button class="quick-add-inventory-btn" onclick="showQuickAddModal()">
                        üì∏ Quick Add
                    </button>
                </div>

                <div id="furniture-inventory" class="inventory-grid">
                    <!-- Items will appear here -->
                </div>

                <div id="furniture-empty" class="empty-state">
                    <div class="empty-icon">üì¶</div>
                    <h3>No Items in Inventory</h3>
                    <p>Start tracking your inventory by adding your first item with photos, costs, and pricing.</p>
                </div>
            </div>

            <!-- Airbnb Section -->
            <div id="airbnb-section" class="hidden">
                <h2 class="section-title">Airbnb Supplies</h2>
                <div class="empty-state">
                    <div class="empty-icon">üõèÔ∏è</div>
                    <h3>Airbnb Management Coming Soon</h3>
                    <p>Track towels, sheets, cleaning supplies, and get low-stock alerts with expense tracking and tax calculations.</p>
                </div>
            </div>

            <!-- History Section -->
            <div id="history-section" class="hidden">
                <h2 class="section-title">Sales History</h2>

                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="total-sold">0</div>
                        <div class="stat-label">Items Sold</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üíµ</div>
                        <div class="stat-value" id="total-revenue">$0</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìâ</div>
                        <div class="stat-value" id="total-costs">$0</div>
                        <div class="stat-label">Total Costs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="actual-profit">$0</div>
                        <div class="stat-label">Actual Profit</div>
                    </div>
                </div>

                <div id="history-list">
                    <!-- History items will appear here -->
                </div>

                <div id="history-empty" class="empty-state">
                    <div class="empty-icon">üìã</div>
                    <h3>No Sales History Yet</h3>
                    <p>Complete deliveries to see your sales history and profit tracking here.</p>
                </div>
            </div>

            <!-- Finances Section -->
            <div id="finances-section" class="hidden">
                <h2 class="section-title">Financial Dashboard</h2>
                <div class="empty-state">
                    <div class="empty-icon">üìä</div>
                    <h3>Financial Analytics Coming Soon</h3>
                    <p>Detailed charts showing monthly income vs expenses, profit margins, and tax calculations.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="add-item-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Add New Item</h3>
            <form id="add-item-form">
                <div class="form-group">
                    <label for="item-title">Item Name *</label>
                    <input type="text" id="item-title" required placeholder="e.g., Vintage Oak Dining Table">
                </div>

                <div class="form-group">
                    <label for="item-description">Description</label>
                    <textarea id="item-description" rows="3" placeholder="Size, condition, style, features..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="item-purchase-price">Purchase Price *</label>
                        <input type="number" id="item-purchase-price" step="0.01" required placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label for="item-sale-price">Sale Price</label>
                        <input type="number" id="item-sale-price" step="0.01" placeholder="0.00">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="item-status">Status</label>
                        <select id="item-status">
                            <option value="sourced">Sourced</option>
                            <option value="fixing">Fixing Up</option>
                            <option value="listed">Listed</option>
                            <option value="pending">Pending Sale</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="item-category">Category</label>
                        <select id="item-category">
                            <option value="other">Other</option>
                            <option value="couch">Couch/Sofa</option>
                            <option value="table">Table</option>
                            <option value="chair">Chair</option>
                            <option value="dresser">Dresser/Cabinet</option>
                            <option value="bed">Bed/Frame</option>
                            <option value="desk">Desk</option>
                            <option value="shelf">Shelf/Bookcase</option>
                            <option value="decor">Decor</option>
                        </select>
                    </div>
                </div>

                <div class="expense-section">
                    <h4>üí∏ Additional Costs</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="travel-cost">Travel/Pickup Cost</label>
                            <input type="number" id="travel-cost" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="materials-cost">Materials Cost</label>
                            <input type="number" id="materials-cost" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="repair-cost">Repair/Labor Cost</label>
                        <input type="number" id="repair-cost" step="0.01" placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label>Photo</label>
                    <div class="photo-upload-area" onclick="document.getElementById('item-photo').click()">
                        <span class="upload-icon">üì∏</span>
                        <span class="upload-text">Click to add photo</span>
                        <input type="file" id="item-photo" accept="image/*" style="display: none;">
                    </div>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideAddItemModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Add Item Modal (photo-first, minimal fields) -->
    <div id="quick-add-modal" class="modal hidden quick-modal">
        <div class="modal-content">
            <h3>üì∏ Quick Add Item</h3>
            <form id="quick-add-form">
                <div class="form-group">
                    <label>Take a Photo</label>
                    <div class="photo-upload-area" onclick="document.getElementById('quick-photo').click()">
                        <span class="upload-icon">üì∑</span>
                        <span class="upload-text" id="quick-photo-text">Tap to open camera</span>
                        <input type="file" id="quick-photo" accept="image/*" capture="environment" style="display: none;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="quick-title">Title *</label>
                    <input type="text" id="quick-title" required placeholder="e.g., Blue Dresser">
                </div>

                <div class="form-group">
                    <label for="quick-price">Purchase Price *</label>
                    <input type="number" id="quick-price" step="0.01" required placeholder="0.00">
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideQuickAddModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Errand Quick-Add Modal -->
    <div id="errand-modal" class="modal hidden quick-modal">
        <div class="modal-content">
            <h3>üõí Add Errand</h3>
            <form id="errand-form">
                <div class="form-group">
                    <label for="errand-store">Store Name *</label>
                    <input type="text" id="errand-store" required placeholder="e.g., Walmart, Home Depot">
                </div>

                <div class="form-group">
                    <label for="errand-address">Address (optional)</label>
                    <input type="text" id="errand-address" placeholder="123 Main St">
                </div>

                <div class="form-group">
                    <label for="errand-list">Shopping List</label>
                    <textarea id="errand-list" rows="3" placeholder="Towels, soap, screws..."></textarea>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideErrandModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="background: #ea580c;">Add Errand</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Pickup Quick-Add Modal -->
    <div id="pickup-modal" class="modal hidden quick-modal">
        <div class="modal-content">
            <h3>üöö Add Pickup</h3>
            <form id="pickup-form">
                <div class="form-group">
                    <label for="pickup-item">Item Name *</label>
                    <input type="text" id="pickup-item" required placeholder="e.g., Free dresser from Craigslist">
                </div>

                <div class="form-group">
                    <label for="pickup-address">Pickup Address *</label>
                    <input type="text" id="pickup-address" required placeholder="456 Oak Ave">
                </div>

                <div class="form-group">
                    <label for="pickup-notes">Notes</label>
                    <textarea id="pickup-notes" rows="2" placeholder="Call when close, gate code, etc."></textarea>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hidePickupModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="background: #16a34a;">Add Pickup</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Send for Delivery Modal -->
    <div id="delivery-modal" class="modal hidden">
        <div class="modal-content">
            <h3>üì¶ Create Delivery</h3>
            <form id="delivery-form">
                <div class="form-group">
                    <label for="customer-name">Customer Name *</label>
                    <input type="text" id="customer-name" required placeholder="Customer name">
                </div>

                <div class="form-group">
                    <label for="delivery-address">Delivery Address *</label>
                    <textarea id="delivery-address" rows="2" required placeholder="Full address"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="delivery-date">Delivery Date *</label>
                        <input type="date" id="delivery-date" required>
                    </div>
                    <div class="form-group">
                        <label for="delivery-time">Time *</label>
                        <input type="time" id="delivery-time" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="final-price">Final Sale Price *</label>
                    <input type="number" id="final-price" step="0.01" required placeholder="0.00">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="payment-method">Payment Method *</label>
                        <select id="payment-method" required>
                            <option value="">Select method</option>
                            <option value="cash">üíµ Cash</option>
                            <option value="venmo">üì± Venmo</option>
                            <option value="cashapp">üí∞ Cash App</option>
                            <option value="zelle">üè¶ Zelle</option>
                            <option value="check">üìù Check</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="payment-status">Payment Status *</label>
                        <select id="payment-status" required>
                            <option value="pending">‚è≥ Pending</option>
                            <option value="paid">‚úÖ Paid</option>
                        </select>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideDeliveryModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Delivery</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Complete Delivery Modal -->
    <div id="complete-delivery-modal" class="modal hidden">
        <div class="modal-content">
            <h3>‚úÖ Complete Delivery</h3>
            <form id="complete-delivery-form">
                <div id="delivery-summary" style="background: #f9fafb; padding: 16px; border-radius: 6px; margin-bottom: 20px;">
                    <!-- Delivery info will be inserted here -->
                </div>

                <div class="form-group">
                    <label for="delivery-mileage">Delivery Mileage (miles) *</label>
                    <input type="number" id="delivery-mileage" step="0.1" required placeholder="0.0">
                    <small style="color: #6b7280; display: block; margin-top: 6px;">
                        Mileage cost: $<span id="mileage-cost">0.00</span> (at $0.67/mile)
                    </small>
                </div>

                <div class="form-group">
                    <label for="delivery-notes">Delivery Notes</label>
                    <textarea id="delivery-notes" rows="3" placeholder="Any notes about the delivery..."></textarea>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideCompleteDeliveryModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Complete Delivery</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // App State
        let currentTab = 'furniture';
        let furnitureItems = [];
        let pendingDeliveries = [];
        let routeStops = [];
        let salesHistory = [];
        let currentDeliveryItem = null;
        let currentCompletingDelivery = null;
        let currentStatusFilter = 'all';

        // Drag state
        let dragState = null; // { stopId, startY, cardEl, placeholder, startIndex }

        // Constants
        const MILEAGE_RATE = 0.67;

        const TYPE_CONFIG = {
            delivery: { color: '#1e40af', icon: 'üì¶', label: 'Delivery' },
            errand:   { color: '#ea580c', icon: 'üõí', label: 'Errand' },
            pickup:   { color: '#16a34a', icon: 'üöö', label: 'Pickup' },
            restock:  { color: '#7c3aed', icon: 'üìã', label: 'Restock' }
        };

        const CATEGORY_LABELS = {
            other: 'Other', couch: 'Couch/Sofa', table: 'Table', chair: 'Chair',
            dresser: 'Dresser/Cabinet', bed: 'Bed/Frame', desk: 'Desk',
            shelf: 'Shelf/Bookcase', decor: 'Decor'
        };

        const STATUS_LABELS = {
            sourced: 'Sourced', fixing: 'Fixing Up', listed: 'Listed', pending: 'Pending Sale'
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadData();
            migrateData();
            renderAll();
            setupEventListeners();
            requestNotificationPermission();
            console.log('Cozy Capital App Initialized');
        }

        // Notifications
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function sendNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                try {
                    new Notification(title, { body });
                } catch (e) {
                    // Fallback for environments that don't support Notification constructor
                    console.log('Notification:', title, body);
                }
            }
        }

        // Data Management
        function loadData() {
            furnitureItems = JSON.parse(localStorage.getItem('furniture-items') || '[]');
            pendingDeliveries = JSON.parse(localStorage.getItem('pending-deliveries') || '[]');
            routeStops = JSON.parse(localStorage.getItem('route-stops') || '[]');
            salesHistory = JSON.parse(localStorage.getItem('sales-history') || '[]');
        }

        function saveData() {
            localStorage.setItem('furniture-items', JSON.stringify(furnitureItems));
            localStorage.setItem('pending-deliveries', JSON.stringify(pendingDeliveries));
            localStorage.setItem('route-stops', JSON.stringify(routeStops));
            localStorage.setItem('sales-history', JSON.stringify(salesHistory));
        }

        // Migration
        function migrateData() {
            let changed = false;

            // Migrate existing pendingDeliveries to routeStops if routeStops is empty
            if (routeStops.length === 0 && pendingDeliveries.length > 0) {
                pendingDeliveries.forEach((delivery, i) => {
                    routeStops.push({
                        id: 'stop' + Date.now() + i,
                        type: 'delivery',
                        title: 'Deliver ' + delivery.item + ' to ' + delivery.customer,
                        address: delivery.address,
                        datetime: delivery.datetime,
                        notes: '',
                        deliveryId: delivery.id,
                        completed: false,
                        order: i
                    });
                });
                changed = true;
            }

            // Migrate existing items: add status and category if missing
            furnitureItems.forEach(item => {
                if (!item.status) {
                    item.status = 'listed';
                    changed = true;
                }
                if (!item.category) {
                    item.category = 'other';
                    changed = true;
                }
            });

            if (changed) saveData();
        }

        function renderAll() {
            renderFurnitureItems();
            renderRouteStops();
            renderSalesHistory();
            updateStats();
        }

        // Tab Management
        function switchTab(tab) {
            currentTab = tab;

            document.querySelectorAll('.main-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('[id$="-section"]').forEach(section => {
                if (['furniture-section','airbnb-section','history-section','finances-section'].includes(section.id)) {
                    section.classList.add('hidden');
                }
            });
            document.getElementById(tab + '-section').classList.remove('hidden');
        }

        // Status Pipeline Filter
        function filterByStatus(status) {
            currentStatusFilter = status;
            document.querySelectorAll('.status-pill').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderFurnitureItems();
        }

        // Stats Updates
        function updateStats() {
            const totalItems = furnitureItems.length;
            const totalInvested = furnitureItems.reduce((sum, item) => {
                return sum + calculateTotalCost(item);
            }, 0);
            const potentialRevenue = furnitureItems.reduce((sum, item) => sum + (item.salePrice || 0), 0);
            const potentialProfit = potentialRevenue - totalInvested;

            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('total-invested').textContent = '$' + totalInvested.toFixed(2);
            document.getElementById('potential-revenue').textContent = '$' + potentialRevenue.toFixed(2);
            document.getElementById('potential-profit').textContent = '$' + potentialProfit.toFixed(2);

            const profitElement = document.getElementById('potential-profit');
            profitElement.style.color = potentialProfit >= 0 ? '#059669' : '#dc2626';

            const totalSold = salesHistory.length;
            const totalRevenue = salesHistory.reduce((sum, sale) => sum + sale.finalPrice, 0);
            const totalCosts = salesHistory.reduce((sum, sale) => sum + sale.totalCost, 0);
            const actualProfit = totalRevenue - totalCosts;

            document.getElementById('total-sold').textContent = totalSold;
            document.getElementById('total-revenue').textContent = '$' + totalRevenue.toFixed(2);
            document.getElementById('total-costs').textContent = '$' + totalCosts.toFixed(2);
            document.getElementById('actual-profit').textContent = '$' + actualProfit.toFixed(2);

            const actualProfitElement = document.getElementById('actual-profit');
            actualProfitElement.style.color = actualProfit >= 0 ? '#059669' : '#dc2626';
        }

        function calculateTotalCost(item) {
            return (item.purchasePrice || 0) +
                   (item.travelCost || 0) +
                   (item.materialsCost || 0) +
                   (item.repairCost || 0) +
                   (item.deliveryMileageCost || 0);
        }

        // Furniture Items Rendering
        function renderFurnitureItems() {
            const container = document.getElementById('furniture-inventory');
            const emptyState = document.getElementById('furniture-empty');

            let items = furnitureItems;
            if (currentStatusFilter !== 'all') {
                items = items.filter(item => item.status === currentStatusFilter);
            }

            if (items.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                if (furnitureItems.length > 0 && currentStatusFilter !== 'all') {
                    emptyState.querySelector('h3').textContent = 'No "' + STATUS_LABELS[currentStatusFilter] + '" Items';
                    emptyState.querySelector('p').textContent = 'No items match this filter.';
                } else {
                    emptyState.querySelector('h3').textContent = 'No Items in Inventory';
                    emptyState.querySelector('p').textContent = 'Start tracking your inventory by adding your first item with photos, costs, and pricing.';
                }
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = '';

            items.forEach(item => {
                const card = createItemCard(item);
                container.appendChild(card);
            });
        }

        function createItemCard(item) {
            const card = document.createElement('div');
            card.className = 'item-card';

            const totalCost = calculateTotalCost(item);
            const profit = (item.salePrice || 0) - totalCost;
            const profitColor = profit >= 0 ? '#059669' : '#dc2626';

            const statusBadge = item.status ? '<span class="status-badge ' + item.status + '">' + STATUS_LABELS[item.status] + '</span>' : '';
            const categoryTag = item.category && item.category !== 'other' ? '<span class="category-tag">' + CATEGORY_LABELS[item.category] + '</span>' : '';

            card.innerHTML = `
                <div class="item-image" onclick="viewPhoto('${item.id}')">
                    ${item.photo ? `<img src="${item.photo}" alt="${item.title}">` : 'üì¶'}
                </div>
                <div class="item-header">
                    <div class="item-title">${item.title}</div>
                    ${statusBadge}
                    ${categoryTag}
                </div>
                <div class="item-description">${item.description || 'No description'}</div>
                <div class="cost-breakdown">
                    <div class="cost-row">
                        <span>Purchase:</span>
                        <span>$${item.purchasePrice.toFixed(2)}</span>
                    </div>
                    ${item.travelCost ? `<div class="cost-row">
                        <span>Travel:</span>
                        <span>$${item.travelCost.toFixed(2)}</span>
                    </div>` : ''}
                    ${item.materialsCost ? `<div class="cost-row">
                        <span>Materials:</span>
                        <span>$${item.materialsCost.toFixed(2)}</span>
                    </div>` : ''}
                    ${item.repairCost ? `<div class="cost-row">
                        <span>Repairs:</span>
                        <span>$${item.repairCost.toFixed(2)}</span>
                    </div>` : ''}
                    <div class="cost-row total">
                        <span>Total Cost:</span>
                        <span>$${totalCost.toFixed(2)}</span>
                    </div>
                    ${item.salePrice ? `
                    <div class="cost-row" style="color: #1e40af; font-weight: 600;">
                        <span>Sale Price:</span>
                        <span>$${item.salePrice.toFixed(2)}</span>
                    </div>
                    <div class="cost-row profit" style="color: ${profitColor};">
                        <span>Expected Profit:</span>
                        <span>$${profit.toFixed(2)}</span>
                    </div>` : ''}
                </div>
                <div class="item-actions">
                    <button class="action-btn send-btn" onclick="showDeliveryModal('${item.id}')">
                        üì¶ Deliver
                    </button>
                    <button class="action-btn edit-btn" onclick="editItem('${item.id}')">
                        ‚úèÔ∏è Edit
                    </button>
                    <button class="action-btn delete-btn" onclick="deleteItem('${item.id}')">
                        üóëÔ∏è
                    </button>
                </div>
            `;

            return card;
        }

        // ========== ROUTE STOPS ==========

        function renderRouteStops() {
            const section = document.getElementById('route-section');
            const list = document.getElementById('route-cards-list');
            const emptyEl = document.getElementById('route-empty');

            if (routeStops.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');

            // Sort: incomplete first (by order), completed at bottom
            const incomplete = routeStops.filter(s => !s.completed).sort((a, b) => a.order - b.order);
            const completed = routeStops.filter(s => s.completed);
            const sorted = [...incomplete, ...completed];

            if (sorted.length === 0) {
                list.innerHTML = '';
                emptyEl.classList.remove('hidden');
                return;
            }

            emptyEl.classList.add('hidden');
            list.innerHTML = '';

            let stopNum = 1;
            sorted.forEach(stop => {
                const card = document.createElement('div');
                card.className = 'route-card type-' + stop.type + (stop.completed ? ' completed' : '');
                card.dataset.stopId = stop.id;

                const num = stop.completed ? '‚úì' : stopNum++;
                const timeStr = stop.datetime ? formatTime(stop.datetime) : '';
                const cfg = TYPE_CONFIG[stop.type] || TYPE_CONFIG.errand;

                card.innerHTML = `
                    <div class="route-card-color-bar"></div>
                    <div class="route-card-grab" data-grab="true">‚ò∞</div>
                    <div class="route-card-number">${num}</div>
                    <div class="route-card-body">
                        <div class="route-card-title">${cfg.icon} ${stop.title}</div>
                        ${stop.address ? '<div class="route-card-address">' + stop.address + '</div>' : ''}
                        ${timeStr ? '<div class="route-card-time">' + timeStr + '</div>' : ''}
                        ${stop.notes ? '<div class="route-card-time">üìù ' + stop.notes + '</div>' : ''}
                    </div>
                    <div class="route-card-check">
                        <input type="checkbox" ${stop.completed ? 'checked' : ''} onchange="toggleStopComplete('${stop.id}')">
                    </div>
                    <div class="route-card-delete" onclick="deleteRouteStop('${stop.id}')" title="Remove stop">‚úï</div>
                `;

                // Touch drag setup
                const grabHandle = card.querySelector('[data-grab]');
                grabHandle.addEventListener('touchstart', onTouchDragStart, { passive: false });
                grabHandle.addEventListener('mousedown', onMouseDragStart);

                list.appendChild(card);
            });
        }

        function formatTime(datetime) {
            try {
                const d = new Date(datetime);
                return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch(e) { return ''; }
        }

        function toggleStopComplete(stopId) {
            const stop = routeStops.find(s => s.id === stopId);
            if (!stop) return;

            if (!stop.completed && stop.type === 'delivery' && stop.deliveryId) {
                // For delivery stops, open the complete delivery modal
                const delivery = pendingDeliveries.find(d => d.id === stop.deliveryId);
                if (delivery) {
                    showCompleteDeliveryModal(delivery.id);
                    // Re-render to uncheck the checkbox since completion happens via modal
                    renderRouteStops();
                    return;
                }
            }

            stop.completed = !stop.completed;
            if (stop.completed) {
                stop.completedAt = new Date().toISOString();
            } else {
                delete stop.completedAt;
            }
            saveData();
            renderRouteStops();
        }

        function deleteRouteStop(stopId) {
            const stop = routeStops.find(s => s.id === stopId);
            if (!stop) return;

            const label = stop.title;
            if (!confirm('Remove "' + label + '" from your route?')) return;

            routeStops = routeStops.filter(s => s.id !== stopId);
            // Reorder remaining
            routeStops.filter(s => !s.completed).sort((a, b) => a.order - b.order).forEach((s, i) => s.order = i);
            saveData();
            renderRouteStops();
        }

        // ========== TOUCH DRAG & DROP ==========

        function onTouchDragStart(e) {
            e.preventDefault();
            const card = e.target.closest('.route-card');
            if (!card || card.classList.contains('completed')) return;

            const touch = e.touches[0];
            startDrag(card, touch.clientY);

            document.addEventListener('touchmove', onTouchDragMove, { passive: false });
            document.addEventListener('touchend', onTouchDragEnd);
        }

        function onTouchDragMove(e) {
            e.preventDefault();
            if (!dragState) return;
            moveDrag(e.touches[0].clientY);
        }

        function onTouchDragEnd(e) {
            document.removeEventListener('touchmove', onTouchDragMove);
            document.removeEventListener('touchend', onTouchDragEnd);
            endDrag();
        }

        function onMouseDragStart(e) {
            const card = e.target.closest('.route-card');
            if (!card || card.classList.contains('completed')) return;

            e.preventDefault();
            startDrag(card, e.clientY);

            document.addEventListener('mousemove', onMouseDragMove);
            document.addEventListener('mouseup', onMouseDragEnd);
        }

        function onMouseDragMove(e) {
            if (!dragState) return;
            moveDrag(e.clientY);
        }

        function onMouseDragEnd(e) {
            document.removeEventListener('mousemove', onMouseDragMove);
            document.removeEventListener('mouseup', onMouseDragEnd);
            endDrag();
        }

        function startDrag(card, startY) {
            document.body.classList.add('dragging');

            const stopId = card.dataset.stopId;
            const list = document.getElementById('route-cards-list');
            const cards = Array.from(list.querySelectorAll('.route-card:not(.completed)'));
            const startIndex = cards.indexOf(card);

            // Create placeholder
            const placeholder = document.createElement('div');
            placeholder.className = 'drag-placeholder';
            placeholder.style.height = card.offsetHeight + 'px';

            // Position card for dragging
            const rect = card.getBoundingClientRect();
            card.classList.add('dragging');
            card.style.position = 'fixed';
            card.style.top = rect.top + 'px';
            card.style.left = rect.left + 'px';
            card.style.width = rect.width + 'px';
            card.style.zIndex = '1001';

            card.parentNode.insertBefore(placeholder, card);

            dragState = {
                stopId,
                startY,
                offsetY: startY - rect.top,
                cardEl: card,
                placeholder,
                startIndex,
                currentIndex: startIndex
            };
        }

        function moveDrag(clientY) {
            if (!dragState) return;

            // Move the card
            dragState.cardEl.style.top = (clientY - dragState.offsetY) + 'px';

            // Determine new position
            const list = document.getElementById('route-cards-list');
            const siblings = Array.from(list.querySelectorAll('.route-card:not(.completed):not(.dragging), .drag-placeholder'));
            const placeholderIndex = siblings.indexOf(dragState.placeholder);

            for (let i = 0; i < siblings.length; i++) {
                if (siblings[i] === dragState.placeholder) continue;
                const rect = siblings[i].getBoundingClientRect();
                const midY = rect.top + rect.height / 2;

                if (clientY < midY && i < placeholderIndex) {
                    list.insertBefore(dragState.placeholder, siblings[i]);
                    dragState.currentIndex = i;
                    break;
                } else if (clientY > midY && i > placeholderIndex) {
                    if (siblings[i].nextSibling) {
                        list.insertBefore(dragState.placeholder, siblings[i].nextSibling);
                    } else {
                        list.appendChild(dragState.placeholder);
                    }
                    dragState.currentIndex = i;
                    break;
                }
            }
        }

        function endDrag() {
            if (!dragState) return;

            document.body.classList.remove('dragging');

            const { cardEl, placeholder, stopId } = dragState;

            // Reset card styles
            cardEl.classList.remove('dragging');
            cardEl.style.position = '';
            cardEl.style.top = '';
            cardEl.style.left = '';
            cardEl.style.width = '';
            cardEl.style.zIndex = '';

            // Insert card where placeholder is
            placeholder.parentNode.insertBefore(cardEl, placeholder);
            placeholder.remove();

            // Read new order from DOM
            const list = document.getElementById('route-cards-list');
            const cardEls = Array.from(list.querySelectorAll('.route-card:not(.completed)'));
            cardEls.forEach((el, i) => {
                const stop = routeStops.find(s => s.id === el.dataset.stopId);
                if (stop) stop.order = i;
            });

            dragState = null;
            saveData();
            renderRouteStops();
        }

        // ========== MODAL MANAGEMENT ==========

        function showAddItemModal() {
            document.getElementById('add-item-modal').classList.remove('hidden');
        }

        function hideAddItemModal() {
            document.getElementById('add-item-modal').classList.add('hidden');
            document.getElementById('add-item-form').reset();
            resetPhotoUpload();
            document.querySelector('#add-item-modal h3').textContent = 'Add New Item';
            document.querySelector('#add-item-form button[type="submit"]').textContent = 'Add Item';
            window.editingItemId = null;
        }

        function showQuickAddModal() {
            document.getElementById('quick-add-modal').classList.remove('hidden');
            // Reset
            document.getElementById('quick-add-form').reset();
            document.getElementById('quick-photo-text').textContent = 'Tap to open camera';
            document.querySelector('#quick-add-modal .photo-upload-area').classList.remove('has-file');
        }

        function hideQuickAddModal() {
            document.getElementById('quick-add-modal').classList.add('hidden');
            document.getElementById('quick-add-form').reset();
        }

        function showErrandModal() {
            document.getElementById('errand-modal').classList.remove('hidden');
        }

        function hideErrandModal() {
            document.getElementById('errand-modal').classList.add('hidden');
            document.getElementById('errand-form').reset();
        }

        function showPickupModal() {
            document.getElementById('pickup-modal').classList.remove('hidden');
        }

        function hidePickupModal() {
            document.getElementById('pickup-modal').classList.add('hidden');
            document.getElementById('pickup-form').reset();
        }

        function showDeliveryModal(itemId) {
            currentDeliveryItem = furnitureItems.find(item => item.id === itemId);
            document.getElementById('final-price').value = currentDeliveryItem.salePrice || '';
            document.getElementById('delivery-modal').classList.remove('hidden');
        }

        function hideDeliveryModal() {
            document.getElementById('delivery-modal').classList.add('hidden');
            document.getElementById('delivery-form').reset();
            currentDeliveryItem = null;
        }

        function showCompleteDeliveryModal(deliveryId) {
            currentCompletingDelivery = pendingDeliveries.find(d => d.id === deliveryId);
            if (!currentCompletingDelivery) return;

            const summary = document.getElementById('delivery-summary');
            summary.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">üì¶ ${currentCompletingDelivery.item}</div>
                <div style="color: #6b7280; font-size: 0.875rem; line-height: 1.6;">
                    üë§ ${currentCompletingDelivery.customer}<br>
                    üìç ${currentCompletingDelivery.address}<br>
                    üí∞ $${currentCompletingDelivery.price}
                </div>
            `;

            document.getElementById('complete-delivery-modal').classList.remove('hidden');
        }

        function hideCompleteDeliveryModal() {
            document.getElementById('complete-delivery-modal').classList.add('hidden');
            document.getElementById('complete-delivery-form').reset();
            currentCompletingDelivery = null;
        }

        // Photo Upload
        function setupEventListeners() {
            const photoInput = document.getElementById('item-photo');
            const uploadArea = document.querySelector('#add-item-modal .photo-upload-area');

            photoInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    uploadArea.classList.add('has-file');
                    uploadArea.querySelector('.upload-text').textContent = 'üì∏ ' + e.target.files[0].name;
                } else {
                    resetPhotoUpload();
                }
            });

            // Quick photo
            document.getElementById('quick-photo').addEventListener('change', function(e) {
                const area = document.querySelector('#quick-add-modal .photo-upload-area');
                if (e.target.files.length > 0) {
                    area.classList.add('has-file');
                    document.getElementById('quick-photo-text').textContent = 'üì∏ Photo added!';
                } else {
                    area.classList.remove('has-file');
                    document.getElementById('quick-photo-text').textContent = 'Tap to open camera';
                }
            });

            // Mileage cost calculator
            document.getElementById('delivery-mileage').addEventListener('input', function(e) {
                const miles = parseFloat(e.target.value) || 0;
                const cost = miles * MILEAGE_RATE;
                document.getElementById('mileage-cost').textContent = cost.toFixed(2);
            });

            // Form handlers
            document.getElementById('add-item-form').addEventListener('submit', handleAddEditItem);
            document.getElementById('delivery-form').addEventListener('submit', handleCreateDelivery);
            document.getElementById('complete-delivery-form').addEventListener('submit', handleCompleteDelivery);
            document.getElementById('quick-add-form').addEventListener('submit', handleQuickAdd);
            document.getElementById('errand-form').addEventListener('submit', handleAddErrand);
            document.getElementById('pickup-form').addEventListener('submit', handleAddPickup);
        }

        function resetPhotoUpload() {
            const uploadArea = document.querySelector('#add-item-modal .photo-upload-area');
            uploadArea.classList.remove('has-file');
            uploadArea.querySelector('.upload-text').textContent = 'Click to add photo';
        }

        // ========== FORM HANDLERS ==========

        function handleAddEditItem(e) {
            e.preventDefault();

            const title = document.getElementById('item-title').value;
            const description = document.getElementById('item-description').value;
            const purchasePrice = parseFloat(document.getElementById('item-purchase-price').value);
            const salePrice = parseFloat(document.getElementById('item-sale-price').value) || null;
            const travelCost = parseFloat(document.getElementById('travel-cost').value) || 0;
            const materialsCost = parseFloat(document.getElementById('materials-cost').value) || 0;
            const repairCost = parseFloat(document.getElementById('repair-cost').value) || 0;
            const status = document.getElementById('item-status').value;
            const category = document.getElementById('item-category').value;
            const photoFile = document.getElementById('item-photo').files[0];

            const itemData = {
                title,
                description,
                purchasePrice,
                salePrice,
                travelCost,
                materialsCost,
                repairCost,
                status,
                category,
                updatedAt: new Date().toISOString()
            };

            if (window.editingItemId) {
                const itemIndex = furnitureItems.findIndex(item => item.id === window.editingItemId);
                if (itemIndex !== -1) {
                    furnitureItems[itemIndex] = { ...furnitureItems[itemIndex], ...itemData };

                    if (photoFile) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            furnitureItems[itemIndex].photo = e.target.result;
                            saveData();
                            renderAll();
                            hideAddItemModal();
                        };
                        reader.readAsDataURL(photoFile);
                    } else {
                        saveData();
                        renderAll();
                        hideAddItemModal();
                    }
                }
            } else {
                const newItem = {
                    id: 'item' + Date.now(),
                    ...itemData,
                    createdAt: new Date().toISOString(),
                    photo: null
                };

                if (photoFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        newItem.photo = e.target.result;
                        furnitureItems.push(newItem);
                        saveData();
                        renderAll();
                        hideAddItemModal();
                    };
                    reader.readAsDataURL(photoFile);
                } else {
                    furnitureItems.push(newItem);
                    saveData();
                    renderAll();
                    hideAddItemModal();
                }
            }
        }

        function handleQuickAdd(e) {
            e.preventDefault();

            const title = document.getElementById('quick-title').value;
            const purchasePrice = parseFloat(document.getElementById('quick-price').value);
            const photoFile = document.getElementById('quick-photo').files[0];

            const newItem = {
                id: 'item' + Date.now(),
                title,
                description: '',
                purchasePrice,
                salePrice: null,
                travelCost: 0,
                materialsCost: 0,
                repairCost: 0,
                status: 'sourced',
                category: 'other',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                photo: null
            };

            if (photoFile) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    newItem.photo = ev.target.result;
                    furnitureItems.push(newItem);
                    saveData();
                    renderAll();
                    hideQuickAddModal();
                };
                reader.readAsDataURL(photoFile);
            } else {
                furnitureItems.push(newItem);
                saveData();
                renderAll();
                hideQuickAddModal();
            }
        }

        function handleAddErrand(e) {
            e.preventDefault();

            const storeName = document.getElementById('errand-store').value;
            const address = document.getElementById('errand-address').value;
            const shoppingList = document.getElementById('errand-list').value;

            const maxOrder = routeStops.filter(s => !s.completed).reduce((max, s) => Math.max(max, s.order), -1);

            routeStops.push({
                id: 'stop' + Date.now(),
                type: 'errand',
                title: storeName,
                address: address,
                datetime: null,
                notes: shoppingList,
                storeName: storeName,
                shoppingList: shoppingList,
                completed: false,
                order: maxOrder + 1
            });

            saveData();
            renderRouteStops();
            hideErrandModal();
        }

        function handleAddPickup(e) {
            e.preventDefault();

            const itemName = document.getElementById('pickup-item').value;
            const address = document.getElementById('pickup-address').value;
            const notes = document.getElementById('pickup-notes').value;

            const maxOrder = routeStops.filter(s => !s.completed).reduce((max, s) => Math.max(max, s.order), -1);

            routeStops.push({
                id: 'stop' + Date.now(),
                type: 'pickup',
                title: 'Pick up: ' + itemName,
                address: address,
                datetime: null,
                notes: notes,
                completed: false,
                order: maxOrder + 1
            });

            saveData();
            renderRouteStops();
            hidePickupModal();
        }

        function handleCreateDelivery(e) {
            e.preventDefault();

            const date = document.getElementById('delivery-date').value;
            const time = document.getElementById('delivery-time').value;
            const datetime = new Date(date + 'T' + time).toISOString();

            const customerName = document.getElementById('customer-name').value;
            const itemName = currentDeliveryItem.title;

            const deliveryRequest = {
                id: 'delivery' + Date.now(),
                item: itemName,
                itemId: currentDeliveryItem.id,
                customer: customerName,
                address: document.getElementById('delivery-address').value,
                datetime: datetime,
                price: parseFloat(document.getElementById('final-price').value),
                paymentMethod: document.getElementById('payment-method').value,
                paymentStatus: document.getElementById('payment-status').value,
                sentAt: new Date().toISOString()
            };

            pendingDeliveries.push(deliveryRequest);

            // Auto-add to routeStops
            const maxOrder = routeStops.filter(s => !s.completed).reduce((max, s) => Math.max(max, s.order), -1);
            routeStops.push({
                id: 'stop' + Date.now(),
                type: 'delivery',
                title: 'Deliver ' + itemName + ' to ' + customerName,
                address: deliveryRequest.address,
                datetime: datetime,
                notes: '',
                deliveryId: deliveryRequest.id,
                completed: false,
                order: maxOrder + 1
            });

            // Update item status to pending
            const itemIndex = furnitureItems.findIndex(i => i.id === currentDeliveryItem.id);
            if (itemIndex !== -1) {
                furnitureItems[itemIndex].status = 'pending';
            }

            saveData();
            renderAll();
            hideDeliveryModal();

            const deliveryDate = new Date(datetime);
            sendNotification(
                'Delivery Created',
                itemName + ' to ' + customerName + ' on ' + deliveryDate.toLocaleDateString()
            );
        }

        function handleCompleteDelivery(e) {
            e.preventDefault();

            const mileage = parseFloat(document.getElementById('delivery-mileage').value);
            const mileageCost = mileage * MILEAGE_RATE;
            const notes = document.getElementById('delivery-notes').value;

            const item = furnitureItems.find(i => i.id === currentCompletingDelivery.itemId);
            if (!item) return;

            const totalCost = calculateTotalCost(item) + mileageCost;
            const profit = currentCompletingDelivery.price - totalCost;

            const historyEntry = {
                id: 'history' + Date.now(),
                item: currentCompletingDelivery.item,
                customer: currentCompletingDelivery.customer,
                finalPrice: currentCompletingDelivery.price,
                purchasePrice: item.purchasePrice,
                travelCost: item.travelCost || 0,
                materialsCost: item.materialsCost || 0,
                repairCost: item.repairCost || 0,
                deliveryMileage: mileage,
                deliveryMileageCost: mileageCost,
                totalCost: totalCost,
                profit: profit,
                paymentMethod: currentCompletingDelivery.paymentMethod,
                paymentStatus: currentCompletingDelivery.paymentStatus,
                deliveryDate: currentCompletingDelivery.datetime,
                completedDate: new Date().toISOString(),
                notes: notes,
                photo: item.photo
            };

            salesHistory.push(historyEntry);

            // Mark route stop as completed
            const routeStop = routeStops.find(s => s.deliveryId === currentCompletingDelivery.id);
            if (routeStop) {
                routeStop.completed = true;
                routeStop.completedAt = new Date().toISOString();
            }

            // Remove from pending deliveries
            pendingDeliveries = pendingDeliveries.filter(d => d.id !== currentCompletingDelivery.id);

            // Remove from inventory
            furnitureItems = furnitureItems.filter(i => i.id !== currentCompletingDelivery.itemId);

            saveData();
            renderAll();
            hideCompleteDeliveryModal();

            sendNotification(
                'Delivery Complete',
                historyEntry.item + ' - Profit: $' + profit.toFixed(2)
            );
        }

        // Item Actions
        function editItem(itemId) {
            const item = furnitureItems.find(item => item.id === itemId);
            if (!item) return;

            document.getElementById('item-title').value = item.title;
            document.getElementById('item-description').value = item.description || '';
            document.getElementById('item-purchase-price').value = item.purchasePrice;
            document.getElementById('item-sale-price').value = item.salePrice || '';
            document.getElementById('travel-cost').value = item.travelCost || '';
            document.getElementById('materials-cost').value = item.materialsCost || '';
            document.getElementById('repair-cost').value = item.repairCost || '';
            document.getElementById('item-status').value = item.status || 'sourced';
            document.getElementById('item-category').value = item.category || 'other';

            document.querySelector('#add-item-modal h3').textContent = 'Edit Item';
            document.querySelector('#add-item-form button[type="submit"]').textContent = 'Update Item';

            window.editingItemId = itemId;
            showAddItemModal();
        }

        function deleteItem(itemId) {
            const item = furnitureItems.find(item => item.id === itemId);
            if (confirm('Delete "' + item.title + '"? This cannot be undone.')) {
                furnitureItems = furnitureItems.filter(item => item.id !== itemId);
                saveData();
                renderAll();
            }
        }

        function viewPhoto(itemId) {
            const item = furnitureItems.find(item => item.id === itemId);
            if (item.photo) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 90vw; padding: 24px;">
                        <h3>${item.title}</h3>
                        <img src="${item.photo}" style="width: 100%; height: auto; max-height: 70vh; object-fit: contain; border-radius: 6px; margin-top: 16px;">
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                        </div>
                    </div>
                `;
                modal.onclick = (e) => {
                    if (e.target === modal) modal.remove();
                };
                document.body.appendChild(modal);
            }
        }

        // Sales History
        function renderSalesHistory() {
            const list = document.getElementById('history-list');
            const emptyState = document.getElementById('history-empty');

            if (salesHistory.length === 0) {
                list.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            list.innerHTML = '';

            const sorted = [...salesHistory].sort((a, b) =>
                new Date(b.completedDate) - new Date(a.completedDate)
            );

            sorted.forEach(sale => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';

                const completedDate = new Date(sale.completedDate);
                const dateStr = completedDate.toLocaleDateString();

                const profitClass = sale.profit >= 0 ? 'positive' : 'negative';

                historyItem.innerHTML = `
                    <div class="history-item-header">
                        <div>
                            <div class="history-item-title">${sale.item}</div>
                            <div class="history-item-date">${dateStr} ‚Ä¢ ${sale.customer}</div>
                        </div>
                        <span class="profit-badge ${profitClass}">
                            ${sale.profit >= 0 ? '+' : ''}$${sale.profit.toFixed(2)}
                        </span>
                    </div>
                    <div class="cost-breakdown">
                        <div class="cost-row">
                            <span>Purchase:</span>
                            <span>$${sale.purchasePrice.toFixed(2)}</span>
                        </div>
                        ${sale.travelCost ? '<div class="cost-row"><span>Travel:</span><span>$' + sale.travelCost.toFixed(2) + '</span></div>' : ''}
                        ${sale.materialsCost ? '<div class="cost-row"><span>Materials:</span><span>$' + sale.materialsCost.toFixed(2) + '</span></div>' : ''}
                        ${sale.repairCost ? '<div class="cost-row"><span>Repairs:</span><span>$' + sale.repairCost.toFixed(2) + '</span></div>' : ''}
                        ${sale.deliveryMileageCost ? '<div class="cost-row"><span>Delivery (' + sale.deliveryMileage + ' mi):</span><span>$' + sale.deliveryMileageCost.toFixed(2) + '</span></div>' : ''}
                        <div class="cost-row total">
                            <span>Total Cost:</span>
                            <span>$${sale.totalCost.toFixed(2)}</span>
                        </div>
                        <div class="cost-row" style="color: #1e40af; font-weight: 600;">
                            <span>Sale Price:</span>
                            <span>$${sale.finalPrice.toFixed(2)}</span>
                        </div>
                    </div>
                    ${sale.notes ? '<div style="margin-top: 12px; color: #6b7280; font-size: 0.875rem; font-style: italic;">' + sale.notes + '</div>' : ''}
                `;

                list.appendChild(historyItem);
            });
        }

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(
                URL.createObjectURL(new Blob([`
                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open('cozy-capital-v1').then(function(cache) {
                                return cache.addAll(['/']);
                            })
                        );
                    });

                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request).then(function(response) {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `], { type: 'application/javascript' }))
            ).then(registration => {
                console.log('Service Worker registered');
            }).catch(error => {
                console.log('Service Worker registration failed:', error);
            });
        }
    </script>
</body>
</html>
