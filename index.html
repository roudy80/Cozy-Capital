<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cozy Capital - Inventory & Delivery Management</title>

    <!-- PWA Configuration -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ296eSBDYXBpdGFsIiwic2hvcnRfbmFtZSI6IkNvenlfQ2FwaXRhbCIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjMWU0MGFmIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIWnBaWGRDYjNnOUlqQWdNQ0E0TkRnZ09EUTRJajQ4Y21WamRDQjRQU0l6TWlJZ2VUMGlNeklpSUhkcFpIUm9QU0kzT0RRaUlHaGxhV2RvZEQwaU56ZzBJaUJtYVd4c1BTSWpNV1UwTUdGbUlqNDhMM0psWTNRK1BIQmhkR2dnWkQwaVRUUXlNQ0ExTkRKcVpEZzRlRVF3SURRME1HZ3RNVGs0Ympjek9Dd3hNallpSUdacGJHdzlJaU5tWm1abWJXWWlQand2Y0dGMGFENDhMM04yWno0PSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            color: #1f2937;
        }

        body.dragging {
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #1e40af;
        }

        .header h1 {
            font-size: 1.875rem;
            color: #1e40af;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header .subtitle {
            color: #6b7280;
            font-size: 0.95rem;
            margin-bottom: 20px;
        }

        .main-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .main-tab {
            background: #f3f4f6;
            color: #4b5563;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .main-tab:hover {
            background: #e5e7eb;
            border-color: #1e40af;
        }

        .main-tab.active {
            background: #1e40af;
            color: white;
            border-color: #1e40af;
        }

        .main-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            min-height: 65vh;
        }

        .section-title {
            font-size: 1.5rem;
            color: #1f2937;
            margin-bottom: 24px;
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .action-button {
            width: 100%;
            background: #1e40af;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 14px 24px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 24px;
        }

        .action-button:hover {
            background: #1e3a8a;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
        }

        .stat-icon {
            font-size: 1.75rem;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .item-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px;
            transition: all 0.2s ease;
        }

        .item-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-color: #1e40af;
        }

        .item-image {
            width: 100%;
            height: 200px;
            background: #f3f4f6;
            border-radius: 4px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #9ca3af;
            border: 2px dashed #d1d5db;
            cursor: pointer;
            overflow: hidden;
        }

        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .item-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }

        .item-description {
            color: #6b7280;
            margin-bottom: 16px;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .cost-breakdown {
            background: #f9fafb;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 0.875rem;
        }

        .cost-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            color: #4b5563;
        }

        .cost-row.total {
            font-weight: 600;
            color: #1f2937;
            padding-top: 6px;
            border-top: 1px solid #e5e7eb;
            margin-top: 6px;
        }

        .cost-row.profit {
            font-weight: 700;
            font-size: 0.95rem;
            padding-top: 8px;
            border-top: 2px solid #e5e7eb;
            margin-top: 8px;
        }

        .item-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .action-btn {
            padding: 10px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .send-btn {
            background: #1e40af;
            color: white;
        }

        .send-btn:hover {
            background: #1e3a8a;
        }

        .edit-btn {
            background: #f59e0b;
            color: white;
        }

        .edit-btn:hover {
            background: #d97706;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 32px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.15);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 {
            color: #1f2937;
            margin-bottom: 24px;
            font-size: 1.5rem;
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #1e40af;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .expense-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .expense-section h4 {
            font-size: 1rem;
            color: #1f2937;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .photo-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 6px;
            padding: 32px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #f9fafb;
        }

        .photo-upload-area:hover {
            border-color: #1e40af;
            background: #f3f4f6;
        }

        .photo-upload-area.has-file {
            border-color: #10b981;
            background: #d1fae5;
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            display: block;
        }

        .upload-text {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #1e40af;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3a8a;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.7;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 12px;
            color: #374151;
        }

        .empty-state p {
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Route Stops Section */
        .route-section {
            background: #f0f4ff;
            border: 1px solid #c7d2fe;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .route-header h3 {
            color: #1e40af;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .quick-add-bar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .quick-add-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-add-btn.errand {
            background: #fed7aa;
            color: #9a3412;
        }

        .quick-add-btn.errand:hover {
            background: #fdba74;
        }

        .quick-add-btn.pickup {
            background: #bbf7d0;
            color: #166534;
        }

        .quick-add-btn.pickup:hover {
            background: #86efac;
        }

        /* Route Cards */
        .route-cards-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .route-card {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            min-height: 72px;
            transition: box-shadow 0.2s ease, opacity 0.2s ease;
            overflow: hidden;
            position: relative;
        }

        .route-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .route-card.dragging {
            opacity: 0.6;
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }

        .route-card.completed {
            opacity: 0.5;
            background: #f9fafb;
        }

        .route-card.completed .route-card-title,
        .route-card.completed .route-card-address {
            text-decoration: line-through;
        }

        .route-card-color-bar {
            width: 6px;
            align-self: stretch;
            flex-shrink: 0;
        }

        .type-delivery .route-card-color-bar { background: #1e40af; }
        .type-errand .route-card-color-bar { background: #ea580c; }
        .type-pickup .route-card-color-bar { background: #16a34a; }
        .type-restock .route-card-color-bar { background: #7c3aed; }

        .route-card-grab {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            flex-shrink: 0;
            cursor: grab;
            color: #9ca3af;
            font-size: 1.2rem;
            align-self: stretch;
            touch-action: none;
        }

        .route-card-grab:active {
            cursor: grabbing;
        }

        .route-card-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            margin-right: 12px;
        }

        .type-delivery .route-card-number { background: #1e40af; }
        .type-errand .route-card-number { background: #ea580c; }
        .type-pickup .route-card-number { background: #16a34a; }
        .type-restock .route-card-number { background: #7c3aed; }

        .route-card-body {
            flex: 1;
            padding: 10px 0;
            min-width: 0;
        }

        .route-card-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .route-card-address {
            font-size: 0.8rem;
            color: #6b7280;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        .route-card-time {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 2px;
        }

        .route-card-check {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            flex-shrink: 0;
            align-self: stretch;
            cursor: pointer;
        }

        .route-card-check input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #16a34a;
        }

        .route-card-delete {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            flex-shrink: 0;
            align-self: stretch;
            cursor: pointer;
            color: #d1d5db;
            font-size: 1rem;
            transition: color 0.2s;
        }

        .route-card-delete:hover {
            color: #ef4444;
        }

        .drag-placeholder {
            border: 2px dashed #93c5fd;
            border-radius: 8px;
            min-height: 72px;
            background: #eff6ff;
            margin: 4px 0;
        }

        /* Status Pipeline */
        .status-pipeline {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 4px;
            -webkit-overflow-scrolling: touch;
        }

        .status-pill {
            padding: 8px 16px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .status-pill:hover {
            background: #e5e7eb;
        }

        .status-pill.active {
            background: #1e40af;
            color: white;
            border-color: #1e40af;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.sourced { background: #dbeafe; color: #1e40af; }
        .status-badge.fixing { background: #fef3c7; color: #92400e; }
        .status-badge.listed { background: #d1fae5; color: #065f46; }
        .status-badge.pending { background: #fce7f3; color: #9d174d; }

        .category-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            background: #f3f4f6;
            color: #6b7280;
        }

        /* Quick-Add Modal (minimal) */
        .quick-modal .modal-content {
            max-width: 400px;
        }

        /* Inventory button row */
        .inventory-actions-row {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .inventory-actions-row .action-button {
            margin-bottom: 0;
        }

        .quick-add-inventory-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 14px 24px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .quick-add-inventory-btn:hover {
            background: #059669;
        }

        /* Delivery Section (legacy compat) */
        .delivery-section {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .delivery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .delivery-header h3 {
            color: #991b1b;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .delivery-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .delivery-info {
            color: #4b5563;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .complete-delivery-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }

        .complete-delivery-btn:hover {
            background: #059669;
        }

        /* History Section */
        .history-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .filter-btn.active {
            background: #1e40af;
            color: white;
            border-color: #1e40af;
        }

        .history-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .history-item-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 1rem;
        }

        .history-item-date {
            color: #6b7280;
            font-size: 0.8rem;
        }

        .profit-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .profit-badge.positive {
            background: #d1fae5;
            color: #065f46;
        }

        .profit-badge.negative {
            background: #fee2e2;
            color: #991b1b;
        }

        .hidden {
            display: none;
        }

        /* ========== AIRBNB SUB-TABS ========== */
        .airbnb-subtabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 4px;
            -webkit-overflow-scrolling: touch;
        }

        .airbnb-subtab {
            padding: 8px 16px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .airbnb-subtab:hover {
            background: #e5e7eb;
        }

        .airbnb-subtab.active {
            background: #1e40af;
            color: white;
            border-color: #1e40af;
        }

        /* ========== LOW-STOCK BANNER ========== */
        .low-stock-banner {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-left: 4px solid #ef4444;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #991b1b;
        }

        .low-stock-banner .banner-icon {
            font-size: 1.25rem;
        }

        /* ========== SUPPLY CARDS ========== */
        .supply-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .supply-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            transition: all 0.2s ease;
        }

        .supply-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-color: #1e40af;
        }

        .supply-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .supply-card-name {
            font-weight: 600;
            font-size: 1rem;
            color: #1f2937;
        }

        .supply-card-category {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            background: #f3f4f6;
            color: #6b7280;
        }

        .supply-qty-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .supply-qty-display {
            font-size: 1.5rem;
            font-weight: 700;
            min-width: 40px;
            text-align: center;
        }

        .supply-qty-display.ok { color: #059669; }
        .supply-qty-display.low { color: #d97706; }
        .supply-qty-display.critical { color: #dc2626; }

        .supply-par {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .qty-btn {
            width: 36px;
            height: 36px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: #f9fafb;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .qty-btn:hover {
            background: #e5e7eb;
            border-color: #1e40af;
        }

        .supply-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .supply-card-actions button {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* ========== CLEANING CHECKLIST ========== */
        .template-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .template-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .template-card:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            border-color: #1e40af;
        }

        .template-card-info h4 {
            font-size: 1rem;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .template-card-info p {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .template-card-actions {
            display: flex;
            gap: 8px;
        }

        .checklist-room-header {
            font-size: 1rem;
            font-weight: 700;
            color: #1e40af;
            margin-top: 16px;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #e5e7eb;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .checklist-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #1e40af;
            cursor: pointer;
            flex-shrink: 0;
        }

        .checklist-item.checked label {
            text-decoration: line-through;
            color: #9ca3af;
        }

        .checklist-item label {
            flex: 1;
            font-size: 0.95rem;
            cursor: pointer;
        }

        .checklist-item-note {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 30px;
            margin-top: 4px;
        }

        .cleaning-log-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cleaning-log-item .log-info {
            font-size: 0.9rem;
            color: #1f2937;
        }

        .cleaning-log-item .log-date {
            font-size: 0.8rem;
            color: #6b7280;
        }

        /* ========== MESSAGE TEMPLATES ========== */
        .msg-template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .msg-template-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .msg-template-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-color: #1e40af;
        }

        .msg-template-card h4 {
            font-size: 1rem;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .msg-template-card .msg-category-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            background: #dbeafe;
            color: #1e40af;
            margin-bottom: 8px;
        }

        .msg-template-card .msg-preview {
            font-size: 0.85rem;
            color: #6b7280;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .msg-template-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .msg-template-card-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
        }

        .placeholder-field {
            margin-bottom: 12px;
        }

        .placeholder-field label {
            display: block;
            font-weight: 600;
            font-size: 0.85rem;
            color: #374151;
            margin-bottom: 4px;
        }

        .placeholder-field input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .msg-preview-box {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            white-space: pre-wrap;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #1f2937;
            max-height: 300px;
            overflow-y: auto;
        }

        /* ========== EXPORT BTN ========== */
        .export-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .export-btn:hover {
            background: #059669;
        }

        /* ========== AGING / DEATH PILE BADGES ========== */
        .aging-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 6px;
        }
        .aging-badge.green { background: #d1fae5; color: #065f46; }
        .aging-badge.yellow { background: #fef3c7; color: #92400e; }
        .aging-badge.red { background: #fee2e2; color: #991b1b; }

        /* ========== SOURCING TRIPS ========== */
        .trip-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .trip-card .trip-info { flex: 1; }
        .trip-card .trip-route { font-weight: 600; color: #1f2937; }
        .trip-card .trip-details { font-size: 0.8rem; color: #6b7280; }
        .trip-card .trip-miles { font-weight: 700; color: #1e40af; font-size: 1.1rem; white-space: nowrap; margin-left: 12px; }

        /* ========== LISTINGS / CROSS-LIST TRACKER ========== */
        .listing-badges { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
        .listing-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            background: #dbeafe;
            color: #1e40af;
        }
        .listing-badge.sold { background: #d1fae5; color: #065f46; }
        .listing-badge.delisted { background: #f3f4f6; color: #6b7280; text-decoration: line-through; }

        /* ========== MAINTENANCE LOG ========== */
        .maint-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 8px;
        }
        .maint-card .maint-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .maint-card .maint-issue { font-weight: 600; color: #1f2937; }
        .maint-card .maint-meta { font-size: 0.8rem; color: #6b7280; }
        .maint-status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
        }
        .maint-status-badge.reported { background: #fee2e2; color: #991b1b; }
        .maint-status-badge.in-progress { background: #fef3c7; color: #92400e; }
        .maint-status-badge.fixed { background: #d1fae5; color: #065f46; }
        .maint-status-badge.awaiting-parts { background: #dbeafe; color: #1e40af; }
        .maint-photo { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; cursor: pointer; }

        /* ========== GUEST GUIDEBOOK ========== */
        .guidebook-section {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .guidebook-section h4 { font-size: 1rem; color: #1e40af; margin-bottom: 8px; cursor: move; }
        .guidebook-section .guidebook-content {
            white-space: pre-wrap;
            font-size: 0.9rem;
            color: #374151;
            line-height: 1.6;
        }
        .guidebook-edit-area {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: inherit;
            resize: vertical;
        }

        /* ========== MULTI-PHOTO GALLERY ========== */
        .photo-gallery-container { position: relative; }
        .photo-gallery-main {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }
        .photo-gallery-count {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .photo-gallery-thumbs {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            overflow-x: auto;
        }
        .photo-gallery-thumb {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            flex-shrink: 0;
        }
        .photo-gallery-thumb.active { border-color: #1e40af; }
        .gallery-modal-img {
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
            border-radius: 6px;
        }
        .gallery-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-top: 12px;
        }
        .gallery-nav button {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* ========== CLEANING PHOTO VERIFICATION ========== */
        .room-photo-btn {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 8px;
        }
        .room-photo-btn.has-photo { background: #d1fae5; color: #065f46; border-color: #10b981; }
        .room-photo-thumb {
            width: 60px;
            height: 45px;
            object-fit: cover;
            border-radius: 4px;
            margin-top: 4px;
            cursor: pointer;
        }

        /* ========== FINANCE SECTION BLOCK (reused) ========== */
        .finance-section-block {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .finance-section-block h3 {
            font-size: 1.125rem;
            color: #1f2937;
            margin-bottom: 16px;
            font-weight: 600;
            border-bottom: none;
            padding-bottom: 0;
        }

        .checklist-template-items-editor {
            max-height: 400px;
            overflow-y: auto;
        }

        .checklist-template-item-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 6px;
        }

        .checklist-template-item-row input[type="text"] {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .checklist-template-item-row select {
            width: 120px;
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .checklist-template-item-row .remove-item-btn {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header, .main-content {
                padding: 16px;
            }

            .inventory-grid {
                grid-template-columns: 1fr;
            }

            .main-tabs {
                grid-template-columns: 1fr 1fr;
            }

            .modal-content {
                padding: 24px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .inventory-actions-row {
                flex-direction: column;
            }

            .route-card-title {
                font-size: 0.9rem;
            }

            .supply-grid {
                grid-template-columns: 1fr;
            }

            .msg-template-grid {
                grid-template-columns: 1fr;
            }

            .checklist-template-item-row select {
                width: 90px;
            }

            .airbnb-subtabs {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 6px !important;
            }
            .airbnb-subtab {
                flex: 1 1 calc(33% - 6px) !important;
                font-size: 0.75rem !important;
                padding: 8px 4px !important;
            }

            .trip-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .trip-card .trip-miles { margin-left: 0; }
        }

        /* Financial Dashboard */
        .finance-dashboard { display: flex; flex-direction: column; gap: 24px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; }
        .kpi-card {
            background: white; border-radius: 8px; padding: 20px; text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-top: 3px solid #1e40af;
        }
        .kpi-card.green { border-top-color: #059669; }
        .kpi-card.red { border-top-color: #dc2626; }
        .kpi-card.purple { border-top-color: #7c3aed; }
        .kpi-label { font-size: 0.8rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .kpi-value { font-size: 1.5rem; font-weight: 700; color: #1f2937; }
        .kpi-value.positive { color: #059669; }
        .kpi-value.negative { color: #dc2626; }

        .finance-section {
            background: white; border-radius: 8px; padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .finance-section h3 { font-size: 1rem; font-weight: 700; margin-bottom: 16px; color: #1f2937; }

        .bar-chart { display: flex; align-items: flex-end; gap: 8px; height: 180px; padding-top: 8px; overflow-x: auto; }
        .bar-group { display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 60px; height: 100%; justify-content: flex-end; }
        .bar-stack { display: flex; gap: 3px; align-items: flex-end; width: 100%; justify-content: center; }
        .bar {
            width: 20px; border-radius: 3px 3px 0 0; min-height: 2px;
            transition: height 0.3s ease; position: relative;
        }
        .bar.revenue { background: #3b82f6; }
        .bar.cost { background: #ef4444; }
        .bar.profit { background: #10b981; }
        .bar.category { background: #6366f1; }
        .bar.mileage { background: #f59e0b; }
        .bar-label { font-size: 0.65rem; color: #6b7280; margin-top: 4px; text-align: center; white-space: nowrap; }
        .bar-value { font-size: 0.6rem; color: #6b7280; margin-bottom: 2px; text-align: center; }

        .chart-legend { display: flex; gap: 16px; margin-bottom: 12px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 4px; font-size: 0.75rem; color: #6b7280; }
        .legend-dot { width: 10px; height: 10px; border-radius: 2px; }

        .flip-tables { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .flip-table h4 { font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; }
        .flip-table h4.best { color: #059669; }
        .flip-table h4.worst { color: #dc2626; }
        .flip-table table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .flip-table th { text-align: left; padding: 6px 8px; border-bottom: 2px solid #e5e7eb; color: #6b7280; font-weight: 600; }
        .flip-table td { padding: 6px 8px; border-bottom: 1px solid #f3f4f6; }

        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { color: #6b7280; font-size: 0.85rem; }
        .stat-value { font-weight: 600; font-size: 0.85rem; }

        .insight-cards { display: flex; flex-direction: column; gap: 10px; }
        .insight-card {
            background: #f0fdf4; border-left: 3px solid #10b981; padding: 12px 16px;
            border-radius: 0 6px 6px 0; font-size: 0.85rem; color: #1f2937;
        }
        .insight-card.warn { background: #fef3c7; border-left-color: #f59e0b; }
        .insight-card.info { background: #eff6ff; border-left-color: #3b82f6; }

        @media (max-width: 600px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .flip-tables { grid-template-columns: 1fr; }
            .bar-chart { height: 140px; }
            .kpi-value { font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display:flex;justify-content:space-between;align-items:flex-start">
                <div>
                    <h1>üè¢ Cozy Capital</h1>
                    <div class="subtitle">Professional Inventory & Delivery Management</div>
                </div>
                <button onclick="showNtfySettings()" style="background:none;border:none;font-size:1.4rem;cursor:pointer;padding:4px 8px;opacity:0.6" title="Notification Settings">‚öôÔ∏è</button>
            </div>
            <div class="main-tabs">
                <button class="main-tab active" onclick="switchTab('furniture')">
                    üì¶ Inventory
                </button>
                <button class="main-tab" onclick="switchTab('airbnb')">
                    üè† Airbnb
                </button>
                <button class="main-tab" onclick="switchTab('history')">
                    üìä History
                </button>
                <button class="main-tab" onclick="switchTab('finances')">
                    üí∞ Finances
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Furniture Section -->
            <div id="furniture-section">
                <h2 class="section-title">Current Inventory</h2>

                <!-- Route Stops -->
                <div id="route-section" class="route-section hidden">
                    <div class="route-header">
                        <h3>üó∫Ô∏è Today's Route</h3>
                        <div class="quick-add-bar">
                            <button class="quick-add-btn errand" onclick="showErrandModal()">+ Errand</button>
                            <button class="quick-add-btn pickup" onclick="showPickupModal()">+ Pickup</button>
                        </div>
                    </div>
                    <div id="route-cards-list" class="route-cards-list">
                        <!-- Route cards rendered here -->
                    </div>
                    <div id="route-empty" class="hidden" style="text-align:center; padding: 20px; color: #6b7280; font-size: 0.9rem;">
                        No stops yet. Create a delivery or add an errand/pickup.
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="total-items">0</div>
                        <div class="stat-label">Total Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="total-invested">$0</div>
                        <div class="stat-label">Total Invested</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-value" id="potential-revenue">$0</div>
                        <div class="stat-label">Potential Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-value" id="potential-profit">$0</div>
                        <div class="stat-label">Expected Profit</div>
                    </div>
                </div>

                <!-- Status Pipeline -->
                <div class="status-pipeline">
                    <button class="status-pill active" onclick="filterByStatus('all')">All</button>
                    <button class="status-pill" onclick="filterByStatus('sourced')">Sourced</button>
                    <button class="status-pill" onclick="filterByStatus('fixing')">Fixing Up</button>
                    <button class="status-pill" onclick="filterByStatus('listed')">Listed</button>
                    <button class="status-pill" onclick="filterByStatus('pending')">Pending Sale</button>
                </div>

                <div class="inventory-actions-row">
                    <button class="action-button" onclick="showAddItemModal()" style="flex:1;">
                        ‚ûï Add New Item
                    </button>
                    <button class="quick-add-inventory-btn" onclick="showQuickAddModal()">
                        üì∏ Quick Add
                    </button>
                    <button class="export-btn" onclick="showExportReportModal()" style="padding: 10px 16px;">
                        üì• Export
                    </button>
                </div>

                <div id="furniture-inventory" class="inventory-grid">
                    <!-- Items will appear here -->
                </div>

                <div id="furniture-empty" class="empty-state">
                    <div class="empty-icon">üì¶</div>
                    <h3>No Items in Inventory</h3>
                    <p>Start tracking your inventory by adding your first item with photos, costs, and pricing.</p>
                </div>
            </div>

            <!-- Airbnb Section -->
            <div id="airbnb-section" class="hidden">
                <h2 class="section-title">Airbnb Management</h2>

                <!-- Sub-tabs -->
                <div class="airbnb-subtabs" style="grid-template-columns: repeat(6, 1fr);">
                    <button class="airbnb-subtab active" onclick="switchAirbnbSubtab('supplies', this)">üß¥ Supplies</button>
                    <button class="airbnb-subtab" onclick="switchAirbnbSubtab('cleaning', this)">üßπ Cleaning</button>
                    <button class="airbnb-subtab" onclick="switchAirbnbSubtab('messages', this)">üí¨ Messages</button>
                    <button class="airbnb-subtab" onclick="switchAirbnbSubtab('maintenance', this)">üîß Maintenance</button>
                    <button class="airbnb-subtab" onclick="switchAirbnbSubtab('guidebook', this)">üìñ Guide</button>
                    <button class="airbnb-subtab" onclick="switchAirbnbSubtab('trips', this)">üöó Trips</button>
                </div>

                <!-- === SUPPLIES SUB-TAB === -->
                <div id="airbnb-supplies-sub" class="airbnb-sub-content">
                    <div id="low-stock-banner" class="low-stock-banner hidden">
                        <span class="banner-icon">‚ö†Ô∏è</span>
                        <span id="low-stock-text">0 items below par level</span>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üì¶</div>
                            <div class="stat-value" id="supply-total-items">0</div>
                            <div class="stat-label">Total Items</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">‚ö†Ô∏è</div>
                            <div class="stat-value" id="supply-below-par">0</div>
                            <div class="stat-label">Below Par</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìÇ</div>
                            <div class="stat-value" id="supply-categories">0</div>
                            <div class="stat-label">Categories</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="action-button" onclick="showAddSupplyModal()" style="flex:1; margin-bottom:0;">‚ûï Add Supply</button>
                        <button class="action-button" onclick="generateShoppingList()" style="flex:1; margin-bottom:0; background: #10b981;">üõí Shopping List</button>
                    </div>

                    <div class="status-pipeline" id="supply-category-filter">
                        <button class="status-pill active" onclick="filterSupplyCategory('all', this)">All</button>
                        <button class="status-pill" onclick="filterSupplyCategory('bathroom', this)">Bathroom</button>
                        <button class="status-pill" onclick="filterSupplyCategory('kitchen', this)">Kitchen</button>
                        <button class="status-pill" onclick="filterSupplyCategory('cleaning', this)">Cleaning</button>
                        <button class="status-pill" onclick="filterSupplyCategory('linens', this)">Linens</button>
                        <button class="status-pill" onclick="filterSupplyCategory('other', this)">Other</button>
                    </div>

                    <div id="supply-grid" class="supply-grid"></div>
                    <div id="supply-empty" class="empty-state">
                        <div class="empty-icon">üß¥</div>
                        <h3>No Supplies Tracked</h3>
                        <p>Add your first supply item to start tracking inventory and get low-stock alerts.</p>
                    </div>
                </div>

                <!-- === CLEANING SUB-TAB === -->
                <div id="airbnb-cleaning-sub" class="airbnb-sub-content hidden">
                    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="action-button" onclick="showCreateCleaningTemplateModal()" style="flex:1; margin-bottom:0;">‚ûï Create Template</button>
                    </div>

                    <h3 style="font-size: 1.1rem; margin-bottom: 12px; color: #1f2937;">Cleaning Templates</h3>
                    <div id="cleaning-templates-list" class="template-list"></div>
                    <div id="cleaning-templates-empty" class="empty-state">
                        <div class="empty-icon">üßπ</div>
                        <h3>No Cleaning Templates</h3>
                        <p>A default template will be created automatically.</p>
                    </div>

                    <div id="active-checklist-area" class="hidden" style="margin-top: 24px;">
                        <h3 style="font-size: 1.1rem; margin-bottom: 12px; color: #1e40af;">Active Checklist</h3>
                        <div id="active-checklist-content"></div>
                        <div style="margin-top: 16px; display: flex; gap: 12px;">
                            <button class="btn btn-primary" onclick="completeActiveChecklist()">‚úÖ Complete Checklist</button>
                            <button class="btn btn-secondary" onclick="cancelActiveChecklist()">Cancel</button>
                        </div>
                    </div>

                    <div id="cleaning-log-area" style="margin-top: 24px;">
                        <h3 style="font-size: 1.1rem; margin-bottom: 12px; color: #1f2937;">Recent Cleaning Log</h3>
                        <div id="cleaning-log-list"></div>
                    </div>
                </div>

                <!-- === MESSAGES SUB-TAB === -->
                <div id="airbnb-messages-sub" class="airbnb-sub-content hidden">
                    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="action-button" onclick="showAddMessageTemplateModal()" style="flex:1; margin-bottom:0;">‚ûï Add Template</button>
                    </div>

                    <div class="status-pipeline" id="msg-category-filter">
                        <button class="status-pill active" onclick="filterMsgCategory('all', this)">All</button>
                        <button class="status-pill" onclick="filterMsgCategory('checkin', this)">Check-in</button>
                        <button class="status-pill" onclick="filterMsgCategory('checkout', this)">Checkout</button>
                        <button class="status-pill" onclick="filterMsgCategory('welcome', this)">Welcome</button>
                        <button class="status-pill" onclick="filterMsgCategory('review', this)">Review</button>
                        <button class="status-pill" onclick="filterMsgCategory('problem', this)">Problem</button>
                        <button class="status-pill" onclick="filterMsgCategory('other', this)">Other</button>
                    </div>

                    <div id="msg-template-grid" class="msg-template-grid"></div>
                    <div id="msg-templates-empty" class="empty-state">
                        <div class="empty-icon">üí¨</div>
                        <h3>No Message Templates</h3>
                        <p>Starter templates will be created automatically.</p>
                    </div>
                </div>

                <!-- === MAINTENANCE SUB-TAB === -->
                <div id="airbnb-maintenance-sub" class="airbnb-sub-content hidden">
                    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="action-button" onclick="showAddMaintenanceModal()" style="flex:1; margin-bottom:0;">‚ûï Report Issue</button>
                    </div>

                    <div class="status-pipeline" id="maint-status-filter">
                        <button class="status-pill active" onclick="filterMaintenanceStatus('all', this)">All</button>
                        <button class="status-pill" onclick="filterMaintenanceStatus('reported', this)">Reported</button>
                        <button class="status-pill" onclick="filterMaintenanceStatus('in-progress', this)">In Progress</button>
                        <button class="status-pill" onclick="filterMaintenanceStatus('awaiting-parts', this)">Awaiting Parts</button>
                        <button class="status-pill" onclick="filterMaintenanceStatus('fixed', this)">Fixed</button>
                    </div>

                    <div id="maintenance-list"></div>
                    <div id="maintenance-empty" class="empty-state">
                        <div class="empty-icon">üîß</div>
                        <h3>No Maintenance Issues</h3>
                        <p>Report property maintenance issues to track repairs and costs.</p>
                    </div>
                </div>

                <!-- === GUEST GUIDEBOOK SUB-TAB === -->
                <div id="airbnb-guidebook-sub" class="airbnb-sub-content hidden">
                    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                        <button class="action-button" onclick="addGuidebookSection()" style="flex:1; margin-bottom:0;">‚ûï Add Section</button>
                        <button class="action-button" onclick="toggleGuidebookEdit()" id="guidebook-edit-toggle" style="flex:1; margin-bottom:0; background: #6b7280;">‚úèÔ∏è Edit Mode</button>
                        <button class="export-btn" onclick="exportGuidebook()" style="margin-bottom:0;">üì• Print / Export</button>
                    </div>

                    <div class="form-group" style="margin-bottom: 16px;">
                        <label for="guidebook-property-name" style="font-weight: 600;">Property Name</label>
                        <input type="text" id="guidebook-property-name" placeholder="e.g., Cozy Downtown Loft" oninput="saveGuidebook()">
                    </div>

                    <div id="guidebook-sections"></div>
                    <div id="guidebook-empty" class="empty-state">
                        <div class="empty-icon">üìñ</div>
                        <h3>No Guidebook Sections</h3>
                        <p>Create a digital house manual for your guests with WiFi info, house rules, and more.</p>
                    </div>
                </div>

                <!-- === SOURCING TRIPS SUB-TAB === -->
                <div id="airbnb-trips-sub" class="airbnb-sub-content hidden">
                    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="action-button" onclick="showAddTripModal()" style="flex:1; margin-bottom:0;">‚ûï Log Trip</button>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üöó</div>
                            <div class="stat-value" id="total-trips">0</div>
                            <div class="stat-label">Total Trips</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìè</div>
                            <div class="stat-value" id="total-miles">0</div>
                            <div class="stat-label">Total Miles</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-value" id="total-mileage-deduction">$0</div>
                            <div class="stat-label">Tax Deduction</div>
                        </div>
                    </div>

                    <div style="text-align: right; margin-bottom: 12px;">
                        <button class="export-btn" onclick="exportTripsCSV()">üì• Export Trips CSV</button>
                    </div>

                    <div id="trips-list"></div>
                    <div id="trips-empty" class="empty-state">
                        <div class="empty-icon">üöó</div>
                        <h3>No Sourcing Trips Logged</h3>
                        <p>Track your mileage for sourcing trips to maximize tax deductions.</p>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div id="history-section" class="hidden">
                <h2 class="section-title">Sales History</h2>

                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="total-sold">0</div>
                        <div class="stat-label">Items Sold</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üíµ</div>
                        <div class="stat-value" id="total-revenue">$0</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìâ</div>
                        <div class="stat-value" id="total-costs">$0</div>
                        <div class="stat-label">Total Costs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="actual-profit">$0</div>
                        <div class="stat-label">Actual Profit</div>
                    </div>
                </div>

                <div id="history-list">
                    <!-- History items will appear here -->
                </div>

                <div id="history-empty" class="empty-state">
                    <div class="empty-icon">üìã</div>
                    <h3>No Sales History Yet</h3>
                    <p>Complete deliveries to see your sales history and profit tracking here.</p>
                </div>
            </div>

            <!-- Finances Section -->
            <div id="finances-section" class="hidden">
                <h2 class="section-title">Financial Dashboard</h2>
                <div id="finance-dashboard-container"></div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="add-item-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Add New Item</h3>
            <form id="add-item-form">
                <div class="form-group">
                    <label for="item-title">Item Name *</label>
                    <input type="text" id="item-title" required placeholder="e.g., Vintage Oak Dining Table">
                </div>

                <div class="form-group">
                    <label for="item-description">Description</label>
                    <textarea id="item-description" rows="3" placeholder="Size, condition, style, features..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="item-purchase-price">Purchase Price *</label>
                        <input type="number" id="item-purchase-price" step="0.01" required placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label for="item-sale-price">Sale Price</label>
                        <input type="number" id="item-sale-price" step="0.01" placeholder="0.00">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="item-status">Status</label>
                        <select id="item-status">
                            <option value="sourced">Sourced</option>
                            <option value="fixing">Fixing Up</option>
                            <option value="listed">Listed</option>
                            <option value="pending">Pending Sale</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="item-category">Category</label>
                        <select id="item-category">
                            <option value="other">Other</option>
                            <option value="couch">Couch/Sofa</option>
                            <option value="table">Table</option>
                            <option value="chair">Chair</option>
                            <option value="dresser">Dresser/Cabinet</option>
                            <option value="bed">Bed/Frame</option>
                            <option value="desk">Desk</option>
                            <option value="shelf">Shelf/Bookcase</option>
                            <option value="decor">Decor</option>
                        </select>
                    </div>
                </div>

                <div class="expense-section">
                    <h4>üí∏ Additional Costs</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="travel-cost">Travel/Pickup Cost</label>
                            <input type="number" id="travel-cost" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="materials-cost">Materials Cost</label>
                            <input type="number" id="materials-cost" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="repair-cost">Repair/Labor Cost</label>
                        <input type="number" id="repair-cost" step="0.01" placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label>Photos (up to 5)</label>
                    <div class="photo-upload-area" onclick="document.getElementById('item-photo').click()">
                        <span class="upload-icon">üì∏</span>
                        <span class="upload-text">Click to add photos</span>
                        <input type="file" id="item-photo" accept="image/*" multiple style="display: none;">
                    </div>
                    <div id="item-photo-previews" class="photo-gallery-thumbs" style="margin-top: 8px;"></div>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideAddItemModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Add Item Modal (photo-first, minimal fields) -->
    <div id="quick-add-modal" class="modal hidden quick-modal">
        <div class="modal-content">
            <h3>üì∏ Quick Add Item</h3>
            <form id="quick-add-form">
                <div class="form-group">
                    <label>Take a Photo</label>
                    <div class="photo-upload-area" onclick="document.getElementById('quick-photo').click()">
                        <span class="upload-icon">üì∑</span>
                        <span class="upload-text" id="quick-photo-text">Tap to open camera</span>
                        <input type="file" id="quick-photo" accept="image/*" capture="environment" style="display: none;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="quick-title">Title *</label>
                    <input type="text" id="quick-title" required placeholder="e.g., Blue Dresser">
                </div>

                <div class="form-group">
                    <label for="quick-price">Purchase Price *</label>
                    <input type="number" id="quick-price" step="0.01" required placeholder="0.00">
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideQuickAddModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Errand Quick-Add Modal -->
    <div id="errand-modal" class="modal hidden quick-modal">
        <div class="modal-content">
            <h3>üõí Add Errand</h3>
            <form id="errand-form">
                <div class="form-group">
                    <label for="errand-store">Store Name *</label>
                    <input type="text" id="errand-store" required placeholder="e.g., Walmart, Home Depot">
                </div>

                <div class="form-group">
                    <label for="errand-address">Address (optional)</label>
                    <input type="text" id="errand-address" placeholder="123 Main St">
                </div>

                <div class="form-group">
                    <label for="errand-list">Shopping List</label>
                    <textarea id="errand-list" rows="3" placeholder="Towels, soap, screws..."></textarea>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideErrandModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="background: #ea580c;">Add Errand</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Pickup Quick-Add Modal -->
    <div id="pickup-modal" class="modal hidden quick-modal">
        <div class="modal-content">
            <h3>üöö Add Pickup</h3>
            <form id="pickup-form">
                <div class="form-group">
                    <label for="pickup-item">Item Name *</label>
                    <input type="text" id="pickup-item" required placeholder="e.g., Free dresser from Craigslist">
                </div>

                <div class="form-group">
                    <label for="pickup-address">Pickup Address *</label>
                    <input type="text" id="pickup-address" required placeholder="456 Oak Ave">
                </div>

                <div class="form-group">
                    <label for="pickup-notes">Notes</label>
                    <textarea id="pickup-notes" rows="2" placeholder="Call when close, gate code, etc."></textarea>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hidePickupModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="background: #16a34a;">Add Pickup</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Send for Delivery Modal -->
    <div id="delivery-modal" class="modal hidden">
        <div class="modal-content">
            <h3>üì¶ Create Delivery</h3>
            <form id="delivery-form">
                <div class="form-group">
                    <label for="customer-name">Customer Name *</label>
                    <input type="text" id="customer-name" required placeholder="Customer name">
                </div>

                <div class="form-group">
                    <label for="delivery-address">Delivery Address *</label>
                    <textarea id="delivery-address" rows="2" required placeholder="Full address"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="delivery-date">Delivery Date *</label>
                        <input type="date" id="delivery-date" required>
                    </div>
                    <div class="form-group">
                        <label for="delivery-time">Time *</label>
                        <input type="time" id="delivery-time" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="final-price">Final Sale Price *</label>
                    <input type="number" id="final-price" step="0.01" required placeholder="0.00">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="payment-method">Payment Method *</label>
                        <select id="payment-method" required>
                            <option value="">Select method</option>
                            <option value="cash">üíµ Cash</option>
                            <option value="venmo">üì± Venmo</option>
                            <option value="cashapp">üí∞ Cash App</option>
                            <option value="zelle">üè¶ Zelle</option>
                            <option value="check">üìù Check</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="payment-status">Payment Status *</label>
                        <select id="payment-status" required>
                            <option value="pending">‚è≥ Pending</option>
                            <option value="paid">‚úÖ Paid</option>
                        </select>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideDeliveryModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Delivery</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Complete Delivery Modal -->
    <div id="complete-delivery-modal" class="modal hidden">
        <div class="modal-content">
            <h3>‚úÖ Complete Delivery</h3>
            <form id="complete-delivery-form">
                <div id="delivery-summary" style="background: #f9fafb; padding: 16px; border-radius: 6px; margin-bottom: 20px;">
                    <!-- Delivery info will be inserted here -->
                </div>

                <div class="form-group">
                    <label for="delivery-mileage">Delivery Mileage (miles) *</label>
                    <input type="number" id="delivery-mileage" step="0.1" required placeholder="0.0">
                    <small style="color: #6b7280; display: block; margin-top: 6px;">
                        Mileage cost: $<span id="mileage-cost">0.00</span> (at $0.67/mile)
                    </small>
                </div>

                <div class="form-group">
                    <label for="delivery-notes">Delivery Notes</label>
                    <textarea id="delivery-notes" rows="3" placeholder="Any notes about the delivery..."></textarea>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideCompleteDeliveryModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Complete Delivery</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Supply Modal -->
    <div id="add-supply-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="supply-modal-title">Add Supply</h3>
            <form id="add-supply-form">
                <div class="form-group">
                    <label for="supply-name">Item Name *</label>
                    <input type="text" id="supply-name" required placeholder="e.g., Bath Towels">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="supply-category">Category</label>
                        <select id="supply-category">
                            <option value="bathroom">Bathroom</option>
                            <option value="kitchen">Kitchen</option>
                            <option value="cleaning">Cleaning</option>
                            <option value="linens">Linens</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="supply-unit">Unit</label>
                        <input type="text" id="supply-unit" placeholder="e.g., rolls, bottles">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="supply-qty">Current Qty *</label>
                        <input type="number" id="supply-qty" required min="0" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="supply-par">Par Level *</label>
                        <input type="number" id="supply-par" required min="1" placeholder="5">
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideAddSupplyModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="supply-submit-btn">Add Supply</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Shopping List Modal -->
    <div id="shopping-list-modal" class="modal hidden">
        <div class="modal-content">
            <h3>üõí Shopping List</h3>
            <div id="shopping-list-content"></div>
            <div class="modal-buttons" style="margin-top: 16px;">
                <button type="button" class="btn btn-secondary" onclick="hideShoppingListModal()">Close</button>
                <button type="button" class="btn btn-primary" onclick="copyShoppingList()">üìã Copy List</button>
            </div>
            <div style="margin-top: 8px; text-align: center;">
                <button type="button" class="btn btn-primary" onclick="addShoppingListToRoute()" style="background: #ea580c; width: 100%;">üó∫Ô∏è Add to Route</button>
            </div>
        </div>
    </div>

    <!-- Create Cleaning Template Modal -->
    <div id="cleaning-template-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="cleaning-template-modal-title">Create Cleaning Template</h3>
            <form id="cleaning-template-form">
                <div class="form-group">
                    <label for="ct-name">Template Name *</label>
                    <input type="text" id="ct-name" required placeholder="e.g., Standard Turnover">
                </div>
                <div class="form-group">
                    <label>Checklist Items</label>
                    <div id="ct-items-editor" class="checklist-template-items-editor"></div>
                    <button type="button" class="btn btn-secondary" onclick="addCleaningTemplateItem()" style="margin-top: 8px; width: 100%;">+ Add Item</button>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideCleaningTemplateModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Template</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Message Template Modal -->
    <div id="msg-template-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="msg-template-modal-title">Add Message Template</h3>
            <form id="msg-template-form">
                <div class="form-group">
                    <label for="mt-name">Template Name *</label>
                    <input type="text" id="mt-name" required placeholder="e.g., Check-in Instructions">
                </div>
                <div class="form-group">
                    <label for="mt-category">Category</label>
                    <select id="mt-category">
                        <option value="checkin">Check-in</option>
                        <option value="checkout">Checkout</option>
                        <option value="welcome">Welcome</option>
                        <option value="review">Review</option>
                        <option value="problem">Problem</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="mt-body">Message Body *</label>
                    <textarea id="mt-body" rows="8" required placeholder="Use [PLACEHOLDER] for dynamic values, e.g. [GUEST_NAME], [WIFI_PASSWORD]"></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideMessageTemplateModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="mt-submit-btn">Add Template</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Use Message Template Modal -->
    <div id="use-msg-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="use-msg-title">Use Template</h3>
            <div id="use-msg-placeholders"></div>
            <div class="form-group" style="margin-top: 16px;">
                <label>Preview</label>
                <div id="use-msg-preview" class="msg-preview-box"></div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="hideUseMsgModal()">Close</button>
                <button type="button" class="btn btn-primary" onclick="copyMessageToClipboard()">üìã Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <!-- Add Maintenance Issue Modal -->
    <div id="add-maintenance-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="maint-modal-title">Report Maintenance Issue</h3>
            <form id="add-maintenance-form">
                <div class="form-group">
                    <label for="maint-issue">Issue *</label>
                    <input type="text" id="maint-issue" required placeholder="e.g., Broken sink faucet">
                </div>
                <div class="form-group">
                    <label for="maint-description">Description</label>
                    <textarea id="maint-description" rows="3" placeholder="Details about the issue..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="maint-status-select">Status</label>
                        <select id="maint-status-select">
                            <option value="reported">Reported</option>
                            <option value="in-progress">In Progress</option>
                            <option value="awaiting-parts">Awaiting Parts</option>
                            <option value="fixed">Fixed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="maint-cost">Cost ($)</label>
                        <input type="number" id="maint-cost" step="0.01" placeholder="0.00">
                    </div>
                </div>
                <div class="form-group">
                    <label for="maint-vendor">Vendor / Contractor</label>
                    <input type="text" id="maint-vendor" placeholder="e.g., Joe's Plumbing">
                </div>
                <div class="form-group">
                    <label>Photo</label>
                    <div class="photo-upload-area" onclick="document.getElementById('maint-photo-input').click()">
                        <span class="upload-icon">üì∏</span>
                        <span class="upload-text" id="maint-photo-text">Click to add photo</span>
                        <input type="file" id="maint-photo-input" accept="image/*" style="display: none;">
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideMaintenanceModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="maint-submit-btn">Report Issue</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Sourcing Trip Modal -->
    <div id="add-trip-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="trip-modal-title">Log Sourcing Trip</h3>
            <form id="add-trip-form">
                <div class="form-group">
                    <label for="trip-date">Date *</label>
                    <input type="date" id="trip-date" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="trip-from">From *</label>
                        <input type="text" id="trip-from" required placeholder="e.g., Home">
                    </div>
                    <div class="form-group">
                        <label for="trip-to">To *</label>
                        <input type="text" id="trip-to" required placeholder="e.g., Estate Sale on Main St">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="trip-miles">Miles *</label>
                        <input type="number" id="trip-miles" step="0.1" required placeholder="0.0">
                    </div>
                    <div class="form-group">
                        <label for="trip-purpose">Purpose</label>
                        <select id="trip-purpose">
                            <option value="sourcing">Sourcing</option>
                            <option value="pickup">Pickup</option>
                            <option value="delivery">Delivery</option>
                            <option value="supplies">Supplies Run</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="trip-notes">Notes</label>
                    <textarea id="trip-notes" rows="2" placeholder="What you found, stores visited..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideTripModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="trip-submit-btn">Log Trip</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Listing Modal -->
    <div id="add-listing-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Add Listing</h3>
            <form id="add-listing-form">
                <input type="hidden" id="listing-item-id">
                <div class="form-group">
                    <label for="listing-platform">Platform *</label>
                    <select id="listing-platform" required>
                        <option value="Facebook Marketplace">Facebook Marketplace</option>
                        <option value="OfferUp">OfferUp</option>
                        <option value="Craigslist">Craigslist</option>
                        <option value="Nextdoor">Nextdoor</option>
                        <option value="eBay">eBay</option>
                        <option value="Local Only">Local Only</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="listing-price">List Price</label>
                        <input type="number" id="listing-price" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="listing-status">Status</label>
                        <select id="listing-status">
                            <option value="active">Active</option>
                            <option value="sold">Sold</option>
                            <option value="delisted">Delisted</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="listing-url">Listing URL (optional)</label>
                    <input type="url" id="listing-url" placeholder="https://...">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideListingModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Listing</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Photo Gallery Modal -->
    <div id="photo-gallery-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="gallery-modal-title">Photos</h3>
            <div style="text-align: center;">
                <img id="gallery-modal-img" class="gallery-modal-img" src="" alt="">
                <div id="gallery-modal-caption" style="margin-top: 8px; color: #6b7280; font-size: 0.85rem;"></div>
            </div>
            <div class="gallery-nav">
                <button onclick="galleryPrev()">‚Üê</button>
                <span id="gallery-modal-counter">1 / 1</span>
                <button onclick="galleryNext()">‚Üí</button>
            </div>
            <div id="gallery-modal-thumbs" class="photo-gallery-thumbs" style="justify-content: center; margin-top: 12px;"></div>
            <div class="modal-buttons" style="margin-top: 16px;">
                <button type="button" class="btn btn-secondary" onclick="hideGalleryModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Export Report Modal -->
    <div id="export-report-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Export Inventory Report</h3>
            <p style="color: #6b7280; margin-bottom: 16px;">Generate a printable report of your inventory with photos and cost breakdowns.</p>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="hideExportReportModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="generateExportReport()">üì• Generate Report</button>
            </div>
        </div>
    </div>

    <!-- Ntfy Settings Modal -->
    <div id="ntfy-settings-modal" class="modal hidden">
        <div class="modal-content" style="max-width:420px">
            <h3>üîî Push Notifications</h3>
            <p style="color:#6b7280;font-size:0.85rem;margin-bottom:16px">Get notified on your phone when deliveries are completed or routes are created. Both you and your wife should install the <strong>ntfy app</strong> and subscribe to the same topic below.</p>
            <div class="form-group">
                <label for="ntfy-topic-input">ntfy Topic Name</label>
                <input type="text" id="ntfy-topic-input" placeholder="e.g., cozy-capital-smith-2026">
                <small style="color:#9ca3af;font-size:0.75rem">Use something unique ‚Äî anyone with the topic name can see notifications</small>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="hideNtfySettings()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNtfySettings()">Save & Test</button>
            </div>
        </div>
    </div>

    <script>
        // App State
        let currentTab = 'furniture';
        let furnitureItems = [];
        let pendingDeliveries = [];
        let routeStops = [];
        let salesHistory = [];
        let currentDeliveryItem = null;
        let currentCompletingDelivery = null;
        let currentStatusFilter = 'all';

        // Airbnb State
        let airbnbSupplies = [];
        let cleaningTemplates = [];
        let cleaningLogs = [];
        let messageTemplates = [];
        let maintenanceLog = [];
        let guestGuidebook = { propertyName: '', sections: [] };
        let sourcingTrips = [];
        let currentAirbnbSubtab = 'supplies';
        let currentSupplyCategoryFilter = 'all';
        let currentMsgCategoryFilter = 'all';
        let currentMaintStatusFilter = 'all';
        let activeChecklistLog = null;
        let editingSupplyId = null;
        let editingMsgTemplateId = null;
        let editingMaintenanceId = null;
        let editingTripId = null;
        let currentUseMsgTemplate = null;
        let guidebookEditMode = false;
        let galleryCurrentIndex = 0;
        let galleryCurrentPhotos = [];
        let pendingItemPhotos = [];

        // Drag state
        let dragState = null; // { stopId, startY, cardEl, placeholder, startIndex }

        // Utility
        function esc(str) {
            if (!str) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        // Constants
        const MILEAGE_RATE = 0.67;

        const TYPE_CONFIG = {
            delivery: { color: '#1e40af', icon: 'üì¶', label: 'Delivery' },
            errand:   { color: '#ea580c', icon: 'üõí', label: 'Errand' },
            pickup:   { color: '#16a34a', icon: 'üöö', label: 'Pickup' },
            restock:  { color: '#7c3aed', icon: 'üìã', label: 'Restock' }
        };

        const CATEGORY_LABELS = {
            other: 'Other', couch: 'Couch/Sofa', table: 'Table', chair: 'Chair',
            dresser: 'Dresser/Cabinet', bed: 'Bed/Frame', desk: 'Desk',
            shelf: 'Shelf/Bookcase', decor: 'Decor'
        };

        const STATUS_LABELS = {
            sourced: 'Sourced', fixing: 'Fixing Up', listed: 'Listed', pending: 'Pending Sale'
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadData();
            migrateData();
            seedAirbnbDefaults();
            renderAll();
            setupEventListeners();
            requestNotificationPermission();
            console.log('Cozy Capital App Initialized');
        }

        // Notifications
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function getNtfyTopic() {
            return localStorage.getItem('ntfy-topic') || '';
        }

        function setNtfyTopic(topic) {
            localStorage.setItem('ntfy-topic', topic);
        }

        function sendNtfyNotification(title, body, tags) {
            const topic = getNtfyTopic();
            if (!topic) return;
            fetch('https://ntfy.sh/' + encodeURIComponent(topic), {
                method: 'POST',
                headers: { 'Title': title, 'Tags': tags || 'loudspeaker' },
                body: body
            }).catch(err => console.log('ntfy error:', err));
        }

        function showNtfySettings() {
            document.getElementById('ntfy-settings-modal').classList.remove('hidden');
            document.getElementById('ntfy-topic-input').value = getNtfyTopic();
        }

        function hideNtfySettings() {
            document.getElementById('ntfy-settings-modal').classList.add('hidden');
        }

        function saveNtfySettings() {
            const topic = document.getElementById('ntfy-topic-input').value.trim();
            setNtfyTopic(topic);
            hideNtfySettings();
            if (topic) {
                sendNtfyNotification('Cozy Capital', 'Notifications are connected!', 'white_check_mark');
            }
        }

        function sendNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                try {
                    new Notification(title, { body });
                } catch (e) {
                    // Fallback for environments that don't support Notification constructor
                    console.log('Notification:', title, body);
                }
            }
        }

        // Data Management
        function loadData() {
            furnitureItems = JSON.parse(localStorage.getItem('furniture-items') || '[]');
            pendingDeliveries = JSON.parse(localStorage.getItem('pending-deliveries') || '[]');
            routeStops = JSON.parse(localStorage.getItem('route-stops') || '[]');
            salesHistory = JSON.parse(localStorage.getItem('sales-history') || '[]');
            airbnbSupplies = JSON.parse(localStorage.getItem('airbnb-supplies') || '[]');
            cleaningTemplates = JSON.parse(localStorage.getItem('cleaning-templates') || '[]');
            cleaningLogs = JSON.parse(localStorage.getItem('cleaning-logs') || '[]');
            messageTemplates = JSON.parse(localStorage.getItem('message-templates') || '[]');
            maintenanceLog = JSON.parse(localStorage.getItem('maintenance-log') || '[]');
            guestGuidebook = JSON.parse(localStorage.getItem('guest-guidebook') || '{"propertyName":"","sections":[]}');
            sourcingTrips = JSON.parse(localStorage.getItem('sourcing-trips') || '[]');
        }

        function saveData() {
            localStorage.setItem('furniture-items', JSON.stringify(furnitureItems));
            localStorage.setItem('pending-deliveries', JSON.stringify(pendingDeliveries));
            localStorage.setItem('route-stops', JSON.stringify(routeStops));
            localStorage.setItem('sales-history', JSON.stringify(salesHistory));
            localStorage.setItem('airbnb-supplies', JSON.stringify(airbnbSupplies));
            localStorage.setItem('cleaning-templates', JSON.stringify(cleaningTemplates));
            localStorage.setItem('cleaning-logs', JSON.stringify(cleaningLogs));
            localStorage.setItem('message-templates', JSON.stringify(messageTemplates));
            localStorage.setItem('maintenance-log', JSON.stringify(maintenanceLog));
            localStorage.setItem('guest-guidebook', JSON.stringify(guestGuidebook));
            localStorage.setItem('sourcing-trips', JSON.stringify(sourcingTrips));
        }

        // Migration
        function migrateData() {
            let changed = false;

            // Migrate existing pendingDeliveries to routeStops if routeStops is empty
            if (routeStops.length === 0 && pendingDeliveries.length > 0) {
                pendingDeliveries.forEach((delivery, i) => {
                    routeStops.push({
                        id: 'stop' + Date.now() + i,
                        type: 'delivery',
                        title: 'Deliver ' + delivery.item + ' to ' + delivery.customer,
                        address: delivery.address,
                        datetime: delivery.datetime,
                        notes: '',
                        deliveryId: delivery.id,
                        completed: false,
                        order: i
                    });
                });
                changed = true;
            }

            // Migrate existing items: add status, category, photos, listings if missing
            furnitureItems.forEach(item => {
                if (!item.status) {
                    item.status = 'listed';
                    changed = true;
                }
                if (!item.category) {
                    item.category = 'other';
                    changed = true;
                }
                if (!item.photos) {
                    item.photos = item.photo ? [{ id: 'ph' + Date.now() + Math.random(), photo: item.photo, caption: '', order: 0 }] : [];
                    if (item.photos.length > 0) item.primaryPhotoId = item.photos[0].id;
                    changed = true;
                }
                if (!item.listings) {
                    item.listings = [];
                    changed = true;
                }
                if (!item.createdAt) {
                    item.createdAt = item.updatedAt || new Date().toISOString();
                    changed = true;
                }
            });

            // Migrate sales history: add category and createdAt if missing
            salesHistory.forEach(sale => {
                if (!sale.category) {
                    sale.category = 'other';
                    changed = true;
                }
                if (!('createdAt' in sale)) {
                    sale.createdAt = null;
                    changed = true;
                }
            });

            if (changed) saveData();
        }

        function renderAll() {
            renderFurnitureItems();
            renderRouteStops();
            renderSalesHistory();
            updateStats();
            renderFinancialDashboard();
            renderAirbnbSupplies();
            renderCleaningTemplates();
            renderCleaningLogs();
            renderMessageTemplates();
            renderMaintenanceLog();
            renderGuidebook();
            renderSourcingTrips();
        }

        // Tab Management
        function switchTab(tab) {
            currentTab = tab;

            document.querySelectorAll('.main-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('[id$="-section"]').forEach(section => {
                if (['furniture-section','airbnb-section','history-section','finances-section'].includes(section.id)) {
                    section.classList.add('hidden');
                }
            });
            document.getElementById(tab + '-section').classList.remove('hidden');
        }

        // Status Pipeline Filter
        function filterByStatus(status) {
            currentStatusFilter = status;
            document.querySelectorAll('.status-pill').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderFurnitureItems();
        }

        // Stats Updates
        function updateStats() {
            const totalItems = furnitureItems.length;
            const totalInvested = furnitureItems.reduce((sum, item) => {
                return sum + calculateTotalCost(item);
            }, 0);
            const potentialRevenue = furnitureItems.reduce((sum, item) => sum + (item.salePrice || 0), 0);
            const potentialProfit = potentialRevenue - totalInvested;

            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('total-invested').textContent = '$' + totalInvested.toFixed(2);
            document.getElementById('potential-revenue').textContent = '$' + potentialRevenue.toFixed(2);
            document.getElementById('potential-profit').textContent = '$' + potentialProfit.toFixed(2);

            const profitElement = document.getElementById('potential-profit');
            profitElement.style.color = potentialProfit >= 0 ? '#059669' : '#dc2626';

            const totalSold = salesHistory.length;
            const totalRevenue = salesHistory.reduce((sum, sale) => sum + sale.finalPrice, 0);
            const totalCosts = salesHistory.reduce((sum, sale) => sum + sale.totalCost, 0);
            const actualProfit = totalRevenue - totalCosts;

            document.getElementById('total-sold').textContent = totalSold;
            document.getElementById('total-revenue').textContent = '$' + totalRevenue.toFixed(2);
            document.getElementById('total-costs').textContent = '$' + totalCosts.toFixed(2);
            document.getElementById('actual-profit').textContent = '$' + actualProfit.toFixed(2);

            const actualProfitElement = document.getElementById('actual-profit');
            actualProfitElement.style.color = actualProfit >= 0 ? '#059669' : '#dc2626';
        }

        function calculateTotalCost(item) {
            return (item.purchasePrice || 0) +
                   (item.travelCost || 0) +
                   (item.materialsCost || 0) +
                   (item.repairCost || 0) +
                   (item.deliveryMileageCost || 0);
        }

        // Financial Dashboard
        function getMonthKey(dateStr) {
            if (!dateStr) return null;
            const d = new Date(dateStr);
            return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
        }

        function getMonthLabel(key) {
            const [y, m] = key.split('-');
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            return months[parseInt(m) - 1] + ' ' + y.slice(2);
        }

        function buildBarChart(items, maxVal, labelFn, barsFn, unit) {
            if (maxVal <= 0) maxVal = 1;
            const prefix = unit === 'mi' ? '' : '$';
            const suffix = unit === 'mi' ? ' mi' : '';
            let html = '<div class="bar-chart">';
            items.forEach(item => {
                html += '<div class="bar-group"><div class="bar-stack">';
                const bars = barsFn(item);
                bars.forEach(b => {
                    const h = Math.max(2, (Math.abs(b.value) / maxVal) * 150);
                    const display = b.value < 0 ? '-' + prefix + Math.abs(b.value).toFixed(0) + suffix : prefix + Math.abs(b.value).toFixed(0) + suffix;
                    html += `<div style="display:flex;flex-direction:column;align-items:center"><div class="bar-value">${display}</div><div class="bar ${b.cls}" style="height:${h}px" title="${b.label}: ${prefix}${b.value.toFixed(2)}${suffix}"></div></div>`;
                });
                html += `</div><div class="bar-label">${labelFn(item)}</div></div>`;
            });
            html += '</div>';
            return html;
        }

        function renderFinancialDashboard() {
            const container = document.getElementById('finance-dashboard-container');
            if (!container) return;

            if (salesHistory.length === 0 && furnitureItems.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><h3>No Data Yet</h3><p>Complete sales and add inventory to see your financial analytics.</p></div>';
                return;
            }

            const totalRevenue = salesHistory.reduce((s, x) => s + x.finalPrice, 0);
            const totalCosts = salesHistory.reduce((s, x) => s + x.totalCost, 0);
            const netProfit = totalRevenue - totalCosts;
            const avgProfit = salesHistory.length > 0 ? netProfit / salesHistory.length : 0;

            let html = '<div class="finance-dashboard">';

            // 1. KPI Cards
            html += '<div class="kpi-grid">';
            html += `<div class="kpi-card"><div class="kpi-label">Total Revenue</div><div class="kpi-value">$${totalRevenue.toFixed(2)}</div></div>`;
            html += `<div class="kpi-card red"><div class="kpi-label">Total Costs</div><div class="kpi-value">$${totalCosts.toFixed(2)}</div></div>`;
            html += `<div class="kpi-card green"><div class="kpi-label">Net Profit</div><div class="kpi-value ${netProfit >= 0 ? 'positive' : 'negative'}">$${netProfit.toFixed(2)}</div></div>`;
            html += `<div class="kpi-card purple"><div class="kpi-label">Avg Profit/Flip</div><div class="kpi-value ${avgProfit >= 0 ? 'positive' : 'negative'}">$${avgProfit.toFixed(2)}</div></div>`;
            html += '</div>';

            // 2. Monthly Income vs Expenses
            const monthlyData = {};
            salesHistory.forEach(sale => {
                const key = getMonthKey(sale.completedDate);
                if (!key) return;
                if (!monthlyData[key]) monthlyData[key] = { revenue: 0, costs: 0 };
                monthlyData[key].revenue += sale.finalPrice;
                monthlyData[key].costs += sale.totalCost;
            });
            const monthKeys = Object.keys(monthlyData).sort();

            if (monthKeys.length > 0) {
                const maxMonthly = Math.max(...monthKeys.map(k => Math.max(monthlyData[k].revenue, monthlyData[k].costs)));
                html += '<div class="finance-section"><h3>Monthly Income vs Expenses</h3>';
                html += '<div class="chart-legend"><div class="legend-item"><div class="legend-dot" style="background:#3b82f6"></div>Revenue</div><div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div>Costs</div><div class="legend-item"><div class="legend-dot" style="background:#10b981"></div>Profit</div></div>';
                html += buildBarChart(monthKeys, maxMonthly, k => getMonthLabel(k), k => {
                    const d = monthlyData[k];
                    return [
                        { value: d.revenue, cls: 'revenue', label: 'Revenue' },
                        { value: d.costs, cls: 'cost', label: 'Costs' },
                        { value: d.revenue - d.costs, cls: 'profit', label: 'Profit' }
                    ];
                });
                html += '</div>';
            }

            // 3. Category Performance
            const catData = {};
            salesHistory.forEach(sale => {
                const cat = sale.category || 'other';
                if (!catData[cat]) catData[cat] = { totalProfit: 0, count: 0 };
                catData[cat].totalProfit += sale.profit;
                catData[cat].count++;
            });
            const catEntries = Object.entries(catData).map(([k, v]) => ({ cat: k, avg: v.totalProfit / v.count, count: v.count })).sort((a, b) => b.avg - a.avg);

            if (catEntries.length > 0) {
                const maxCat = Math.max(...catEntries.map(c => Math.abs(c.avg)));
                html += '<div class="finance-section"><h3>Avg Profit by Category</h3>';
                html += buildBarChart(catEntries, maxCat, c => (CATEGORY_LABELS[c.cat] || c.cat) + ' (' + c.count + ')', c => [
                    { value: c.avg, cls: 'category', label: CATEGORY_LABELS[c.cat] || c.cat }
                ]);
                html += '</div>';
            }

            // 4. Best/Worst Flips
            if (salesHistory.length > 0) {
                const sorted = [...salesHistory].sort((a, b) => b.profit - a.profit);
                const best = sorted.slice(0, 5);
                const worst = sorted.slice(-5).reverse();

                html += '<div class="finance-section"><h3>Best & Worst Flips</h3><div class="flip-tables">';
                html += '<div class="flip-table"><h4 class="best">Top 5 Best</h4><table><tr><th>Item</th><th>Profit</th></tr>';
                best.forEach(s => {
                    html += `<tr><td>${s.item}</td><td class="${s.profit >= 0 ? 'positive' : 'negative'}" style="color:${s.profit >= 0 ? '#059669' : '#dc2626'}; font-weight:600">$${s.profit.toFixed(2)}</td></tr>`;
                });
                html += '</table></div>';

                html += '<div class="flip-table"><h4 class="worst">Top 5 Worst</h4><table><tr><th>Item</th><th>Profit</th></tr>';
                worst.forEach(s => {
                    html += `<tr><td>${s.item}</td><td style="color:${s.profit >= 0 ? '#059669' : '#dc2626'}; font-weight:600">$${s.profit.toFixed(2)}</td></tr>`;
                });
                html += '</table></div></div></div>';
            }

            // 5. Average Days to Sell
            if (salesHistory.length > 0) {
                const salesWithDates = salesHistory.filter(s => s.createdAt && s.completedDate);
                html += '<div class="finance-section"><h3>Average Days to Sell</h3>';
                if (salesWithDates.length > 0) {
                    const totalDays = salesWithDates.reduce((sum, s) => {
                        return sum + (new Date(s.completedDate) - new Date(s.createdAt)) / (1000 * 60 * 60 * 24);
                    }, 0);
                    const overallAvg = totalDays / salesWithDates.length;
                    html += `<div class="stat-row"><span class="stat-label">Overall Average</span><span class="stat-value">${overallAvg.toFixed(1)} days</span></div>`;

                    const catDays = {};
                    salesWithDates.forEach(s => {
                        const cat = s.category || 'other';
                        if (!catDays[cat]) catDays[cat] = { total: 0, count: 0 };
                        const days = (new Date(s.completedDate) - new Date(s.createdAt)) / (1000 * 60 * 60 * 24);
                        catDays[cat].total += days;
                        catDays[cat].count++;
                    });
                    Object.entries(catDays).sort((a, b) => (a[1].total / a[1].count) - (b[1].total / b[1].count)).forEach(([cat, d]) => {
                        html += `<div class="stat-row"><span class="stat-label">${CATEGORY_LABELS[cat] || cat}</span><span class="stat-value">${(d.total / d.count).toFixed(1)} days</span></div>`;
                    });
                } else {
                    html += '<p style="color:#6b7280; font-size:0.85rem">Date tracking will appear for future sales.</p>';
                }
                html += '</div>';
            }

            // 6. Mileage Tax Deduction
            const sourcingMiles = sourcingTrips.reduce((s, t) => s + (t.miles || 0), 0);
            const deliveryMiles = salesHistory.reduce((s, x) => s + (x.deliveryMileage || 0), 0);
            const totalMiles = sourcingMiles + deliveryMiles;
            const totalDeduction = totalMiles * MILEAGE_RATE;

            if (totalMiles > 0) {
                html += '<div class="finance-section"><h3>Mileage Tax Deduction</h3>';
                html += `<div class="stat-row"><span class="stat-label">Sourcing Miles</span><span class="stat-value">${sourcingMiles.toFixed(1)} mi</span></div>`;
                html += `<div class="stat-row"><span class="stat-label">Delivery Miles</span><span class="stat-value">${deliveryMiles.toFixed(1)} mi</span></div>`;
                html += `<div class="stat-row"><span class="stat-label">Total Miles</span><span class="stat-value">${totalMiles.toFixed(1)} mi</span></div>`;
                html += `<div class="stat-row"><span class="stat-label">IRS Rate</span><span class="stat-value">$${MILEAGE_RATE}/mi</span></div>`;
                html += `<div class="stat-row"><span class="stat-label" style="font-weight:700;color:#1f2937">Total Deduction</span><span class="stat-value positive" style="color:#059669">$${totalDeduction.toFixed(2)}</span></div>`;

                // Monthly mileage chart
                const mileageByMonth = {};
                sourcingTrips.forEach(t => {
                    const key = getMonthKey(t.date);
                    if (!key) return;
                    if (!mileageByMonth[key]) mileageByMonth[key] = 0;
                    mileageByMonth[key] += t.miles || 0;
                });
                salesHistory.forEach(s => {
                    const key = getMonthKey(s.completedDate);
                    if (!key) return;
                    if (!mileageByMonth[key]) mileageByMonth[key] = 0;
                    mileageByMonth[key] += s.deliveryMileage || 0;
                });
                const mileageKeys = Object.keys(mileageByMonth).sort();
                if (mileageKeys.length > 1) {
                    const maxMileage = Math.max(...mileageKeys.map(k => mileageByMonth[k]));
                    html += '<div style="margin-top:16px"><h4 style="font-size:0.85rem;margin-bottom:8px">Monthly Miles</h4>';
                    html += buildBarChart(mileageKeys, maxMileage, k => getMonthLabel(k), k => [
                        { value: mileageByMonth[k], cls: 'mileage', label: 'Miles' }
                    ], 'mi');
                    html += '</div>';
                }
                html += '</div>';
            }

            // 7. Inventory Value Snapshot
            if (furnitureItems.length > 0) {
                const invCost = furnitureItems.reduce((s, i) => s + calculateTotalCost(i), 0);
                const invRevenue = furnitureItems.reduce((s, i) => s + (i.salePrice || 0), 0);
                const invProfit = invRevenue - invCost;

                html += '<div class="finance-section"><h3>Current Inventory Snapshot</h3>';
                html += `<div class="stat-row"><span class="stat-label">Items in Inventory</span><span class="stat-value">${furnitureItems.length}</span></div>`;
                html += `<div class="stat-row"><span class="stat-label">Total Invested</span><span class="stat-value">$${invCost.toFixed(2)}</span></div>`;
                html += `<div class="stat-row"><span class="stat-label">Potential Revenue</span><span class="stat-value">$${invRevenue.toFixed(2)}</span></div>`;
                html += `<div class="stat-row"><span class="stat-label">Potential Profit</span><span class="stat-value" style="color:${invProfit >= 0 ? '#059669' : '#dc2626'}">$${invProfit.toFixed(2)}</span></div>`;
                html += '</div>';
            }

            // 8. Trends & Insights
            if (salesHistory.length >= 2) {
                html += '<div class="finance-section"><h3>Trends & Insights</h3><div class="insight-cards">';

                // Best month
                if (monthKeys.length > 0) {
                    let bestMonth = monthKeys[0], bestMonthProfit = -Infinity;
                    monthKeys.forEach(k => {
                        const p = monthlyData[k].revenue - monthlyData[k].costs;
                        if (p > bestMonthProfit) { bestMonthProfit = p; bestMonth = k; }
                    });
                    html += `<div class="insight-card">Best month: <strong>${getMonthLabel(bestMonth)}</strong> with $${bestMonthProfit.toFixed(2)} profit</div>`;
                }

                // Highest margin flip
                const bestFlip = [...salesHistory].sort((a, b) => b.profit - a.profit)[0];
                if (bestFlip) {
                    const margin = bestFlip.totalCost > 0 ? ((bestFlip.profit / bestFlip.totalCost) * 100).toFixed(0) : '‚àû';
                    html += `<div class="insight-card info">Highest margin flip: <strong>${bestFlip.item}</strong> ‚Äî ${margin}% return ($${bestFlip.profit.toFixed(2)} profit)</div>`;
                }

                // Category speed comparison
                if (catEntries.length >= 2) {
                    const salesWithDates2 = salesHistory.filter(s => s.createdAt && s.completedDate);
                    const catSpeed = {};
                    salesWithDates2.forEach(s => {
                        const cat = s.category || 'other';
                        if (!catSpeed[cat]) catSpeed[cat] = { total: 0, count: 0 };
                        catSpeed[cat].total += (new Date(s.completedDate) - new Date(s.createdAt)) / (1000 * 60 * 60 * 24);
                        catSpeed[cat].count++;
                    });
                    const speedEntries = Object.entries(catSpeed).filter(([, v]) => v.count > 0).sort((a, b) => (a[1].total / a[1].count) - (b[1].total / b[1].count));
                    if (speedEntries.length >= 2) {
                        const fastest = speedEntries[0];
                        const slowest = speedEntries[speedEntries.length - 1];
                        html += `<div class="insight-card warn">Fastest selling: <strong>${CATEGORY_LABELS[fastest[0]] || fastest[0]}</strong> (${(fastest[1].total / fastest[1].count).toFixed(1)} days avg) ‚Äî Slowest: <strong>${CATEGORY_LABELS[slowest[0]] || slowest[0]}</strong> (${(slowest[1].total / slowest[1].count).toFixed(1)} days avg)</div>`;
                    }
                }

                // Avg profit trend
                if (monthKeys.length >= 2) {
                    const firstHalf = monthKeys.slice(0, Math.ceil(monthKeys.length / 2));
                    const secondHalf = monthKeys.slice(Math.ceil(monthKeys.length / 2));
                    const firstAvg = firstHalf.reduce((s, k) => s + monthlyData[k].revenue - monthlyData[k].costs, 0) / firstHalf.length;
                    const secondAvg = secondHalf.reduce((s, k) => s + monthlyData[k].revenue - monthlyData[k].costs, 0) / secondHalf.length;
                    if (secondAvg > firstAvg) {
                        html += `<div class="insight-card">Profit trend is <strong>improving</strong> ‚Äî recent months average $${secondAvg.toFixed(0)}/mo vs $${firstAvg.toFixed(0)}/mo earlier</div>`;
                    } else if (secondAvg < firstAvg) {
                        html += `<div class="insight-card warn">Profit trend is <strong>declining</strong> ‚Äî recent months average $${secondAvg.toFixed(0)}/mo vs $${firstAvg.toFixed(0)}/mo earlier</div>`;
                    }
                }

                html += '</div></div>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // Furniture Items Rendering
        function renderFurnitureItems() {
            const container = document.getElementById('furniture-inventory');
            const emptyState = document.getElementById('furniture-empty');

            let items = furnitureItems;
            if (currentStatusFilter !== 'all') {
                items = items.filter(item => item.status === currentStatusFilter);
            }

            if (items.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                if (furnitureItems.length > 0 && currentStatusFilter !== 'all') {
                    emptyState.querySelector('h3').textContent = 'No "' + STATUS_LABELS[currentStatusFilter] + '" Items';
                    emptyState.querySelector('p').textContent = 'No items match this filter.';
                } else {
                    emptyState.querySelector('h3').textContent = 'No Items in Inventory';
                    emptyState.querySelector('p').textContent = 'Start tracking your inventory by adding your first item with photos, costs, and pricing.';
                }
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = '';

            items.forEach(item => {
                const card = createItemCard(item);
                container.appendChild(card);
            });
        }

        function getAgingInfo(item) {
            if (!item.createdAt) return { days: 0, cls: 'green', label: 'New' };
            const days = Math.floor((Date.now() - new Date(item.createdAt).getTime()) / 86400000);
            if (days >= 60) return { days, cls: 'red', label: days + 'd' };
            if (days >= 30) return { days, cls: 'yellow', label: days + 'd' };
            return { days, cls: 'green', label: days + 'd' };
        }

        function getItemPhotos(item) {
            if (item.photos && item.photos.length > 0) return item.photos;
            if (item.photo) return [{ id: 'legacy', photo: item.photo, caption: '', order: 0 }];
            return [];
        }

        function getPrimaryPhoto(item) {
            const photos = getItemPhotos(item);
            if (photos.length === 0) return null;
            if (item.primaryPhotoId) {
                const primary = photos.find(p => p.id === item.primaryPhotoId);
                if (primary) return primary.photo;
            }
            return photos[0].photo;
        }

        function createItemCard(item) {
            const card = document.createElement('div');
            card.className = 'item-card';

            const totalCost = calculateTotalCost(item);
            const profit = (item.salePrice || 0) - totalCost;
            const profitColor = profit >= 0 ? '#059669' : '#dc2626';

            const statusBadge = item.status ? '<span class="status-badge ' + item.status + '">' + STATUS_LABELS[item.status] + '</span>' : '';
            const categoryTag = item.category && item.category !== 'other' ? '<span class="category-tag">' + CATEGORY_LABELS[item.category] + '</span>' : '';

            const aging = getAgingInfo(item);
            const agingBadge = '<span class="aging-badge ' + aging.cls + '">' + aging.label + '</span>';

            const photos = getItemPhotos(item);
            const primaryPhoto = getPrimaryPhoto(item);
            const photoCountBadge = photos.length > 1 ? `<span class="photo-gallery-count">${photos.length} photos</span>` : '';

            const listings = item.listings || [];
            let listingHtml = '';
            if (listings.length > 0) {
                listingHtml = '<div class="listing-badges">' + listings.map((l, idx) =>
                    `<span class="listing-badge ${l.status === 'sold' ? 'sold' : l.status === 'delisted' ? 'delisted' : ''}" onclick="event.stopPropagation(); cycleListingStatus('${item.id}', ${idx})" style="cursor:pointer;" title="Tap to change status">${l.platform}${l.status === 'sold' ? ' ‚úì' : l.status === 'delisted' ? ' ‚úó' : ''}<span onclick="event.stopPropagation(); deleteListing('${item.id}', ${idx})" style="cursor:pointer; margin-left:4px; opacity:0.6;">‚úï</span></span>`
                ).join('') + '</div>';
            }

            card.innerHTML = `
                <div class="item-image photo-gallery-container" onclick="openItemGallery('${item.id}')">
                    ${primaryPhoto ? `<img src="${primaryPhoto}" alt="${esc(item.title)}">` : 'üì¶'}
                    ${photoCountBadge}
                </div>
                <div class="item-header">
                    <div class="item-title">${esc(item.title)} ${agingBadge}</div>
                    ${statusBadge}
                    ${categoryTag}
                </div>
                <div class="item-description">${esc(item.description) || 'No description'}</div>
                ${listingHtml}
                <div class="cost-breakdown">
                    <div class="cost-row">
                        <span>Purchase:</span>
                        <span>$${item.purchasePrice.toFixed(2)}</span>
                    </div>
                    ${item.travelCost ? `<div class="cost-row">
                        <span>Travel:</span>
                        <span>$${item.travelCost.toFixed(2)}</span>
                    </div>` : ''}
                    ${item.materialsCost ? `<div class="cost-row">
                        <span>Materials:</span>
                        <span>$${item.materialsCost.toFixed(2)}</span>
                    </div>` : ''}
                    ${item.repairCost ? `<div class="cost-row">
                        <span>Repairs:</span>
                        <span>$${item.repairCost.toFixed(2)}</span>
                    </div>` : ''}
                    <div class="cost-row total">
                        <span>Total Cost:</span>
                        <span>$${totalCost.toFixed(2)}</span>
                    </div>
                    ${item.salePrice ? `
                    <div class="cost-row" style="color: #1e40af; font-weight: 600;">
                        <span>Sale Price:</span>
                        <span>$${item.salePrice.toFixed(2)}</span>
                    </div>
                    <div class="cost-row profit" style="color: ${profitColor};">
                        <span>Expected Profit:</span>
                        <span>$${profit.toFixed(2)}</span>
                    </div>` : ''}
                </div>
                <div class="item-actions">
                    <button class="action-btn send-btn" onclick="showDeliveryModal('${item.id}')">
                        üì¶ Deliver
                    </button>
                    <button class="action-btn edit-btn" onclick="showAddListingModal('${item.id}')" title="Add listing">
                        üìç List
                    </button>
                    <button class="action-btn edit-btn" onclick="editItem('${item.id}')">
                        ‚úèÔ∏è Edit
                    </button>
                    <button class="action-btn delete-btn" onclick="deleteItem('${item.id}')">
                        üóëÔ∏è
                    </button>
                </div>
            `;

            return card;
        }

        // ========== ROUTE STOPS ==========

        function renderRouteStops() {
            const section = document.getElementById('route-section');
            const list = document.getElementById('route-cards-list');
            const emptyEl = document.getElementById('route-empty');

            if (routeStops.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');

            // Sort: incomplete first (by order), completed at bottom
            const incomplete = routeStops.filter(s => !s.completed).sort((a, b) => a.order - b.order);
            const completed = routeStops.filter(s => s.completed);
            const sorted = [...incomplete, ...completed];

            if (sorted.length === 0) {
                list.innerHTML = '';
                emptyEl.classList.remove('hidden');
                return;
            }

            emptyEl.classList.add('hidden');
            list.innerHTML = '';

            let stopNum = 1;
            sorted.forEach(stop => {
                const card = document.createElement('div');
                card.className = 'route-card type-' + stop.type + (stop.completed ? ' completed' : '');
                card.dataset.stopId = stop.id;

                const num = stop.completed ? '‚úì' : stopNum++;
                const timeStr = stop.datetime ? formatTime(stop.datetime) : '';
                const cfg = TYPE_CONFIG[stop.type] || TYPE_CONFIG.errand;

                card.innerHTML = `
                    <div class="route-card-color-bar"></div>
                    <div class="route-card-grab" data-grab="true">‚ò∞</div>
                    <div class="route-card-number">${num}</div>
                    <div class="route-card-body">
                        <div class="route-card-title">${cfg.icon} ${stop.title}</div>
                        ${stop.address ? '<div class="route-card-address">' + stop.address + '</div>' : ''}
                        ${timeStr ? '<div class="route-card-time">' + timeStr + '</div>' : ''}
                        ${stop.notes ? '<div class="route-card-time">üìù ' + stop.notes + '</div>' : ''}
                    </div>
                    <div class="route-card-check">
                        <input type="checkbox" ${stop.completed ? 'checked' : ''} onchange="toggleStopComplete('${stop.id}')">
                    </div>
                    <div class="route-card-delete" onclick="deleteRouteStop('${stop.id}')" title="Remove stop">‚úï</div>
                `;

                // Touch drag setup
                const grabHandle = card.querySelector('[data-grab]');
                grabHandle.addEventListener('touchstart', onTouchDragStart, { passive: false });
                grabHandle.addEventListener('mousedown', onMouseDragStart);

                list.appendChild(card);
            });
        }

        function formatTime(datetime) {
            try {
                const d = new Date(datetime);
                return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch(e) { return ''; }
        }

        function toggleStopComplete(stopId) {
            const stop = routeStops.find(s => s.id === stopId);
            if (!stop) return;

            if (!stop.completed && stop.type === 'delivery' && stop.deliveryId) {
                // For delivery stops, open the complete delivery modal
                const delivery = pendingDeliveries.find(d => d.id === stop.deliveryId);
                if (delivery) {
                    showCompleteDeliveryModal(delivery.id);
                    // Re-render to uncheck the checkbox since completion happens via modal
                    renderRouteStops();
                    return;
                }
            }

            stop.completed = !stop.completed;
            if (stop.completed) {
                stop.completedAt = new Date().toISOString();
                sendNtfyNotification(
                    'Stop Completed ‚úÖ',
                    stop.title + (stop.address ? ' at ' + stop.address : ''),
                    'white_check_mark'
                );
            } else {
                delete stop.completedAt;
            }
            saveData();
            renderRouteStops();
        }

        function deleteRouteStop(stopId) {
            const stop = routeStops.find(s => s.id === stopId);
            if (!stop) return;

            const label = stop.title;
            if (!confirm('Remove "' + label + '" from your route?')) return;

            routeStops = routeStops.filter(s => s.id !== stopId);
            // Reorder remaining
            routeStops.filter(s => !s.completed).sort((a, b) => a.order - b.order).forEach((s, i) => s.order = i);
            saveData();
            renderRouteStops();
        }

        // ========== TOUCH DRAG & DROP ==========

        function onTouchDragStart(e) {
            e.preventDefault();
            const card = e.target.closest('.route-card');
            if (!card || card.classList.contains('completed')) return;

            const touch = e.touches[0];
            startDrag(card, touch.clientY);

            document.addEventListener('touchmove', onTouchDragMove, { passive: false });
            document.addEventListener('touchend', onTouchDragEnd);
        }

        function onTouchDragMove(e) {
            e.preventDefault();
            if (!dragState) return;
            moveDrag(e.touches[0].clientY);
        }

        function onTouchDragEnd(e) {
            document.removeEventListener('touchmove', onTouchDragMove);
            document.removeEventListener('touchend', onTouchDragEnd);
            endDrag();
        }

        function onMouseDragStart(e) {
            const card = e.target.closest('.route-card');
            if (!card || card.classList.contains('completed')) return;

            e.preventDefault();
            startDrag(card, e.clientY);

            document.addEventListener('mousemove', onMouseDragMove);
            document.addEventListener('mouseup', onMouseDragEnd);
        }

        function onMouseDragMove(e) {
            if (!dragState) return;
            moveDrag(e.clientY);
        }

        function onMouseDragEnd(e) {
            document.removeEventListener('mousemove', onMouseDragMove);
            document.removeEventListener('mouseup', onMouseDragEnd);
            endDrag();
        }

        function startDrag(card, startY) {
            document.body.classList.add('dragging');

            const stopId = card.dataset.stopId;
            const list = document.getElementById('route-cards-list');
            const cards = Array.from(list.querySelectorAll('.route-card:not(.completed)'));
            const startIndex = cards.indexOf(card);

            // Create placeholder
            const placeholder = document.createElement('div');
            placeholder.className = 'drag-placeholder';
            placeholder.style.height = card.offsetHeight + 'px';

            // Position card for dragging
            const rect = card.getBoundingClientRect();
            card.classList.add('dragging');
            card.style.position = 'fixed';
            card.style.top = rect.top + 'px';
            card.style.left = rect.left + 'px';
            card.style.width = rect.width + 'px';
            card.style.zIndex = '1001';

            card.parentNode.insertBefore(placeholder, card);

            dragState = {
                stopId,
                startY,
                offsetY: startY - rect.top,
                cardEl: card,
                placeholder,
                startIndex,
                currentIndex: startIndex
            };
        }

        function moveDrag(clientY) {
            if (!dragState) return;

            // Move the card
            dragState.cardEl.style.top = (clientY - dragState.offsetY) + 'px';

            // Determine new position
            const list = document.getElementById('route-cards-list');
            const siblings = Array.from(list.querySelectorAll('.route-card:not(.completed):not(.dragging), .drag-placeholder'));
            const placeholderIndex = siblings.indexOf(dragState.placeholder);

            for (let i = 0; i < siblings.length; i++) {
                if (siblings[i] === dragState.placeholder) continue;
                const rect = siblings[i].getBoundingClientRect();
                const midY = rect.top + rect.height / 2;

                if (clientY < midY && i < placeholderIndex) {
                    list.insertBefore(dragState.placeholder, siblings[i]);
                    dragState.currentIndex = i;
                    break;
                } else if (clientY > midY && i > placeholderIndex) {
                    if (siblings[i].nextSibling) {
                        list.insertBefore(dragState.placeholder, siblings[i].nextSibling);
                    } else {
                        list.appendChild(dragState.placeholder);
                    }
                    dragState.currentIndex = i;
                    break;
                }
            }
        }

        function endDrag() {
            if (!dragState) return;

            document.body.classList.remove('dragging');

            const { cardEl, placeholder, stopId } = dragState;

            // Reset card styles
            cardEl.classList.remove('dragging');
            cardEl.style.position = '';
            cardEl.style.top = '';
            cardEl.style.left = '';
            cardEl.style.width = '';
            cardEl.style.zIndex = '';

            // Insert card where placeholder is
            placeholder.parentNode.insertBefore(cardEl, placeholder);
            placeholder.remove();

            // Read new order from DOM
            const list = document.getElementById('route-cards-list');
            const cardEls = Array.from(list.querySelectorAll('.route-card:not(.completed)'));
            cardEls.forEach((el, i) => {
                const stop = routeStops.find(s => s.id === el.dataset.stopId);
                if (stop) stop.order = i;
            });

            dragState = null;
            saveData();
            renderRouteStops();
        }

        // ========== MODAL MANAGEMENT ==========

        function showAddItemModal() {
            document.getElementById('add-item-modal').classList.remove('hidden');
        }

        function hideAddItemModal() {
            document.getElementById('add-item-modal').classList.add('hidden');
            document.getElementById('add-item-form').reset();
            resetPhotoUpload();
            document.getElementById('item-photo-previews').innerHTML = '';
            pendingItemPhotos = [];
            document.querySelector('#add-item-modal h3').textContent = 'Add New Item';
            document.querySelector('#add-item-form button[type="submit"]').textContent = 'Add Item';
            window.editingItemId = null;
        }

        function showQuickAddModal() {
            document.getElementById('quick-add-modal').classList.remove('hidden');
            // Reset
            document.getElementById('quick-add-form').reset();
            document.getElementById('quick-photo-text').textContent = 'Tap to open camera';
            document.querySelector('#quick-add-modal .photo-upload-area').classList.remove('has-file');
        }

        function hideQuickAddModal() {
            document.getElementById('quick-add-modal').classList.add('hidden');
            document.getElementById('quick-add-form').reset();
        }

        function showErrandModal() {
            document.getElementById('errand-modal').classList.remove('hidden');
        }

        function hideErrandModal() {
            document.getElementById('errand-modal').classList.add('hidden');
            document.getElementById('errand-form').reset();
        }

        function showPickupModal() {
            document.getElementById('pickup-modal').classList.remove('hidden');
        }

        function hidePickupModal() {
            document.getElementById('pickup-modal').classList.add('hidden');
            document.getElementById('pickup-form').reset();
        }

        function showDeliveryModal(itemId) {
            currentDeliveryItem = furnitureItems.find(item => item.id === itemId);
            document.getElementById('final-price').value = currentDeliveryItem.salePrice || '';
            document.getElementById('delivery-modal').classList.remove('hidden');
        }

        function hideDeliveryModal() {
            document.getElementById('delivery-modal').classList.add('hidden');
            document.getElementById('delivery-form').reset();
            currentDeliveryItem = null;
        }

        function showCompleteDeliveryModal(deliveryId) {
            currentCompletingDelivery = pendingDeliveries.find(d => d.id === deliveryId);
            if (!currentCompletingDelivery) return;

            const summary = document.getElementById('delivery-summary');
            summary.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">üì¶ ${currentCompletingDelivery.item}</div>
                <div style="color: #6b7280; font-size: 0.875rem; line-height: 1.6;">
                    üë§ ${currentCompletingDelivery.customer}<br>
                    üìç ${currentCompletingDelivery.address}<br>
                    üí∞ $${currentCompletingDelivery.price}
                </div>
            `;

            document.getElementById('complete-delivery-modal').classList.remove('hidden');
        }

        function hideCompleteDeliveryModal() {
            document.getElementById('complete-delivery-modal').classList.add('hidden');
            document.getElementById('complete-delivery-form').reset();
            currentCompletingDelivery = null;
        }

        // Photo Upload
        function compressPhoto(file, maxWidth, quality) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) {
                            h = Math.round(h * maxWidth / w);
                            w = maxWidth;
                        }
                        canvas.width = w;
                        canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function setupEventListeners() {
            const photoInput = document.getElementById('item-photo');
            const uploadArea = document.querySelector('#add-item-modal .photo-upload-area');

            photoInput.addEventListener('change', async function(e) {
                if (e.target.files.length > 0) {
                    uploadArea.classList.add('has-file');
                    const count = Math.min(e.target.files.length, 5);
                    uploadArea.querySelector('.upload-text').textContent = 'üì∏ ' + count + ' photo(s) selected';
                    pendingItemPhotos = [];
                    const previewContainer = document.getElementById('item-photo-previews');
                    previewContainer.innerHTML = '';
                    for (let i = 0; i < count; i++) {
                        const compressed = await compressPhoto(e.target.files[i], 800, 0.75);
                        pendingItemPhotos.push(compressed);
                        const thumb = document.createElement('img');
                        thumb.src = compressed;
                        thumb.className = 'photo-gallery-thumb';
                        thumb.style.width = '50px';
                        thumb.style.height = '50px';
                        previewContainer.appendChild(thumb);
                    }
                } else {
                    resetPhotoUpload();
                }
            });

            // Quick photo
            document.getElementById('quick-photo').addEventListener('change', function(e) {
                const area = document.querySelector('#quick-add-modal .photo-upload-area');
                if (e.target.files.length > 0) {
                    area.classList.add('has-file');
                    document.getElementById('quick-photo-text').textContent = 'üì∏ Photo added!';
                } else {
                    area.classList.remove('has-file');
                    document.getElementById('quick-photo-text').textContent = 'Tap to open camera';
                }
            });

            // Maintenance photo
            document.getElementById('maint-photo-input').addEventListener('change', function(e) {
                const area = document.querySelector('#add-maintenance-modal .photo-upload-area');
                if (e.target.files.length > 0) {
                    area.classList.add('has-file');
                    document.getElementById('maint-photo-text').textContent = 'üì∏ ' + e.target.files[0].name;
                } else {
                    area.classList.remove('has-file');
                    document.getElementById('maint-photo-text').textContent = 'Click to add photo';
                }
            });

            // Mileage cost calculator
            document.getElementById('delivery-mileage').addEventListener('input', function(e) {
                const miles = parseFloat(e.target.value) || 0;
                const cost = miles * MILEAGE_RATE;
                document.getElementById('mileage-cost').textContent = cost.toFixed(2);
            });

            // Form handlers
            document.getElementById('add-item-form').addEventListener('submit', handleAddEditItem);
            document.getElementById('delivery-form').addEventListener('submit', handleCreateDelivery);
            document.getElementById('complete-delivery-form').addEventListener('submit', handleCompleteDelivery);
            document.getElementById('quick-add-form').addEventListener('submit', handleQuickAdd);
            document.getElementById('errand-form').addEventListener('submit', handleAddErrand);
            document.getElementById('pickup-form').addEventListener('submit', handleAddPickup);
            document.getElementById('add-maintenance-form').addEventListener('submit', handleAddMaintenance);
            document.getElementById('add-trip-form').addEventListener('submit', handleAddTrip);
            document.getElementById('add-listing-form').addEventListener('submit', handleAddListing);
            document.getElementById('add-supply-form').addEventListener('submit', handleAddSupply);
            document.getElementById('cleaning-template-form').addEventListener('submit', handleSaveCleaningTemplate);
            document.getElementById('msg-template-form').addEventListener('submit', handleSaveMessageTemplate);
        }

        function resetPhotoUpload() {
            const uploadArea = document.querySelector('#add-item-modal .photo-upload-area');
            uploadArea.classList.remove('has-file');
            uploadArea.querySelector('.upload-text').textContent = 'Click to add photo';
        }

        // ========== FORM HANDLERS ==========

        function handleAddEditItem(e) {
            e.preventDefault();

            const title = document.getElementById('item-title').value;
            const description = document.getElementById('item-description').value;
            const purchasePrice = parseFloat(document.getElementById('item-purchase-price').value);
            const salePrice = parseFloat(document.getElementById('item-sale-price').value) || null;
            const travelCost = parseFloat(document.getElementById('travel-cost').value) || 0;
            const materialsCost = parseFloat(document.getElementById('materials-cost').value) || 0;
            const repairCost = parseFloat(document.getElementById('repair-cost').value) || 0;
            const status = document.getElementById('item-status').value;
            const category = document.getElementById('item-category').value;

            const itemData = {
                title,
                description,
                purchasePrice,
                salePrice,
                travelCost,
                materialsCost,
                repairCost,
                status,
                category,
                updatedAt: new Date().toISOString()
            };

            if (window.editingItemId) {
                const itemIndex = furnitureItems.findIndex(item => item.id === window.editingItemId);
                if (itemIndex !== -1) {
                    furnitureItems[itemIndex] = { ...furnitureItems[itemIndex], ...itemData };
                    if (pendingItemPhotos.length > 0) {
                        const newPhotos = pendingItemPhotos.map((p, i) => ({
                            id: 'ph' + Date.now() + i,
                            photo: p,
                            caption: '',
                            order: (furnitureItems[itemIndex].photos || []).length + i
                        }));
                        furnitureItems[itemIndex].photos = (furnitureItems[itemIndex].photos || []).concat(newPhotos);
                        if (!furnitureItems[itemIndex].primaryPhotoId) {
                            furnitureItems[itemIndex].primaryPhotoId = newPhotos[0].id;
                        }
                        furnitureItems[itemIndex].photo = furnitureItems[itemIndex].photos[0].photo;
                    }
                    saveData();
                    renderAll();
                    hideAddItemModal();
                }
            } else {
                const newItem = {
                    id: 'item' + Date.now(),
                    ...itemData,
                    createdAt: new Date().toISOString(),
                    photo: null,
                    photos: [],
                    listings: []
                };

                if (pendingItemPhotos.length > 0) {
                    newItem.photos = pendingItemPhotos.map((p, i) => ({
                        id: 'ph' + Date.now() + i,
                        photo: p,
                        caption: '',
                        order: i
                    }));
                    newItem.photo = newItem.photos[0].photo;
                    newItem.primaryPhotoId = newItem.photos[0].id;
                }

                furnitureItems.push(newItem);
                saveData();
                renderAll();
                hideAddItemModal();
            }
        }

        function handleQuickAdd(e) {
            e.preventDefault();

            const title = document.getElementById('quick-title').value;
            const purchasePrice = parseFloat(document.getElementById('quick-price').value);
            const photoFile = document.getElementById('quick-photo').files[0];

            const newItem = {
                id: 'item' + Date.now(),
                title,
                description: '',
                purchasePrice,
                salePrice: null,
                travelCost: 0,
                materialsCost: 0,
                repairCost: 0,
                status: 'sourced',
                category: 'other',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                photo: null,
                photos: [],
                listings: []
            };

            if (photoFile) {
                compressPhoto(photoFile, 800, 0.75).then(compressed => {
                    newItem.photo = compressed;
                    newItem.photos = [{ id: 'ph' + Date.now(), photo: compressed, caption: '', order: 0 }];
                    newItem.primaryPhotoId = newItem.photos[0].id;
                    furnitureItems.push(newItem);
                    saveData();
                    renderAll();
                    hideQuickAddModal();
                });
            } else {
                furnitureItems.push(newItem);
                saveData();
                renderAll();
                hideQuickAddModal();
            }
        }

        function handleAddErrand(e) {
            e.preventDefault();

            const storeName = document.getElementById('errand-store').value;
            const address = document.getElementById('errand-address').value;
            const shoppingList = document.getElementById('errand-list').value;

            const maxOrder = routeStops.filter(s => !s.completed).reduce((max, s) => Math.max(max, s.order), -1);

            routeStops.push({
                id: 'stop' + Date.now(),
                type: 'errand',
                title: storeName,
                address: address,
                datetime: null,
                notes: shoppingList,
                storeName: storeName,
                shoppingList: shoppingList,
                completed: false,
                order: maxOrder + 1
            });

            saveData();
            renderRouteStops();
            hideErrandModal();
            sendNtfyNotification(
                'Errand Added üõí',
                storeName + (shoppingList ? ' ‚Äî ' + shoppingList : ''),
                'shopping_cart'
            );
        }

        function handleAddPickup(e) {
            e.preventDefault();

            const itemName = document.getElementById('pickup-item').value;
            const address = document.getElementById('pickup-address').value;
            const notes = document.getElementById('pickup-notes').value;

            const maxOrder = routeStops.filter(s => !s.completed).reduce((max, s) => Math.max(max, s.order), -1);

            routeStops.push({
                id: 'stop' + Date.now(),
                type: 'pickup',
                title: 'Pick up: ' + itemName,
                address: address,
                datetime: null,
                notes: notes,
                completed: false,
                order: maxOrder + 1
            });

            saveData();
            renderRouteStops();
            hidePickupModal();
            sendNtfyNotification(
                'Pickup Added üìç',
                'Pick up: ' + itemName + (address ? ' at ' + address : ''),
                'round_pushpin'
            );
        }

        function handleCreateDelivery(e) {
            e.preventDefault();

            const date = document.getElementById('delivery-date').value;
            const time = document.getElementById('delivery-time').value;
            const datetime = new Date(date + 'T' + time).toISOString();

            const customerName = document.getElementById('customer-name').value;
            const itemName = currentDeliveryItem.title;

            const deliveryRequest = {
                id: 'delivery' + Date.now(),
                item: itemName,
                itemId: currentDeliveryItem.id,
                customer: customerName,
                address: document.getElementById('delivery-address').value,
                datetime: datetime,
                price: parseFloat(document.getElementById('final-price').value),
                paymentMethod: document.getElementById('payment-method').value,
                paymentStatus: document.getElementById('payment-status').value,
                sentAt: new Date().toISOString()
            };

            pendingDeliveries.push(deliveryRequest);

            // Auto-add to routeStops
            const maxOrder = routeStops.filter(s => !s.completed).reduce((max, s) => Math.max(max, s.order), -1);
            routeStops.push({
                id: 'stop' + Date.now(),
                type: 'delivery',
                title: 'Deliver ' + itemName + ' to ' + customerName,
                address: deliveryRequest.address,
                datetime: datetime,
                notes: '',
                deliveryId: deliveryRequest.id,
                completed: false,
                order: maxOrder + 1
            });

            // Update item status to pending
            const itemIndex = furnitureItems.findIndex(i => i.id === currentDeliveryItem.id);
            if (itemIndex !== -1) {
                furnitureItems[itemIndex].status = 'pending';
            }

            saveData();
            renderAll();
            hideDeliveryModal();

            const deliveryDate = new Date(datetime);
            sendNotification(
                'Delivery Created',
                itemName + ' to ' + customerName + ' on ' + deliveryDate.toLocaleDateString()
            );
            sendNtfyNotification(
                'New Delivery Scheduled üöö',
                itemName + ' to ' + customerName + ' on ' + deliveryDate.toLocaleDateString(),
                'truck,calendar'
            );
        }

        function handleCompleteDelivery(e) {
            e.preventDefault();

            const mileage = parseFloat(document.getElementById('delivery-mileage').value);
            const mileageCost = mileage * MILEAGE_RATE;
            const notes = document.getElementById('delivery-notes').value;

            const item = furnitureItems.find(i => i.id === currentCompletingDelivery.itemId);
            if (!item) return;

            const totalCost = calculateTotalCost(item) + mileageCost;
            const profit = currentCompletingDelivery.price - totalCost;

            const historyEntry = {
                id: 'history' + Date.now(),
                item: currentCompletingDelivery.item,
                customer: currentCompletingDelivery.customer,
                finalPrice: currentCompletingDelivery.price,
                purchasePrice: item.purchasePrice,
                travelCost: item.travelCost || 0,
                materialsCost: item.materialsCost || 0,
                repairCost: item.repairCost || 0,
                deliveryMileage: mileage,
                deliveryMileageCost: mileageCost,
                totalCost: totalCost,
                profit: profit,
                paymentMethod: currentCompletingDelivery.paymentMethod,
                paymentStatus: currentCompletingDelivery.paymentStatus,
                deliveryDate: currentCompletingDelivery.datetime,
                completedDate: new Date().toISOString(),
                notes: notes,
                photo: item.photo,
                category: item.category || 'other',
                createdAt: item.createdAt || null
            };

            salesHistory.push(historyEntry);

            // Mark route stop as completed
            const routeStop = routeStops.find(s => s.deliveryId === currentCompletingDelivery.id);
            if (routeStop) {
                routeStop.completed = true;
                routeStop.completedAt = new Date().toISOString();
            }

            // Remove from pending deliveries
            pendingDeliveries = pendingDeliveries.filter(d => d.id !== currentCompletingDelivery.id);

            // Remove from inventory
            furnitureItems = furnitureItems.filter(i => i.id !== currentCompletingDelivery.itemId);

            saveData();
            renderAll();
            hideCompleteDeliveryModal();

            sendNotification(
                'Delivery Complete',
                historyEntry.item + ' - Profit: $' + profit.toFixed(2)
            );
            sendNtfyNotification(
                'Delivery Complete ‚úÖ',
                historyEntry.item + ' delivered to ' + historyEntry.customer + ' ‚Äî Profit: $' + profit.toFixed(2),
                'package,white_check_mark'
            );
        }

        // Item Actions
        function editItem(itemId) {
            const item = furnitureItems.find(item => item.id === itemId);
            if (!item) return;

            pendingItemPhotos = [];
            resetPhotoUpload();

            document.getElementById('item-title').value = item.title;
            document.getElementById('item-description').value = item.description || '';
            document.getElementById('item-purchase-price').value = item.purchasePrice;
            document.getElementById('item-sale-price').value = item.salePrice || '';
            document.getElementById('travel-cost').value = item.travelCost || '';
            document.getElementById('materials-cost').value = item.materialsCost || '';
            document.getElementById('repair-cost').value = item.repairCost || '';
            document.getElementById('item-status').value = item.status || 'sourced';
            document.getElementById('item-category').value = item.category || 'other';

            // Show existing photos
            const previewContainer = document.getElementById('item-photo-previews');
            previewContainer.innerHTML = '';
            const photos = getItemPhotos(item);
            photos.forEach((p, i) => {
                const wrapper = document.createElement('div');
                wrapper.style.cssText = 'position: relative; display: inline-block;';
                const thumb = document.createElement('img');
                thumb.src = p.photo;
                thumb.className = 'photo-gallery-thumb';
                thumb.style.cssText = 'width: 50px; height: 50px;';
                wrapper.appendChild(thumb);
                const delBtn = document.createElement('button');
                delBtn.textContent = '‚úï';
                delBtn.style.cssText = 'position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; cursor: pointer; line-height: 1;';
                delBtn.onclick = (e) => { e.stopPropagation(); removeItemPhoto(itemId, p.id); };
                wrapper.appendChild(delBtn);
                previewContainer.appendChild(wrapper);
            });

            document.querySelector('#add-item-modal h3').textContent = 'Edit Item';
            document.querySelector('#add-item-form button[type="submit"]').textContent = 'Update Item';

            window.editingItemId = itemId;
            showAddItemModal();
        }

        function removeItemPhoto(itemId, photoId) {
            const item = furnitureItems.find(i => i.id === itemId);
            if (!item || !item.photos) return;
            item.photos = item.photos.filter(p => p.id !== photoId);
            if (item.photos.length > 0) {
                item.photo = item.photos[0].photo;
                item.primaryPhotoId = item.photos[0].id;
            } else {
                item.photo = null;
                item.primaryPhotoId = null;
            }
            saveData();
            editItem(itemId); // Re-render edit modal
        }

        function deleteItem(itemId) {
            const item = furnitureItems.find(item => item.id === itemId);
            if (confirm('Delete "' + item.title + '"? This cannot be undone.')) {
                furnitureItems = furnitureItems.filter(item => item.id !== itemId);
                saveData();
                renderAll();
            }
        }

        function viewPhoto(itemId) {
            openItemGallery(itemId);
        }

        // Sales History
        function renderSalesHistory() {
            const list = document.getElementById('history-list');
            const emptyState = document.getElementById('history-empty');

            if (salesHistory.length === 0) {
                list.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            list.innerHTML = '';

            const sorted = [...salesHistory].sort((a, b) =>
                new Date(b.completedDate) - new Date(a.completedDate)
            );

            sorted.forEach(sale => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';

                const completedDate = new Date(sale.completedDate);
                const dateStr = completedDate.toLocaleDateString();

                const profitClass = sale.profit >= 0 ? 'positive' : 'negative';

                historyItem.innerHTML = `
                    <div class="history-item-header">
                        <div>
                            <div class="history-item-title">${esc(sale.item)}</div>
                            <div class="history-item-date">${dateStr} ‚Ä¢ ${esc(sale.customer)}</div>
                        </div>
                        <span class="profit-badge ${profitClass}">
                            ${sale.profit >= 0 ? '+' : ''}$${sale.profit.toFixed(2)}
                        </span>
                    </div>
                    <div class="cost-breakdown">
                        <div class="cost-row">
                            <span>Purchase:</span>
                            <span>$${sale.purchasePrice.toFixed(2)}</span>
                        </div>
                        ${sale.travelCost ? '<div class="cost-row"><span>Travel:</span><span>$' + sale.travelCost.toFixed(2) + '</span></div>' : ''}
                        ${sale.materialsCost ? '<div class="cost-row"><span>Materials:</span><span>$' + sale.materialsCost.toFixed(2) + '</span></div>' : ''}
                        ${sale.repairCost ? '<div class="cost-row"><span>Repairs:</span><span>$' + sale.repairCost.toFixed(2) + '</span></div>' : ''}
                        ${sale.deliveryMileageCost ? '<div class="cost-row"><span>Delivery (' + sale.deliveryMileage + ' mi):</span><span>$' + sale.deliveryMileageCost.toFixed(2) + '</span></div>' : ''}
                        <div class="cost-row total">
                            <span>Total Cost:</span>
                            <span>$${sale.totalCost.toFixed(2)}</span>
                        </div>
                        <div class="cost-row" style="color: #1e40af; font-weight: 600;">
                            <span>Sale Price:</span>
                            <span>$${sale.finalPrice.toFixed(2)}</span>
                        </div>
                    </div>
                    ${sale.notes ? '<div style="margin-top: 12px; color: #6b7280; font-size: 0.875rem; font-style: italic;">' + esc(sale.notes) + '</div>' : ''}
                `;

                list.appendChild(historyItem);
            });
        }

        // ========== AIRBNB: SEED DEFAULTS ==========

        function seedAirbnbDefaults() {
            if (cleaningTemplates.length === 0) {
                cleaningTemplates.push({
                    id: 'ct' + Date.now(),
                    name: 'Standard Turnover',
                    items: [
                        { id: 'ci1', text: 'Wash all dishes and put away', room: 'Kitchen' },
                        { id: 'ci2', text: 'Wipe countertops and stovetop', room: 'Kitchen' },
                        { id: 'ci3', text: 'Clean microwave inside and out', room: 'Kitchen' },
                        { id: 'ci4', text: 'Empty and clean refrigerator', room: 'Kitchen' },
                        { id: 'ci5', text: 'Scrub toilet, sink, and tub/shower', room: 'Bathroom' },
                        { id: 'ci6', text: 'Replace towels and bath mat', room: 'Bathroom' },
                        { id: 'ci7', text: 'Refill soap, shampoo, toilet paper', room: 'Bathroom' },
                        { id: 'ci8', text: 'Clean mirror', room: 'Bathroom' },
                        { id: 'ci9', text: 'Strip and remake bed with fresh linens', room: 'Bedroom' },
                        { id: 'ci10', text: 'Dust nightstands and surfaces', room: 'Bedroom' },
                        { id: 'ci11', text: 'Check under bed for left items', room: 'Bedroom' },
                        { id: 'ci12', text: 'Vacuum/mop all floors', room: 'General' },
                        { id: 'ci13', text: 'Empty all trash cans', room: 'General' },
                        { id: 'ci14', text: 'Wipe light switches and door handles', room: 'General' },
                        { id: 'ci15', text: 'Check all lights working', room: 'General' }
                    ]
                });
                saveData();
            }

            if (messageTemplates.length === 0) {
                messageTemplates = [
                    {
                        id: 'mt1',
                        name: 'Check-in Instructions',
                        category: 'checkin',
                        body: 'Hi [GUEST_NAME]! Welcome to our place. Here are your check-in details:\n\nAddress: [ADDRESS]\nDoor Code: [DOOR_CODE]\nWiFi Network: [WIFI_NAME]\nWiFi Password: [WIFI_PASSWORD]\nParking: [PARKING_INFO]\n\nCheck-in is at [CHECKIN_TIME]. Let me know if you need anything!'
                    },
                    {
                        id: 'mt2',
                        name: 'Welcome Message',
                        category: 'welcome',
                        body: 'Hi [GUEST_NAME]! Just wanted to welcome you and make sure you got settled in okay. Everything in the house should be ready for you.\n\nFeel free to reach out if you have any questions. Enjoy your stay!'
                    },
                    {
                        id: 'mt3',
                        name: 'Checkout Reminder',
                        category: 'checkout',
                        body: 'Hi [GUEST_NAME]! Just a friendly reminder that checkout is at [CHECKOUT_TIME] tomorrow.\n\nBefore you leave, please:\n- Start a load of towels in the washer\n- Take out any trash\n- Lock the door behind you\n\nThank you for staying with us! Safe travels.'
                    },
                    {
                        id: 'mt4',
                        name: 'Post-Stay Review Request',
                        category: 'review',
                        body: 'Hi [GUEST_NAME]! Thank you so much for staying with us. We hope you had a wonderful time!\n\nIf you enjoyed your stay, we would really appreciate a review on Airbnb. It helps us a lot as hosts.\n\nWe have already left you a 5-star review. Hope to host you again!'
                    },
                    {
                        id: 'mt5',
                        name: 'Problem Response',
                        category: 'problem',
                        body: 'Hi [GUEST_NAME], I am so sorry to hear about [ISSUE]. That is definitely not the experience we want you to have.\n\nI am [ACTION_PLAN]. In the meantime, please [INTERIM_SOLUTION].\n\nThank you for your patience and I will keep you updated.'
                    }
                ];
                saveData();
            }
        }

        // ========== AIRBNB: SUB-TAB SWITCHING ==========

        function switchAirbnbSubtab(subtab, btn) {
            currentAirbnbSubtab = subtab;
            document.querySelectorAll('.airbnb-subtab').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.airbnb-sub-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('airbnb-' + subtab + '-sub').classList.remove('hidden');
        }

        // ========== AIRBNB: SUPPLY INVENTORY ==========

        const SUPPLY_CATEGORY_LABELS = {
            bathroom: 'Bathroom', kitchen: 'Kitchen', cleaning: 'Cleaning', linens: 'Linens', other: 'Other'
        };

        function renderAirbnbSupplies() {
            const grid = document.getElementById('supply-grid');
            const empty = document.getElementById('supply-empty');
            const banner = document.getElementById('low-stock-banner');

            let items = airbnbSupplies;
            if (currentSupplyCategoryFilter !== 'all') {
                items = items.filter(s => s.category === currentSupplyCategoryFilter);
            }

            // Low-stock banner
            const belowPar = airbnbSupplies.filter(s => s.currentQty < s.parLevel);
            if (belowPar.length > 0) {
                banner.classList.remove('hidden');
                document.getElementById('low-stock-text').textContent = belowPar.length + ' item' + (belowPar.length > 1 ? 's' : '') + ' below par level';
            } else {
                banner.classList.add('hidden');
            }

            // Stats
            document.getElementById('supply-total-items').textContent = airbnbSupplies.length;
            document.getElementById('supply-below-par').textContent = belowPar.length;
            const cats = new Set(airbnbSupplies.map(s => s.category));
            document.getElementById('supply-categories').textContent = cats.size;

            if (items.length === 0) {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            grid.innerHTML = '';

            items.forEach(supply => {
                const card = document.createElement('div');
                card.className = 'supply-card';
                const ratio = supply.parLevel > 0 ? supply.currentQty / supply.parLevel : 1;
                const qtyClass = ratio >= 1 ? 'ok' : ratio >= 0.5 ? 'low' : 'critical';

                card.innerHTML = `
                    <div class="supply-card-header">
                        <div class="supply-card-name">${supply.name}</div>
                        <span class="supply-card-category">${SUPPLY_CATEGORY_LABELS[supply.category] || supply.category}</span>
                    </div>
                    <div class="supply-qty-row">
                        <button class="qty-btn" onclick="adjustSupplyQty('${supply.id}', -1)">‚àí</button>
                        <div class="supply-qty-display ${qtyClass}">${supply.currentQty}</div>
                        <button class="qty-btn" onclick="adjustSupplyQty('${supply.id}', 1)">+</button>
                        <span class="supply-par">/ ${supply.parLevel} ${supply.unit || ''}</span>
                    </div>
                    <div class="supply-card-actions">
                        <button style="background: #f59e0b; color: white;" onclick="editSupply('${supply.id}')">‚úèÔ∏è Edit</button>
                        <button style="background: #ef4444; color: white;" onclick="deleteSupply('${supply.id}')">üóëÔ∏è</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function filterSupplyCategory(cat, btn) {
            currentSupplyCategoryFilter = cat;
            document.querySelectorAll('#supply-category-filter .status-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderAirbnbSupplies();
        }

        function adjustSupplyQty(id, delta) {
            const supply = airbnbSupplies.find(s => s.id === id);
            if (!supply) return;
            supply.currentQty = Math.max(0, supply.currentQty + delta);
            if (delta > 0) {
                supply.lastRestocked = new Date().toISOString();
            }
            saveData();
            renderAirbnbSupplies();
        }

        function showAddSupplyModal() {
            editingSupplyId = null;
            document.getElementById('supply-modal-title').textContent = 'Add Supply';
            document.getElementById('supply-submit-btn').textContent = 'Add Supply';
            document.getElementById('add-supply-form').reset();
            document.getElementById('add-supply-modal').classList.remove('hidden');
        }

        function hideAddSupplyModal() {
            document.getElementById('add-supply-modal').classList.add('hidden');
            document.getElementById('add-supply-form').reset();
            editingSupplyId = null;
        }

        function editSupply(id) {
            const supply = airbnbSupplies.find(s => s.id === id);
            if (!supply) return;
            editingSupplyId = id;
            document.getElementById('supply-modal-title').textContent = 'Edit Supply';
            document.getElementById('supply-submit-btn').textContent = 'Update Supply';
            document.getElementById('supply-name').value = supply.name;
            document.getElementById('supply-category').value = supply.category;
            document.getElementById('supply-unit').value = supply.unit || '';
            document.getElementById('supply-qty').value = supply.currentQty;
            document.getElementById('supply-par').value = supply.parLevel;
            document.getElementById('add-supply-modal').classList.remove('hidden');
        }

        function deleteSupply(id) {
            const supply = airbnbSupplies.find(s => s.id === id);
            if (!supply) return;
            if (!confirm('Delete "' + supply.name + '"?')) return;
            airbnbSupplies = airbnbSupplies.filter(s => s.id !== id);
            saveData();
            renderAirbnbSupplies();
        }

        function handleAddSupply(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('supply-name').value,
                category: document.getElementById('supply-category').value,
                unit: document.getElementById('supply-unit').value,
                currentQty: parseInt(document.getElementById('supply-qty').value) || 0,
                parLevel: parseInt(document.getElementById('supply-par').value) || 1,
                lastRestocked: new Date().toISOString()
            };

            if (editingSupplyId) {
                const idx = airbnbSupplies.findIndex(s => s.id === editingSupplyId);
                if (idx !== -1) {
                    airbnbSupplies[idx] = { ...airbnbSupplies[idx], ...data };
                }
            } else {
                airbnbSupplies.push({
                    id: 'sup' + Date.now(),
                    ...data,
                    restockHistory: []
                });
            }

            saveData();
            renderAirbnbSupplies();
            hideAddSupplyModal();
        }

        // ========== AIRBNB: SHOPPING LIST ==========

        function generateShoppingList() {
            const belowPar = airbnbSupplies.filter(s => s.currentQty < s.parLevel);
            const content = document.getElementById('shopping-list-content');

            if (belowPar.length === 0) {
                content.innerHTML = '<div style="text-align:center; padding: 20px; color: #6b7280;">All supplies are at or above par level!</div>';
            } else {
                let html = '<div style="margin-bottom: 12px; font-size: 0.9rem; color: #6b7280;">' + belowPar.length + ' item(s) to restock:</div>';
                belowPar.forEach(s => {
                    const need = s.parLevel - s.currentQty;
                    html += `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                        <span style="font-weight: 600;">${s.name}</span>
                        <span style="color: #6b7280; font-size: 0.85rem;">Have: ${s.currentQty} | Need: ${need} | Par: ${s.parLevel}</span>
                    </div>`;
                });
                content.innerHTML = html;
            }

            document.getElementById('shopping-list-modal').classList.remove('hidden');
        }

        function hideShoppingListModal() {
            document.getElementById('shopping-list-modal').classList.add('hidden');
        }

        function copyShoppingList() {
            const belowPar = airbnbSupplies.filter(s => s.currentQty < s.parLevel);
            if (belowPar.length === 0) return;
            const text = 'Shopping List:\n' + belowPar.map(s => {
                const need = s.parLevel - s.currentQty;
                return '- ' + s.name + ' (need ' + need + ' ' + (s.unit || 'units') + ')';
            }).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                alert('Shopping list copied to clipboard!');
            });
        }

        function addShoppingListToRoute() {
            const belowPar = airbnbSupplies.filter(s => s.currentQty < s.parLevel);
            if (belowPar.length === 0) return;
            const notes = belowPar.map(s => {
                const need = s.parLevel - s.currentQty;
                return s.name + ' (need ' + need + ')';
            }).join(', ');

            const maxOrder = routeStops.filter(s => !s.completed).reduce((max, s) => Math.max(max, s.order), -1);
            routeStops.push({
                id: 'stop' + Date.now(),
                type: 'errand',
                title: 'Airbnb Supply Restock',
                address: '',
                datetime: null,
                notes: notes,
                completed: false,
                order: maxOrder + 1
            });

            saveData();
            renderRouteStops();
            hideShoppingListModal();
            alert('Added "Airbnb Supply Restock" to your route!');
        }

        // ========== AIRBNB: CLEANING CHECKLISTS ==========

        function renderCleaningTemplates() {
            const list = document.getElementById('cleaning-templates-list');
            const empty = document.getElementById('cleaning-templates-empty');

            if (cleaningTemplates.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            list.innerHTML = '';

            cleaningTemplates.forEach(tmpl => {
                const card = document.createElement('div');
                card.className = 'template-card';
                card.innerHTML = `
                    <div class="template-card-info">
                        <h4>${tmpl.name}</h4>
                        <p>${tmpl.items.length} items</p>
                    </div>
                    <div class="template-card-actions">
                        <button class="btn btn-primary" style="padding: 6px 14px; font-size: 0.85rem;" onclick="startChecklist('${tmpl.id}')">‚ñ∂ Start</button>
                        <button class="btn btn-secondary" style="padding: 6px 14px; font-size: 0.85rem;" onclick="editCleaningTemplate('${tmpl.id}')">‚úèÔ∏è</button>
                        <button style="padding: 6px 14px; font-size: 0.85rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;" onclick="deleteCleaningTemplate('${tmpl.id}')">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function renderCleaningLogs() {
            const list = document.getElementById('cleaning-log-list');
            const recent = [...cleaningLogs].sort((a, b) => new Date(b.completedAt || b.date) - new Date(a.completedAt || a.date)).slice(0, 10);

            if (recent.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding: 16px; color: #6b7280; font-size: 0.9rem;">No cleaning logs yet.</div>';
                return;
            }

            list.innerHTML = '';
            recent.forEach(log => {
                const tmpl = cleaningTemplates.find(t => t.id === log.templateId);
                const dateStr = new Date(log.completedAt || log.date).toLocaleDateString();
                const checkedCount = log.items.filter(i => i.checked).length;
                const div = document.createElement('div');
                div.className = 'cleaning-log-item';
                const photoCount = (log.photos || []).length;
                div.style.cursor = photoCount > 0 ? 'pointer' : 'default';
                if (photoCount > 0) div.onclick = () => viewCleaningLogPhotos(log.id);
                div.innerHTML = `
                    <div class="log-info">${tmpl ? tmpl.name : 'Unknown Template'} ‚Äî ${checkedCount}/${log.items.length} items${photoCount > 0 ? ' ‚Ä¢ üì∏ ' + photoCount + ' photos' : ''}</div>
                    <div class="log-date">${dateStr} ${log.completed ? '‚úÖ' : '‚è≥'}</div>
                `;
                list.appendChild(div);
            });
        }

        function showCreateCleaningTemplateModal() {
            window.editingCleaningTemplateId = null;
            document.getElementById('cleaning-template-modal-title').textContent = 'Create Cleaning Template';
            document.getElementById('ct-name').value = '';
            const editor = document.getElementById('ct-items-editor');
            editor.innerHTML = '';
            addCleaningTemplateItem();
            addCleaningTemplateItem();
            addCleaningTemplateItem();
            document.getElementById('cleaning-template-modal').classList.remove('hidden');
        }

        function hideCleaningTemplateModal() {
            document.getElementById('cleaning-template-modal').classList.add('hidden');
        }

        function addCleaningTemplateItem() {
            const editor = document.getElementById('ct-items-editor');
            const row = document.createElement('div');
            row.className = 'checklist-template-item-row';
            row.innerHTML = `
                <input type="text" placeholder="Task description" required>
                <select>
                    <option value="Kitchen">Kitchen</option>
                    <option value="Bathroom">Bathroom</option>
                    <option value="Bedroom">Bedroom</option>
                    <option value="Living Room">Living Room</option>
                    <option value="General">General</option>
                </select>
                <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">‚úï</button>
            `;
            editor.appendChild(row);
        }

        function editCleaningTemplate(id) {
            const tmpl = cleaningTemplates.find(t => t.id === id);
            if (!tmpl) return;
            window.editingCleaningTemplateId = id;
            document.getElementById('cleaning-template-modal-title').textContent = 'Edit Cleaning Template';
            document.getElementById('ct-name').value = tmpl.name;
            const editor = document.getElementById('ct-items-editor');
            editor.innerHTML = '';
            tmpl.items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'checklist-template-item-row';
                row.innerHTML = `
                    <input type="text" value="${item.text}" required>
                    <select>
                        <option value="Kitchen" ${item.room === 'Kitchen' ? 'selected' : ''}>Kitchen</option>
                        <option value="Bathroom" ${item.room === 'Bathroom' ? 'selected' : ''}>Bathroom</option>
                        <option value="Bedroom" ${item.room === 'Bedroom' ? 'selected' : ''}>Bedroom</option>
                        <option value="Living Room" ${item.room === 'Living Room' ? 'selected' : ''}>Living Room</option>
                        <option value="General" ${item.room === 'General' ? 'selected' : ''}>General</option>
                    </select>
                    <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">‚úï</button>
                `;
                editor.appendChild(row);
            });
            document.getElementById('cleaning-template-modal').classList.remove('hidden');
        }

        function handleSaveCleaningTemplate(e) {
            e.preventDefault();
            const name = document.getElementById('ct-name').value;
            const rows = document.querySelectorAll('#ct-items-editor .checklist-template-item-row');
            const items = [];
            rows.forEach((row, i) => {
                const text = row.querySelector('input').value.trim();
                const room = row.querySelector('select').value;
                if (text) {
                    items.push({ id: 'ci' + Date.now() + i, text, room });
                }
            });

            if (items.length === 0) {
                alert('Add at least one checklist item.');
                return;
            }

            if (window.editingCleaningTemplateId) {
                const idx = cleaningTemplates.findIndex(t => t.id === window.editingCleaningTemplateId);
                if (idx !== -1) {
                    cleaningTemplates[idx].name = name;
                    cleaningTemplates[idx].items = items;
                }
            } else {
                cleaningTemplates.push({ id: 'ct' + Date.now(), name, items });
            }

            saveData();
            renderCleaningTemplates();
            hideCleaningTemplateModal();
        }

        function deleteCleaningTemplate(id) {
            if (!confirm('Delete this cleaning template?')) return;
            cleaningTemplates = cleaningTemplates.filter(t => t.id !== id);
            saveData();
            renderCleaningTemplates();
        }

        function startChecklist(templateId) {
            const tmpl = cleaningTemplates.find(t => t.id === templateId);
            if (!tmpl) return;

            activeChecklistLog = {
                id: 'cl' + Date.now(),
                templateId: templateId,
                date: new Date().toISOString(),
                items: tmpl.items.map(item => ({ id: item.id, checked: false, note: '' })),
                completed: false,
                completedAt: null,
                notes: '',
                photos: []
            };

            renderActiveChecklistWithPhotos();
            document.getElementById('active-checklist-area').classList.remove('hidden');
        }

        function renderActiveChecklist(tmpl) {
            renderActiveChecklistWithPhotos();
        }

        function toggleChecklistItem(itemId) {
            if (!activeChecklistLog) return;
            const logItem = activeChecklistLog.items.find(i => i.id === itemId);
            if (logItem) {
                logItem.checked = !logItem.checked;
                renderActiveChecklistWithPhotos();
            }
        }

        function updateChecklistNote(itemId, note) {
            if (!activeChecklistLog) return;
            const logItem = activeChecklistLog.items.find(i => i.id === itemId);
            if (logItem) logItem.note = note;
        }

        function completeActiveChecklist() {
            if (!activeChecklistLog) return;
            activeChecklistLog.completed = true;
            activeChecklistLog.completedAt = new Date().toISOString();
            cleaningLogs.push(activeChecklistLog);
            activeChecklistLog = null;
            saveData();
            document.getElementById('active-checklist-area').classList.add('hidden');
            renderCleaningLogs();
        }

        function cancelActiveChecklist() {
            activeChecklistLog = null;
            document.getElementById('active-checklist-area').classList.add('hidden');
        }

        // ========== AIRBNB: MESSAGE TEMPLATES ==========

        const MSG_CATEGORY_LABELS = {
            checkin: 'Check-in', checkout: 'Checkout', welcome: 'Welcome',
            review: 'Review', problem: 'Problem', other: 'Other'
        };

        function renderMessageTemplates() {
            const grid = document.getElementById('msg-template-grid');
            const empty = document.getElementById('msg-templates-empty');

            let items = messageTemplates;
            if (currentMsgCategoryFilter !== 'all') {
                items = items.filter(t => t.category === currentMsgCategoryFilter);
            }

            if (items.length === 0) {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            grid.innerHTML = '';

            items.forEach(tmpl => {
                const card = document.createElement('div');
                card.className = 'msg-template-card';
                card.innerHTML = `
                    <h4>${tmpl.name}</h4>
                    <span class="msg-category-tag">${MSG_CATEGORY_LABELS[tmpl.category] || tmpl.category}</span>
                    <div class="msg-preview">${tmpl.body}</div>
                    <div class="msg-template-card-actions">
                        <button style="background: #1e40af; color: white;" onclick="event.stopPropagation(); useMessageTemplate('${tmpl.id}')">üìã Use</button>
                        <button style="background: #f59e0b; color: white;" onclick="event.stopPropagation(); editMessageTemplate('${tmpl.id}')">‚úèÔ∏è</button>
                        <button style="background: #ef4444; color: white;" onclick="event.stopPropagation(); deleteMessageTemplate('${tmpl.id}')">üóëÔ∏è</button>
                    </div>
                `;
                card.onclick = () => useMessageTemplate(tmpl.id);
                grid.appendChild(card);
            });
        }

        function filterMsgCategory(cat, btn) {
            currentMsgCategoryFilter = cat;
            document.querySelectorAll('#msg-category-filter .status-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderMessageTemplates();
        }

        function showAddMessageTemplateModal() {
            editingMsgTemplateId = null;
            document.getElementById('msg-template-modal-title').textContent = 'Add Message Template';
            document.getElementById('mt-submit-btn').textContent = 'Add Template';
            document.getElementById('msg-template-form').reset();
            document.getElementById('msg-template-modal').classList.remove('hidden');
        }

        function hideMessageTemplateModal() {
            document.getElementById('msg-template-modal').classList.add('hidden');
            editingMsgTemplateId = null;
        }

        function editMessageTemplate(id) {
            const tmpl = messageTemplates.find(t => t.id === id);
            if (!tmpl) return;
            editingMsgTemplateId = id;
            document.getElementById('msg-template-modal-title').textContent = 'Edit Message Template';
            document.getElementById('mt-submit-btn').textContent = 'Update Template';
            document.getElementById('mt-name').value = tmpl.name;
            document.getElementById('mt-category').value = tmpl.category;
            document.getElementById('mt-body').value = tmpl.body;
            document.getElementById('msg-template-modal').classList.remove('hidden');
        }

        function deleteMessageTemplate(id) {
            if (!confirm('Delete this message template?')) return;
            messageTemplates = messageTemplates.filter(t => t.id !== id);
            saveData();
            renderMessageTemplates();
        }

        function handleSaveMessageTemplate(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('mt-name').value,
                category: document.getElementById('mt-category').value,
                body: document.getElementById('mt-body').value
            };

            if (editingMsgTemplateId) {
                const idx = messageTemplates.findIndex(t => t.id === editingMsgTemplateId);
                if (idx !== -1) {
                    messageTemplates[idx] = { ...messageTemplates[idx], ...data };
                }
            } else {
                messageTemplates.push({ id: 'mt' + Date.now(), ...data });
            }

            saveData();
            renderMessageTemplates();
            hideMessageTemplateModal();
        }

        function useMessageTemplate(id) {
            const tmpl = messageTemplates.find(t => t.id === id);
            if (!tmpl) return;
            currentUseMsgTemplate = tmpl;

            document.getElementById('use-msg-title').textContent = tmpl.name;

            // Extract placeholders
            const placeholders = [];
            const regex = /\[([A-Z_]+)\]/g;
            let match;
            const seen = new Set();
            while ((match = regex.exec(tmpl.body)) !== null) {
                if (!seen.has(match[1])) {
                    placeholders.push(match[1]);
                    seen.add(match[1]);
                }
            }

            const container = document.getElementById('use-msg-placeholders');
            if (placeholders.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; font-size: 0.9rem;">No placeholders in this template.</p>';
            } else {
                container.innerHTML = placeholders.map(p => `
                    <div class="placeholder-field">
                        <label>${p.replace(/_/g, ' ')}</label>
                        <input type="text" data-placeholder="${p}" oninput="updateMsgPreview()" placeholder="Enter ${p.replace(/_/g, ' ').toLowerCase()}">
                    </div>
                `).join('');
            }

            updateMsgPreview();
            document.getElementById('use-msg-modal').classList.remove('hidden');
        }

        function updateMsgPreview() {
            if (!currentUseMsgTemplate) return;
            let body = currentUseMsgTemplate.body;
            const inputs = document.querySelectorAll('#use-msg-placeholders input[data-placeholder]');
            inputs.forEach(input => {
                const ph = input.dataset.placeholder;
                const val = input.value || '[' + ph + ']';
                body = body.split('[' + ph + ']').join(val);
            });
            document.getElementById('use-msg-preview').textContent = body;
        }

        function hideUseMsgModal() {
            document.getElementById('use-msg-modal').classList.add('hidden');
            currentUseMsgTemplate = null;
        }

        function copyMessageToClipboard() {
            const text = document.getElementById('use-msg-preview').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Message copied to clipboard!');
            });
        }

        // ========== MAINTENANCE LOG ==========

        function renderMaintenanceLog() {
            const list = document.getElementById('maintenance-list');
            const empty = document.getElementById('maintenance-empty');

            let items = maintenanceLog;
            if (currentMaintStatusFilter !== 'all') {
                items = items.filter(m => m.status === currentMaintStatusFilter);
            }

            if (items.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            list.innerHTML = '';

            const sorted = [...items].sort((a, b) => new Date(b.date) - new Date(a.date));
            sorted.forEach(m => {
                const statusLabels = { reported: 'Reported', 'in-progress': 'In Progress', fixed: 'Fixed', 'awaiting-parts': 'Awaiting Parts' };
                const card = document.createElement('div');
                card.className = 'maint-card';
                card.innerHTML = `
                    <div class="maint-header">
                        <div>
                            <span class="maint-issue">${esc(m.issue)}</span>
                            <span class="maint-status-badge ${m.status}">${statusLabels[m.status] || m.status}</span>
                        </div>
                        <div>
                            ${m.cost ? `<span style="font-weight: 600; color: #dc2626; margin-right: 8px;">$${m.cost.toFixed(2)}</span>` : ''}
                            <button style="background: #dbeafe; color: #1e40af; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; margin-right: 4px;" onclick="editMaintenance('${m.id}')">‚úèÔ∏è</button>
                            <button style="background: #fee2e2; color: #dc2626; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem;" onclick="deleteMaintenance('${m.id}')">‚úï</button>
                        </div>
                    </div>
                    <div class="maint-meta">${m.date} ${m.vendor ? '‚Ä¢ ' + m.vendor : ''}</div>
                    ${m.description ? `<div style="font-size: 0.85rem; color: #374151; margin-top: 4px;">${esc(m.description)}</div>` : ''}
                    ${m.photo ? `<img src="${m.photo}" class="maint-photo" style="margin-top: 8px;" onclick="viewMaintenancePhoto('${m.id}')">` : ''}
                `;
                list.appendChild(card);
            });
        }

        function filterMaintenanceStatus(status, btn) {
            currentMaintStatusFilter = status;
            document.querySelectorAll('#maint-status-filter .status-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderMaintenanceLog();
        }

        function showAddMaintenanceModal() {
            editingMaintenanceId = null;
            document.getElementById('add-maintenance-form').reset();
            document.getElementById('maint-modal-title').textContent = 'Report Maintenance Issue';
            document.getElementById('maint-submit-btn').textContent = 'Report Issue';
            document.getElementById('maint-photo-text').textContent = 'Click to add photo';
            document.querySelector('#add-maintenance-modal .photo-upload-area').classList.remove('has-file');
            document.getElementById('add-maintenance-modal').classList.remove('hidden');
        }

        function hideMaintenanceModal() {
            document.getElementById('add-maintenance-modal').classList.add('hidden');
            editingMaintenanceId = null;
        }

        function editMaintenance(id) {
            const m = maintenanceLog.find(x => x.id === id);
            if (!m) return;
            editingMaintenanceId = id;
            document.getElementById('maint-issue').value = m.issue;
            document.getElementById('maint-description').value = m.description || '';
            document.getElementById('maint-status-select').value = m.status;
            document.getElementById('maint-cost').value = m.cost || '';
            document.getElementById('maint-vendor').value = m.vendor || '';
            document.getElementById('maint-modal-title').textContent = 'Edit Maintenance Issue';
            document.getElementById('maint-submit-btn').textContent = 'Update Issue';
            document.getElementById('add-maintenance-modal').classList.remove('hidden');
        }

        async function handleAddMaintenance(e) {
            e.preventDefault();
            const data = {
                issue: document.getElementById('maint-issue').value,
                description: document.getElementById('maint-description').value,
                status: document.getElementById('maint-status-select').value,
                cost: parseFloat(document.getElementById('maint-cost').value) || 0,
                vendor: document.getElementById('maint-vendor').value
            };

            const photoFile = document.getElementById('maint-photo-input').files[0];
            let photo = null;
            if (photoFile) {
                photo = await compressPhoto(photoFile, 600, 0.7);
            }

            if (editingMaintenanceId) {
                const idx = maintenanceLog.findIndex(m => m.id === editingMaintenanceId);
                if (idx !== -1) {
                    maintenanceLog[idx] = { ...maintenanceLog[idx], ...data };
                    if (photo) maintenanceLog[idx].photo = photo;
                }
            } else {
                maintenanceLog.push({
                    id: 'maint' + Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    ...data,
                    photo: photo,
                    completedDate: null
                });
            }

            saveData();
            renderMaintenanceLog();
            hideMaintenanceModal();
        }

        function deleteMaintenance(id) {
            if (!confirm('Delete this maintenance issue?')) return;
            maintenanceLog = maintenanceLog.filter(m => m.id !== id);
            saveData();
            renderMaintenanceLog();
        }

        function viewMaintenancePhoto(id) {
            const m = maintenanceLog.find(x => x.id === id);
            if (!m || !m.photo) return;
            galleryCurrentPhotos = [{ photo: m.photo, caption: m.issue }];
            galleryCurrentIndex = 0;
            showGalleryModal(m.issue);
        }

        // ========== GUEST GUIDEBOOK ==========

        const DEFAULT_GUIDEBOOK_SECTIONS = [
            { title: 'WiFi & Internet', content: 'Network: \nPassword: ' },
            { title: 'Thermostat', content: 'How to adjust the thermostat...' },
            { title: 'Appliances', content: 'Washer/Dryer instructions...\nDishwasher instructions...\nCoffee maker...' },
            { title: 'House Rules', content: '1. No smoking\n2. No parties\n3. Quiet hours: 10pm - 8am\n4. Lock up when leaving' },
            { title: 'Local Recommendations', content: 'Restaurants:\n\nGrocery Stores:\n\nAttractions:\n' },
            { title: 'Emergency Contacts', content: 'Host: \nMaintenance: \nEmergency: 911' }
        ];

        function renderGuidebook() {
            const container = document.getElementById('guidebook-sections');
            const empty = document.getElementById('guidebook-empty');
            const nameInput = document.getElementById('guidebook-property-name');

            nameInput.value = guestGuidebook.propertyName || '';

            if (guestGuidebook.sections.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            container.innerHTML = '';

            guestGuidebook.sections.sort((a, b) => (a.order || 0) - (b.order || 0)).forEach((section, i) => {
                const div = document.createElement('div');
                div.className = 'guidebook-section';
                if (guidebookEditMode) {
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <input type="text" value="${section.title}" onchange="updateGuidebookTitle('${section.id}', this.value)" style="font-size: 1rem; font-weight: 600; color: #1e40af; border: 1px solid #d1d5db; border-radius: 4px; padding: 4px 8px; flex: 1;">
                            <div style="display: flex; gap: 4px; margin-left: 8px;">
                                ${i > 0 ? `<button onclick="moveGuidebookSection('${section.id}', -1)" style="background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚Üë</button>` : ''}
                                ${i < guestGuidebook.sections.length - 1 ? `<button onclick="moveGuidebookSection('${section.id}', 1)" style="background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚Üì</button>` : ''}
                                <button onclick="deleteGuidebookSection('${section.id}')" style="background: #fee2e2; color: #dc2626; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                            </div>
                        </div>
                        <textarea class="guidebook-edit-area" onchange="updateGuidebookContent('${section.id}', this.value)">${section.content}</textarea>
                    `;
                } else {
                    div.innerHTML = `
                        <h4>${section.title}</h4>
                        <div class="guidebook-content">${section.content}</div>
                    `;
                }
                container.appendChild(div);
            });
        }

        function toggleGuidebookEdit() {
            guidebookEditMode = !guidebookEditMode;
            const btn = document.getElementById('guidebook-edit-toggle');
            btn.textContent = guidebookEditMode ? 'üëÅÔ∏è View Mode' : '‚úèÔ∏è Edit Mode';
            btn.style.background = guidebookEditMode ? '#1e40af' : '#6b7280';
            renderGuidebook();
        }

        function addGuidebookSection() {
            if (guestGuidebook.sections.length === 0) {
                DEFAULT_GUIDEBOOK_SECTIONS.forEach((s, i) => {
                    guestGuidebook.sections.push({
                        id: 'gs' + Date.now() + i,
                        title: s.title,
                        content: s.content,
                        order: i
                    });
                });
            } else {
                guestGuidebook.sections.push({
                    id: 'gs' + Date.now(),
                    title: 'New Section',
                    content: '',
                    order: guestGuidebook.sections.length
                });
            }
            guidebookEditMode = true;
            document.getElementById('guidebook-edit-toggle').textContent = 'üëÅÔ∏è View Mode';
            document.getElementById('guidebook-edit-toggle').style.background = '#1e40af';
            saveData();
            renderGuidebook();
        }

        function updateGuidebookTitle(id, val) {
            const s = guestGuidebook.sections.find(x => x.id === id);
            if (s) { s.title = val; saveData(); }
        }

        function updateGuidebookContent(id, val) {
            const s = guestGuidebook.sections.find(x => x.id === id);
            if (s) { s.content = val; saveData(); }
        }

        function moveGuidebookSection(id, delta) {
            const idx = guestGuidebook.sections.findIndex(x => x.id === id);
            const newIdx = idx + delta;
            if (newIdx < 0 || newIdx >= guestGuidebook.sections.length) return;
            const temp = guestGuidebook.sections[idx];
            guestGuidebook.sections[idx] = guestGuidebook.sections[newIdx];
            guestGuidebook.sections[newIdx] = temp;
            guestGuidebook.sections.forEach((s, i) => s.order = i);
            saveData();
            renderGuidebook();
        }

        function deleteGuidebookSection(id) {
            if (!confirm('Delete this section?')) return;
            guestGuidebook.sections = guestGuidebook.sections.filter(s => s.id !== id);
            guestGuidebook.sections.forEach((s, i) => s.order = i);
            saveData();
            renderGuidebook();
        }

        function saveGuidebook() {
            guestGuidebook.propertyName = document.getElementById('guidebook-property-name').value;
            saveData();
        }

        function exportGuidebook() {
            const name = guestGuidebook.propertyName || 'Guest Guidebook';
            let html = `<!DOCTYPE html><html><head><title>${name}</title><style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 700px; margin: 40px auto; padding: 20px; color: #1f2937; }
                h1 { color: #1e40af; border-bottom: 2px solid #1e40af; padding-bottom: 8px; }
                h2 { color: #1e40af; margin-top: 24px; }
                .section { background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 16px; white-space: pre-wrap; line-height: 1.6; }
                @media print { body { margin: 20px; } }
            </style></head><body>`;
            html += `<h1>${name}</h1>`;
            guestGuidebook.sections.forEach(s => {
                html += `<h2>${s.title}</h2><div class="section">${s.content}</div>`;
            });
            html += '</body></html>';
            const w = window.open('', '_blank');
            w.document.write(html);
            w.document.close();
        }

        // ========== SOURCING TRIPS ==========

        function renderSourcingTrips() {
            const list = document.getElementById('trips-list');
            const empty = document.getElementById('trips-empty');

            if (sourcingTrips.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
                document.getElementById('total-trips').textContent = '0';
                document.getElementById('total-miles').textContent = '0';
                document.getElementById('total-mileage-deduction').textContent = '$0';
                return;
            }

            empty.classList.add('hidden');

            const totalMiles = sourcingTrips.reduce((sum, t) => sum + (t.miles || 0), 0);
            document.getElementById('total-trips').textContent = sourcingTrips.length;
            document.getElementById('total-miles').textContent = totalMiles.toFixed(1);
            document.getElementById('total-mileage-deduction').textContent = '$' + (totalMiles * MILEAGE_RATE).toFixed(2);

            list.innerHTML = '';
            const sorted = [...sourcingTrips].sort((a, b) => new Date(b.date) - new Date(a.date));
            sorted.forEach(trip => {
                const purposeLabels = { sourcing: 'Sourcing', pickup: 'Pickup', delivery: 'Delivery', supplies: 'Supplies', other: 'Other' };
                const card = document.createElement('div');
                card.className = 'trip-card';
                card.innerHTML = `
                    <div class="trip-info">
                        <div class="trip-route">${esc(trip.fromLocation)} ‚Üí ${esc(trip.toLocation)}</div>
                        <div class="trip-details">${trip.date} ‚Ä¢ ${purposeLabels[trip.purpose] || trip.purpose}${trip.notes ? ' ‚Ä¢ ' + esc(trip.notes) : ''}</div>
                    </div>
                    <div class="trip-miles">${trip.miles} mi</div>
                    <div style="margin-left: 12px; display: flex; gap: 4px;">
                        <button style="background: #dbeafe; color: #1e40af; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem;" onclick="editTrip('${trip.id}')">‚úèÔ∏è</button>
                        <button style="background: #fee2e2; color: #dc2626; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem;" onclick="deleteTrip('${trip.id}')">‚úï</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function showAddTripModal() {
            editingTripId = null;
            document.getElementById('add-trip-form').reset();
            document.getElementById('trip-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('trip-modal-title').textContent = 'Log Sourcing Trip';
            document.getElementById('trip-submit-btn').textContent = 'Log Trip';
            document.getElementById('add-trip-modal').classList.remove('hidden');
        }

        function hideTripModal() {
            document.getElementById('add-trip-modal').classList.add('hidden');
            editingTripId = null;
        }

        function editTrip(id) {
            const t = sourcingTrips.find(x => x.id === id);
            if (!t) return;
            editingTripId = id;
            document.getElementById('trip-date').value = t.date;
            document.getElementById('trip-from').value = t.fromLocation;
            document.getElementById('trip-to').value = t.toLocation;
            document.getElementById('trip-miles').value = t.miles;
            document.getElementById('trip-purpose').value = t.purpose;
            document.getElementById('trip-notes').value = t.notes || '';
            document.getElementById('trip-modal-title').textContent = 'Edit Trip';
            document.getElementById('trip-submit-btn').textContent = 'Update Trip';
            document.getElementById('add-trip-modal').classList.remove('hidden');
        }

        function handleAddTrip(e) {
            e.preventDefault();
            const data = {
                date: document.getElementById('trip-date').value,
                fromLocation: document.getElementById('trip-from').value,
                toLocation: document.getElementById('trip-to').value,
                miles: parseFloat(document.getElementById('trip-miles').value) || 0,
                purpose: document.getElementById('trip-purpose').value,
                notes: document.getElementById('trip-notes').value
            };

            if (editingTripId) {
                const idx = sourcingTrips.findIndex(t => t.id === editingTripId);
                if (idx !== -1) sourcingTrips[idx] = { ...sourcingTrips[idx], ...data };
            } else {
                sourcingTrips.push({ id: 'trip' + Date.now(), ...data });
            }

            saveData();
            renderSourcingTrips();
            hideTripModal();
        }

        function deleteTrip(id) {
            if (!confirm('Delete this trip?')) return;
            sourcingTrips = sourcingTrips.filter(t => t.id !== id);
            saveData();
            renderSourcingTrips();
        }

        function exportTripsCSV() {
            let csv = 'Date,From,To,Miles,Purpose,Notes,Deduction\n';
            sourcingTrips.forEach(t => {
                csv += `${t.date},"${t.fromLocation}","${t.toLocation}",${t.miles},${t.purpose},"${t.notes || ''}",${(t.miles * MILEAGE_RATE).toFixed(2)}\n`;
            });
            const totalMiles = sourcingTrips.reduce((s, t) => s + (t.miles || 0), 0);
            csv += `\nTotal,,,"${totalMiles.toFixed(1)}",,,"${(totalMiles * MILEAGE_RATE).toFixed(2)}"\n`;

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sourcing-trips-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========== MARKETPLACE CROSS-LIST TRACKER ==========

        function showAddListingModal(itemId) {
            document.getElementById('listing-item-id').value = itemId;
            document.getElementById('add-listing-form').reset();
            document.getElementById('listing-item-id').value = itemId;
            const item = furnitureItems.find(i => i.id === itemId);
            if (item && item.salePrice) {
                document.getElementById('listing-price').value = item.salePrice;
            }
            document.getElementById('add-listing-modal').classList.remove('hidden');
        }

        function hideListingModal() {
            document.getElementById('add-listing-modal').classList.add('hidden');
        }

        function handleAddListing(e) {
            e.preventDefault();
            const itemId = document.getElementById('listing-item-id').value;
            const item = furnitureItems.find(i => i.id === itemId);
            if (!item) return;

            if (!item.listings) item.listings = [];
            item.listings.push({
                id: 'list' + Date.now(),
                platform: document.getElementById('listing-platform').value,
                price: parseFloat(document.getElementById('listing-price').value) || 0,
                status: document.getElementById('listing-status').value,
                url: document.getElementById('listing-url').value,
                listingDate: new Date().toISOString().split('T')[0]
            });

            saveData();
            renderFurnitureItems();
            hideListingModal();
        }

        function deleteListing(itemId, listingIndex) {
            const item = furnitureItems.find(i => i.id === itemId);
            if (!item || !item.listings) return;
            item.listings.splice(listingIndex, 1);
            saveData();
            renderFurnitureItems();
        }

        function cycleListingStatus(itemId, listingIndex) {
            const item = furnitureItems.find(i => i.id === itemId);
            if (!item || !item.listings || !item.listings[listingIndex]) return;
            const statuses = ['active', 'sold', 'delisted'];
            const current = statuses.indexOf(item.listings[listingIndex].status);
            item.listings[listingIndex].status = statuses[(current + 1) % statuses.length];
            saveData();
            renderFurnitureItems();
        }

        // ========== MULTI-PHOTO GALLERY ==========

        function openItemGallery(itemId) {
            const item = furnitureItems.find(i => i.id === itemId);
            if (!item) return;
            const photos = getItemPhotos(item);
            if (photos.length === 0) return;
            galleryCurrentPhotos = photos;
            galleryCurrentIndex = 0;
            showGalleryModal(item.title);
        }

        function showGalleryModal(title) {
            document.getElementById('gallery-modal-title').textContent = title;
            updateGalleryDisplay();
            document.getElementById('photo-gallery-modal').classList.remove('hidden');
        }

        function hideGalleryModal() {
            document.getElementById('photo-gallery-modal').classList.add('hidden');
        }

        function updateGalleryDisplay() {
            const photo = galleryCurrentPhotos[galleryCurrentIndex];
            document.getElementById('gallery-modal-img').src = photo.photo;
            document.getElementById('gallery-modal-caption').textContent = photo.caption || '';
            document.getElementById('gallery-modal-counter').textContent = (galleryCurrentIndex + 1) + ' / ' + galleryCurrentPhotos.length;

            const thumbs = document.getElementById('gallery-modal-thumbs');
            thumbs.innerHTML = '';
            galleryCurrentPhotos.forEach((p, i) => {
                const img = document.createElement('img');
                img.src = p.photo;
                img.className = 'photo-gallery-thumb' + (i === galleryCurrentIndex ? ' active' : '');
                img.onclick = () => { galleryCurrentIndex = i; updateGalleryDisplay(); };
                thumbs.appendChild(img);
            });
        }

        function galleryPrev() {
            galleryCurrentIndex = (galleryCurrentIndex - 1 + galleryCurrentPhotos.length) % galleryCurrentPhotos.length;
            updateGalleryDisplay();
        }

        function galleryNext() {
            galleryCurrentIndex = (galleryCurrentIndex + 1) % galleryCurrentPhotos.length;
            updateGalleryDisplay();
        }

        // ========== CLEANING PHOTO VERIFICATION ==========

        function captureCleaningPhoto(room) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.onchange = async function(e) {
                if (e.target.files.length > 0) {
                    const compressed = await compressPhoto(e.target.files[0], 600, 0.7);
                    if (!activeChecklistLog.photos) activeChecklistLog.photos = [];
                    activeChecklistLog.photos.push({
                        id: 'cp' + Date.now(),
                        room: room,
                        photo: compressed,
                        timestamp: new Date().toISOString()
                    });
                    renderActiveChecklistWithPhotos();
                }
            };
            input.click();
        }

        function renderActiveChecklistWithPhotos() {
            if (!activeChecklistLog) return;
            const container = document.getElementById('active-checklist-content');
            const tmpl = cleaningTemplates.find(t => t.id === activeChecklistLog.templateId);
            if (!tmpl) return;

            const rooms = {};
            tmpl.items.forEach(item => {
                if (!rooms[item.room]) rooms[item.room] = [];
                rooms[item.room].push(item);
            });

            let html = '';
            Object.keys(rooms).forEach(room => {
                const roomPhotos = (activeChecklistLog.photos || []).filter(p => p.room === room);
                html += `<div class="checklist-room-group">
                    <div class="checklist-room-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${room}</span>
                        <button class="room-photo-btn ${roomPhotos.length > 0 ? 'has-photo' : ''}" onclick="captureCleaningPhoto('${room}')">
                            üì∏ ${roomPhotos.length > 0 ? roomPhotos.length + ' photo(s)' : 'Add Photo'}
                        </button>
                    </div>`;
                rooms[room].forEach(item => {
                    const logItem = activeChecklistLog.items.find(li => li.id === item.id);
                    const checked = logItem ? logItem.checked : false;
                    const note = logItem ? (logItem.note || '') : '';
                    html += `
                        <div class="checklist-item">
                            <input type="checkbox" ${checked ? 'checked' : ''} onchange="toggleChecklistItem('${item.id}')">
                            <span class="${checked ? 'completed' : ''}">${item.text}</span>
                        </div>
                        <div style="margin-left: 28px; margin-bottom: 8px;">
                            <input type="text" value="${note}" placeholder="Notes..." onchange="updateChecklistNote('${item.id}', this.value)"
                                style="width: 100%; padding: 4px 8px; font-size: 0.8rem; border: 1px solid #e5e7eb; border-radius: 4px;">
                        </div>`;
                });
                if (roomPhotos.length > 0) {
                    html += '<div style="display: flex; gap: 4px; margin: 4px 0 8px 0;">';
                    roomPhotos.forEach(p => {
                        html += `<img src="${p.photo}" class="room-photo-thumb" onclick="viewCleaningPhoto('${p.id}')">`;
                    });
                    html += '</div>';
                }
                html += '</div>';
            });
            container.innerHTML = html;
        }

        function viewCleaningPhoto(photoId) {
            if (!activeChecklistLog || !activeChecklistLog.photos) return;
            const photo = activeChecklistLog.photos.find(p => p.id === photoId);
            if (!photo) return;
            galleryCurrentPhotos = [{ photo: photo.photo, caption: photo.room + ' - ' + new Date(photo.timestamp).toLocaleString() }];
            galleryCurrentIndex = 0;
            showGalleryModal('Cleaning Photo');
        }

        function viewCleaningLogPhotos(logId) {
            const log = cleaningLogs.find(l => l.id === logId);
            if (!log || !log.photos || log.photos.length === 0) return;
            galleryCurrentPhotos = log.photos.map(p => ({
                photo: p.photo,
                caption: p.room + ' - ' + new Date(p.timestamp).toLocaleString()
            }));
            galleryCurrentIndex = 0;
            const tmpl = cleaningTemplates.find(t => t.id === log.templateId);
            showGalleryModal((tmpl ? tmpl.name : 'Cleaning') + ' Photos');
        }

        // ========== EXPORT REPORTS WITH PHOTOS ==========

        function showExportReportModal() {
            document.getElementById('export-report-modal').classList.remove('hidden');
        }

        function hideExportReportModal() {
            document.getElementById('export-report-modal').classList.add('hidden');
        }

        function generateExportReport() {
            let html = `<!DOCTYPE html><html><head><title>Cozy Capital Inventory Report</title><style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; color: #1f2937; }
                h1 { color: #1e40af; border-bottom: 2px solid #1e40af; padding-bottom: 8px; }
                .item { page-break-inside: avoid; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
                .item h3 { color: #1e40af; margin-bottom: 8px; }
                .item img { max-width: 200px; max-height: 150px; border-radius: 4px; margin-right: 8px; margin-bottom: 8px; }
                .photos { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
                .cost-row { display: flex; justify-content: space-between; padding: 2px 0; font-size: 0.9rem; }
                .cost-row.total { font-weight: 700; border-top: 1px solid #e5e7eb; padding-top: 4px; margin-top: 4px; }
                .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 8px; }
                .summary { background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 24px; }
                .summary .row { display: flex; justify-content: space-between; padding: 4px 0; }
                @media print { body { margin: 10px; } .item { border: 1px solid #ccc; } }
            </style></head><body>`;

            html += `<h1>Cozy Capital Inventory Report</h1>`;
            html += `<p style="color: #6b7280;">Generated: ${new Date().toLocaleDateString()}</p>`;

            const totalItems = furnitureItems.length;
            const totalInvested = furnitureItems.reduce((s, i) => s + calculateTotalCost(i), 0);
            const totalRevenue = furnitureItems.reduce((s, i) => s + (i.salePrice || 0), 0);

            html += `<div class="summary">
                <div class="row"><span>Total Items:</span><span>${totalItems}</span></div>
                <div class="row"><span>Total Invested:</span><span>$${totalInvested.toFixed(2)}</span></div>
                <div class="row"><span>Potential Revenue:</span><span>$${totalRevenue.toFixed(2)}</span></div>
                <div class="row" style="font-weight: 700;"><span>Expected Profit:</span><span style="color: ${totalRevenue - totalInvested >= 0 ? '#059669' : '#dc2626'}">$${(totalRevenue - totalInvested).toFixed(2)}</span></div>
            </div>`;

            furnitureItems.forEach(item => {
                const totalCost = calculateTotalCost(item);
                const photos = getItemPhotos(item);
                const aging = getAgingInfo(item);

                html += `<div class="item">`;
                html += `<h3>${item.title} <span class="badge" style="background: ${aging.cls === 'green' ? '#d1fae5' : aging.cls === 'yellow' ? '#fef3c7' : '#fee2e2'};">${aging.label}</span></h3>`;

                if (photos.length > 0) {
                    html += '<div class="photos">';
                    photos.forEach(p => { html += `<img src="${p.photo}" alt="">`; });
                    html += '</div>';
                }

                if (item.description) html += `<p style="color: #6b7280; margin-bottom: 8px;">${item.description}</p>`;

                const listings = item.listings || [];
                if (listings.length > 0) {
                    html += '<p style="font-size: 0.85rem; margin-bottom: 8px;">Listed on: ' + listings.map(l => l.platform + ' (' + l.status + ')').join(', ') + '</p>';
                }

                html += `<div class="cost-row"><span>Purchase:</span><span>$${item.purchasePrice.toFixed(2)}</span></div>`;
                if (item.travelCost) html += `<div class="cost-row"><span>Travel:</span><span>$${item.travelCost.toFixed(2)}</span></div>`;
                if (item.materialsCost) html += `<div class="cost-row"><span>Materials:</span><span>$${item.materialsCost.toFixed(2)}</span></div>`;
                if (item.repairCost) html += `<div class="cost-row"><span>Repairs:</span><span>$${item.repairCost.toFixed(2)}</span></div>`;
                html += `<div class="cost-row total"><span>Total Cost:</span><span>$${totalCost.toFixed(2)}</span></div>`;
                if (item.salePrice) {
                    const profit = item.salePrice - totalCost;
                    html += `<div class="cost-row"><span>Sale Price:</span><span>$${item.salePrice.toFixed(2)}</span></div>`;
                    html += `<div class="cost-row" style="color: ${profit >= 0 ? '#059669' : '#dc2626'};"><span>Expected Profit:</span><span>$${profit.toFixed(2)}</span></div>`;
                }
                html += '</div>';
            });

            html += '</body></html>';

            const w = window.open('', '_blank');
            w.document.write(html);
            w.document.close();
            hideExportReportModal();
        }

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(
                URL.createObjectURL(new Blob([`
                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open('cozy-capital-v1').then(function(cache) {
                                return cache.addAll(['/']);
                            })
                        );
                    });

                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request).then(function(response) {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `], { type: 'application/javascript' }))
            ).then(registration => {
                console.log('Service Worker registered');
            }).catch(error => {
                console.log('Service Worker registration failed:', error);
            });
        }
    </script>
</body>
</html>
