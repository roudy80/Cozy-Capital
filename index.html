<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cozy Capital - Inventory & Delivery Management</title>

    <!-- PWA Configuration -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ296eSBDYXBpdGFsIiwic2hvcnRfbmFtZSI6IkNvenlfQ2FwaXRhbCIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjMWU0MGFmIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIWnBaWGRDYjNnOUlqQWdNQ0E0TkRnZ09EUTRJajQ4Y21WamRDQjRQU0l6TWlJZ2VUMGlNeklpSUhkcFpIUm9QU0kzT0RRaUlHaGxhV2RvZEQwaU56ZzBJaUJtYVd4c1BTSWpNV1UwTUdGbUlqNDhMM0psWTNRK1BIQmhkR2dnWkQwaVRUUXlNQ0ExTkRKcVpEZzRlRVF3SURRME1HZ3RNVGs0Ympjek9Dd3hNallpSUdacGJHdzlJaU5tWm1abWJXWWlQand2Y0dGMGFENDhMM04yWno0PSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            color: #1f2937;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #1e40af;
        }

        .header h1 {
            font-size: 1.875rem;
            color: #1e40af;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header .subtitle {
            color: #6b7280;
            font-size: 0.95rem;
            margin-bottom: 20px;
        }

        .main-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .main-tab {
            background: #f3f4f6;
            color: #4b5563;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .main-tab:hover {
            background: #e5e7eb;
            border-color: #1e40af;
        }

        .main-tab.active {
            background: #1e40af;
            color: white;
            border-color: #1e40af;
        }

        .main-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            min-height: 65vh;
        }

        .section-title {
            font-size: 1.5rem;
            color: #1f2937;
            margin-bottom: 24px;
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .action-button {
            width: 100%;
            background: #1e40af;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 14px 24px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 24px;
        }

        .action-button:hover {
            background: #1e3a8a;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
        }

        .stat-icon {
            font-size: 1.75rem;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .item-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px;
            transition: all 0.2s ease;
        }

        .item-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-color: #1e40af;
        }

        .item-image {
            width: 100%;
            height: 200px;
            background: #f3f4f6;
            border-radius: 4px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #9ca3af;
            border: 2px dashed #d1d5db;
            cursor: pointer;
            overflow: hidden;
        }

        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .item-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .item-description {
            color: #6b7280;
            margin-bottom: 16px;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .cost-breakdown {
            background: #f9fafb;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 0.875rem;
        }

        .cost-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            color: #4b5563;
        }

        .cost-row.total {
            font-weight: 600;
            color: #1f2937;
            padding-top: 6px;
            border-top: 1px solid #e5e7eb;
            margin-top: 6px;
        }

        .cost-row.profit {
            font-weight: 700;
            font-size: 0.95rem;
            padding-top: 8px;
            border-top: 2px solid #e5e7eb;
            margin-top: 8px;
        }

        .item-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .action-btn {
            padding: 10px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .send-btn {
            background: #1e40af;
            color: white;
        }

        .send-btn:hover {
            background: #1e3a8a;
        }

        .edit-btn {
            background: #f59e0b;
            color: white;
        }

        .edit-btn:hover {
            background: #d97706;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 32px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.15);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 {
            color: #1f2937;
            margin-bottom: 24px;
            font-size: 1.5rem;
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #1e40af;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .expense-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .expense-section h4 {
            font-size: 1rem;
            color: #1f2937;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .photo-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 6px;
            padding: 32px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #f9fafb;
        }

        .photo-upload-area:hover {
            border-color: #1e40af;
            background: #f3f4f6;
        }

        .photo-upload-area.has-file {
            border-color: #10b981;
            background: #d1fae5;
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            display: block;
        }

        .upload-text {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #1e40af;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3a8a;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.7;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 12px;
            color: #374151;
        }

        .empty-state p {
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Delivery Section */
        .delivery-section {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .delivery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .delivery-header h3 {
            color: #991b1b;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .delivery-actions {
            display: flex;
            gap: 8px;
        }

        .delivery-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .delivery-card:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .delivery-card.selected {
            border-color: #1e40af;
            background: #eff6ff;
        }

        .delivery-info {
            color: #4b5563;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .route-container {
            margin-top: 16px;
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .route-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }

        .add-stop-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-stop-btn:hover {
            background: #059669;
        }

        .stops-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stop-tile {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            cursor: grab;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stop-tile:hover {
            border-color: #1e40af;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stop-tile.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .stop-tile.destination {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            border-color: #1e40af;
            color: white;
            cursor: default;
        }

        .stop-tile.destination:hover {
            border-color: #1e40af;
        }

        .stop-number {
            background: #1e40af;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .stop-tile.destination .stop-number {
            background: white;
            color: #1e40af;
        }

        .stop-content {
            flex: 1;
            min-width: 0;
        }

        .stop-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 2px;
            word-wrap: break-word;
        }

        .stop-instructions {
            font-size: 0.8rem;
            color: #6b7280;
            font-style: italic;
        }

        .stop-tile.destination .stop-instructions {
            color: rgba(255, 255, 255, 0.9);
        }

        .stop-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .stop-icon-btn {
            background: #f3f4f6;
            border: none;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .stop-icon-btn:hover {
            background: #e5e7eb;
        }

        .stop-icon-btn.delete:hover {
            background: #fee2e2;
            color: #dc2626;
        }

        .drag-handle {
            color: #9ca3af;
            font-size: 1.2rem;
            cursor: grab;
        }

        .stop-tile.destination .drag-handle {
            color: rgba(255, 255, 255, 0.6);
            cursor: not-allowed;
        }

        .complete-delivery-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }

        .complete-delivery-btn:hover {
            background: #059669;
        }

        /* History Section */
        .history-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .filter-btn.active {
            background: #1e40af;
            color: white;
            border-color: #1e40af;
        }

        .history-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .history-item-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 1rem;
        }

        .history-item-date {
            color: #6b7280;
            font-size: 0.8rem;
        }

        .profit-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .profit-badge.positive {
            background: #d1fae5;
            color: #065f46;
        }

        .profit-badge.negative {
            background: #fee2e2;
            color: #991b1b;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header, .main-content {
                padding: 16px;
            }

            .inventory-grid {
                grid-template-columns: 1fr;
            }

            .main-tabs {
                grid-template-columns: 1fr 1fr;
            }

            .modal-content {
                padding: 24px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üè¢ Cozy Capital</h1>
            <div class="subtitle">Professional Inventory & Delivery Management</div>
            <div class="main-tabs">
                <button class="main-tab active" onclick="switchTab('furniture')">
                    üì¶ Inventory
                </button>
                <button class="main-tab" onclick="switchTab('airbnb')">
                    üè† Airbnb
                </button>
                <button class="main-tab" onclick="switchTab('history')">
                    üìä History
                </button>
                <button class="main-tab" onclick="switchTab('finances')">
                    üí∞ Finances
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Furniture Section -->
            <div id="furniture-section">
                <h2 class="section-title">Current Inventory</h2>

                <!-- Pending Deliveries -->
                <div id="pending-deliveries" class="hidden delivery-section">
                    <div class="delivery-header">
                        <h3>üöö Pending Deliveries</h3>
                        <span style="color: #6b7280; font-size: 0.875rem;">Drag stops to reorder your route</span>
                    </div>
                    <div id="deliveries-list">
                        <!-- Delivery requests will appear here -->
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="total-items">0</div>
                        <div class="stat-label">Total Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="total-invested">$0</div>
                        <div class="stat-label">Total Invested</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-value" id="potential-revenue">$0</div>
                        <div class="stat-label">Potential Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-value" id="potential-profit">$0</div>
                        <div class="stat-label">Expected Profit</div>
                    </div>
                </div>

                <button class="action-button" onclick="showAddItemModal()">
                    ‚ûï Add New Item
                </button>

                <div id="furniture-inventory" class="inventory-grid">
                    <!-- Items will appear here -->
                </div>

                <div id="furniture-empty" class="empty-state">
                    <div class="empty-icon">üì¶</div>
                    <h3>No Items in Inventory</h3>
                    <p>Start tracking your inventory by adding your first item with photos, costs, and pricing.</p>
                </div>
            </div>

            <!-- Airbnb Section -->
            <div id="airbnb-section" class="hidden">
                <h2 class="section-title">Airbnb Supplies</h2>
                <div class="empty-state">
                    <div class="empty-icon">üõèÔ∏è</div>
                    <h3>Airbnb Management Coming Soon</h3>
                    <p>Track towels, sheets, cleaning supplies, and get low-stock alerts with expense tracking and tax calculations.</p>
                </div>
            </div>

            <!-- History Section -->
            <div id="history-section" class="hidden">
                <h2 class="section-title">Sales History</h2>

                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="total-sold">0</div>
                        <div class="stat-label">Items Sold</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üíµ</div>
                        <div class="stat-value" id="total-revenue">$0</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìâ</div>
                        <div class="stat-value" id="total-costs">$0</div>
                        <div class="stat-label">Total Costs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="actual-profit">$0</div>
                        <div class="stat-label">Actual Profit</div>
                    </div>
                </div>

                <div id="history-list">
                    <!-- History items will appear here -->
                </div>

                <div id="history-empty" class="empty-state">
                    <div class="empty-icon">üìã</div>
                    <h3>No Sales History Yet</h3>
                    <p>Complete deliveries to see your sales history and profit tracking here.</p>
                </div>
            </div>

            <!-- Finances Section -->
            <div id="finances-section" class="hidden">
                <h2 class="section-title">Financial Dashboard</h2>
                <div class="empty-state">
                    <div class="empty-icon">üìä</div>
                    <h3>Financial Analytics Coming Soon</h3>
                    <p>Detailed charts showing monthly income vs expenses, profit margins, and tax calculations.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="add-item-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Add New Item</h3>
            <form id="add-item-form">
                <div class="form-group">
                    <label for="item-title">Item Name *</label>
                    <input type="text" id="item-title" required placeholder="e.g., Vintage Oak Dining Table">
                </div>

                <div class="form-group">
                    <label for="item-description">Description</label>
                    <textarea id="item-description" rows="3" placeholder="Size, condition, style, features..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="item-purchase-price">Purchase Price *</label>
                        <input type="number" id="item-purchase-price" step="0.01" required placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label for="item-sale-price">Sale Price</label>
                        <input type="number" id="item-sale-price" step="0.01" placeholder="0.00">
                    </div>
                </div>

                <div class="expense-section">
                    <h4>üí∏ Additional Costs</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="travel-cost">Travel/Pickup Cost</label>
                            <input type="number" id="travel-cost" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="materials-cost">Materials Cost</label>
                            <input type="number" id="materials-cost" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="repair-cost">Repair/Labor Cost</label>
                        <input type="number" id="repair-cost" step="0.01" placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label>Photo</label>
                    <div class="photo-upload-area" onclick="document.getElementById('item-photo').click()">
                        <span class="upload-icon">üì∏</span>
                        <span class="upload-text">Click to add photo</span>
                        <input type="file" id="item-photo" accept="image/*" style="display: none;">
                    </div>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideAddItemModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Send for Delivery Modal -->
    <div id="delivery-modal" class="modal hidden">
        <div class="modal-content">
            <h3>üì¶ Create Delivery</h3>
            <form id="delivery-form">
                <div class="form-group">
                    <label for="customer-name">Customer Name *</label>
                    <input type="text" id="customer-name" required placeholder="Customer name">
                </div>

                <div class="form-group">
                    <label for="delivery-address">Delivery Address *</label>
                    <textarea id="delivery-address" rows="2" required placeholder="Full address"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="delivery-date">Delivery Date *</label>
                        <input type="date" id="delivery-date" required>
                    </div>
                    <div class="form-group">
                        <label for="delivery-time">Time *</label>
                        <input type="time" id="delivery-time" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="final-price">Final Sale Price *</label>
                    <input type="number" id="final-price" step="0.01" required placeholder="0.00">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="payment-method">Payment Method *</label>
                        <select id="payment-method" required>
                            <option value="">Select method</option>
                            <option value="cash">üíµ Cash</option>
                            <option value="venmo">üì± Venmo</option>
                            <option value="cashapp">üí∞ Cash App</option>
                            <option value="zelle">üè¶ Zelle</option>
                            <option value="check">üìù Check</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="payment-status">Payment Status *</label>
                        <select id="payment-status" required>
                            <option value="pending">‚è≥ Pending</option>
                            <option value="paid">‚úÖ Paid</option>
                        </select>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideDeliveryModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Delivery</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Complete Delivery Modal -->
    <div id="complete-delivery-modal" class="modal hidden">
        <div class="modal-content">
            <h3>‚úÖ Complete Delivery</h3>
            <form id="complete-delivery-form">
                <div id="delivery-summary" style="background: #f9fafb; padding: 16px; border-radius: 6px; margin-bottom: 20px;">
                    <!-- Delivery info will be inserted here -->
                </div>

                <div class="form-group">
                    <label for="delivery-mileage">Delivery Mileage (miles) *</label>
                    <input type="number" id="delivery-mileage" step="0.1" required placeholder="0.0">
                    <small style="color: #6b7280; display: block; margin-top: 6px;">
                        Mileage cost: $<span id="mileage-cost">0.00</span> (at $0.67/mile)
                    </small>
                </div>

                <div class="form-group">
                    <label for="delivery-notes">Delivery Notes</label>
                    <textarea id="delivery-notes" rows="3" placeholder="Any notes about the delivery..."></textarea>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideCompleteDeliveryModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Complete Delivery</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // App State
        let currentTab = 'furniture';
        let furnitureItems = [];
        let pendingDeliveries = [];
        let salesHistory = [];
        let currentDeliveryItem = null;
        let currentCompletingDelivery = null;
        let editMode = false;
        let selectedDeliveryId = null;
        let draggedStop = null;

        // Constants
        const MILEAGE_RATE = 0.67; // IRS standard mileage rate

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadData();
            renderAll();
            setupEventListeners();
            requestNotificationPermission();
            console.log('Cozy Capital App Initialized');
        }

        // Notification System
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function showNotification(title, body, icon = 'üì¶') {
            // Always show alert
            alert(`${icon} ${title}\n\n${body}`);

            // Also try browser notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">üì¶</text></svg>',
                    badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">üì¶</text></svg>'
                });
            }
        }

        // Data Management
        function loadData() {
            furnitureItems = JSON.parse(localStorage.getItem('furniture-items') || '[]');
            pendingDeliveries = JSON.parse(localStorage.getItem('pending-deliveries') || '[]');
            salesHistory = JSON.parse(localStorage.getItem('sales-history') || '[]');
        }

        function saveData() {
            localStorage.setItem('furniture-items', JSON.stringify(furnitureItems));
            localStorage.setItem('pending-deliveries', JSON.stringify(pendingDeliveries));
            localStorage.setItem('sales-history', JSON.stringify(salesHistory));
        }

        function renderAll() {
            renderFurnitureItems();
            renderPendingDeliveries();
            renderSalesHistory();
            updateStats();
        }

        // Tab Management
        function switchTab(tab) {
            currentTab = tab;

            document.querySelectorAll('.main-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('[id$="-section"]').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(tab + '-section').classList.remove('hidden');
        }

        // Stats Updates
        function updateStats() {
            // Current inventory stats
            const totalItems = furnitureItems.length;
            const totalInvested = furnitureItems.reduce((sum, item) => {
                return sum + calculateTotalCost(item);
            }, 0);
            const potentialRevenue = furnitureItems.reduce((sum, item) => sum + (item.salePrice || 0), 0);
            const potentialProfit = potentialRevenue - totalInvested;

            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('total-invested').textContent = '$' + totalInvested.toFixed(2);
            document.getElementById('potential-revenue').textContent = '$' + potentialRevenue.toFixed(2);
            document.getElementById('potential-profit').textContent = '$' + potentialProfit.toFixed(2);

            const profitElement = document.getElementById('potential-profit');
            profitElement.style.color = potentialProfit >= 0 ? '#059669' : '#dc2626';

            // Sales history stats
            const totalSold = salesHistory.length;
            const totalRevenue = salesHistory.reduce((sum, sale) => sum + sale.finalPrice, 0);
            const totalCosts = salesHistory.reduce((sum, sale) => sum + sale.totalCost, 0);
            const actualProfit = totalRevenue - totalCosts;

            document.getElementById('total-sold').textContent = totalSold;
            document.getElementById('total-revenue').textContent = '$' + totalRevenue.toFixed(2);
            document.getElementById('total-costs').textContent = '$' + totalCosts.toFixed(2);
            document.getElementById('actual-profit').textContent = '$' + actualProfit.toFixed(2);

            const actualProfitElement = document.getElementById('actual-profit');
            actualProfitElement.style.color = actualProfit >= 0 ? '#059669' : '#dc2626';
        }

        function calculateTotalCost(item) {
            return (item.purchasePrice || 0) +
                   (item.travelCost || 0) +
                   (item.materialsCost || 0) +
                   (item.repairCost || 0) +
                   (item.deliveryMileageCost || 0);
        }

        // Furniture Items Rendering
        function renderFurnitureItems() {
            const container = document.getElementById('furniture-inventory');
            const emptyState = document.getElementById('furniture-empty');

            if (furnitureItems.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = '';

            furnitureItems.forEach(item => {
                const card = createItemCard(item);
                container.appendChild(card);
            });
        }

        function createItemCard(item) {
            const card = document.createElement('div');
            card.className = 'item-card';

            const totalCost = calculateTotalCost(item);
            const profit = (item.salePrice || 0) - totalCost;
            const profitColor = profit >= 0 ? '#059669' : '#dc2626';

            card.innerHTML = `
                <div class="item-image" onclick="viewPhoto('${item.id}')">
                    ${item.photo ? `<img src="${item.photo}" alt="${item.title}">` : 'üì¶'}
                </div>
                <div class="item-title">${item.title}</div>
                <div class="item-description">${item.description || 'No description'}</div>
                <div class="cost-breakdown">
                    <div class="cost-row">
                        <span>Purchase:</span>
                        <span>$${item.purchasePrice.toFixed(2)}</span>
                    </div>
                    ${item.travelCost ? `<div class="cost-row">
                        <span>Travel:</span>
                        <span>$${item.travelCost.toFixed(2)}</span>
                    </div>` : ''}
                    ${item.materialsCost ? `<div class="cost-row">
                        <span>Materials:</span>
                        <span>$${item.materialsCost.toFixed(2)}</span>
                    </div>` : ''}
                    ${item.repairCost ? `<div class="cost-row">
                        <span>Repairs:</span>
                        <span>$${item.repairCost.toFixed(2)}</span>
                    </div>` : ''}
                    <div class="cost-row total">
                        <span>Total Cost:</span>
                        <span>$${totalCost.toFixed(2)}</span>
                    </div>
                    ${item.salePrice ? `
                    <div class="cost-row" style="color: #1e40af; font-weight: 600;">
                        <span>Sale Price:</span>
                        <span>$${item.salePrice.toFixed(2)}</span>
                    </div>
                    <div class="cost-row profit" style="color: ${profitColor};">
                        <span>Expected Profit:</span>
                        <span>$${profit.toFixed(2)}</span>
                    </div>` : ''}
                </div>
                <div class="item-actions">
                    <button class="action-btn send-btn" onclick="showDeliveryModal('${item.id}')">
                        üì¶ Deliver
                    </button>
                    <button class="action-btn edit-btn" onclick="editItem('${item.id}')">
                        ‚úèÔ∏è Edit
                    </button>
                    <button class="action-btn delete-btn" onclick="deleteItem('${item.id}')">
                        üóëÔ∏è
                    </button>
                </div>
            `;

            return card;
        }

        // Modal Management
        function showAddItemModal() {
            document.getElementById('add-item-modal').classList.remove('hidden');
        }

        function hideAddItemModal() {
            document.getElementById('add-item-modal').classList.add('hidden');
            document.getElementById('add-item-form').reset();
            resetPhotoUpload();
            document.querySelector('#add-item-modal h3').textContent = 'Add New Item';
            document.querySelector('#add-item-form button[type="submit"]').textContent = 'Add Item';
            window.editingItemId = null;
        }

        function showDeliveryModal(itemId) {
            currentDeliveryItem = furnitureItems.find(item => item.id === itemId);
            document.getElementById('final-price').value = currentDeliveryItem.salePrice || '';
            document.getElementById('delivery-modal').classList.remove('hidden');
        }

        function hideDeliveryModal() {
            document.getElementById('delivery-modal').classList.add('hidden');
            document.getElementById('delivery-form').reset();
            currentDeliveryItem = null;
        }

        function showCompleteDeliveryModal(deliveryId) {
            currentCompletingDelivery = pendingDeliveries.find(d => d.id === deliveryId);
            if (!currentCompletingDelivery) return;

            const summary = document.getElementById('delivery-summary');
            const datetime = new Date(currentCompletingDelivery.datetime);
            summary.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">üì¶ ${currentCompletingDelivery.item}</div>
                <div style="color: #6b7280; font-size: 0.875rem; line-height: 1.6;">
                    üë§ ${currentCompletingDelivery.customer}<br>
                    üìç ${currentCompletingDelivery.address}<br>
                    üí∞ $${currentCompletingDelivery.price}
                </div>
            `;

            document.getElementById('complete-delivery-modal').classList.remove('hidden');
        }

        function hideCompleteDeliveryModal() {
            document.getElementById('complete-delivery-modal').classList.add('hidden');
            document.getElementById('complete-delivery-form').reset();
            currentCompletingDelivery = null;
        }

        // Photo Upload
        function setupEventListeners() {
            const photoInput = document.getElementById('item-photo');
            const uploadArea = document.querySelector('.photo-upload-area');

            photoInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    uploadArea.classList.add('has-file');
                    uploadArea.querySelector('.upload-text').textContent = `üì∏ ${e.target.files[0].name}`;
                } else {
                    resetPhotoUpload();
                }
            });

            // Mileage cost calculator
            document.getElementById('delivery-mileage').addEventListener('input', function(e) {
                const miles = parseFloat(e.target.value) || 0;
                const cost = miles * MILEAGE_RATE;
                document.getElementById('mileage-cost').textContent = cost.toFixed(2);
            });

            // Add/Edit Item Form
            document.getElementById('add-item-form').addEventListener('submit', handleAddEditItem);

            // Delivery Form
            document.getElementById('delivery-form').addEventListener('submit', handleCreateDelivery);

            // Complete Delivery Form
            document.getElementById('complete-delivery-form').addEventListener('submit', handleCompleteDelivery);
        }

        function resetPhotoUpload() {
            const uploadArea = document.querySelector('.photo-upload-area');
            uploadArea.classList.remove('has-file');
            uploadArea.querySelector('.upload-text').textContent = 'Click to add photo';
        }

        // Form Handlers
        function handleAddEditItem(e) {
            e.preventDefault();

            const title = document.getElementById('item-title').value;
            const description = document.getElementById('item-description').value;
            const purchasePrice = parseFloat(document.getElementById('item-purchase-price').value);
            const salePrice = parseFloat(document.getElementById('item-sale-price').value) || null;
            const travelCost = parseFloat(document.getElementById('travel-cost').value) || 0;
            const materialsCost = parseFloat(document.getElementById('materials-cost').value) || 0;
            const repairCost = parseFloat(document.getElementById('repair-cost').value) || 0;
            const photoFile = document.getElementById('item-photo').files[0];

            const itemData = {
                title,
                description,
                purchasePrice,
                salePrice,
                travelCost,
                materialsCost,
                repairCost,
                updatedAt: new Date().toISOString()
            };

            if (window.editingItemId) {
                // Edit existing item
                const itemIndex = furnitureItems.findIndex(item => item.id === window.editingItemId);
                if (itemIndex !== -1) {
                    furnitureItems[itemIndex] = { ...furnitureItems[itemIndex], ...itemData };

                    if (photoFile) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            furnitureItems[itemIndex].photo = e.target.result;
                            saveData();
                            renderAll();
                            hideAddItemModal();
                        };
                        reader.readAsDataURL(photoFile);
                    } else {
                        saveData();
                        renderAll();
                        hideAddItemModal();
                    }
                }
            } else {
                // Add new item
                const newItem = {
                    id: 'item' + Date.now(),
                    ...itemData,
                    createdAt: new Date().toISOString(),
                    photo: null
                };

                if (photoFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        newItem.photo = e.target.result;
                        furnitureItems.push(newItem);
                        saveData();
                        renderAll();
                        hideAddItemModal();
                    };
                    reader.readAsDataURL(photoFile);
                } else {
                    furnitureItems.push(newItem);
                    saveData();
                    renderAll();
                    hideAddItemModal();
                }
            }
        }

        function handleCreateDelivery(e) {
            e.preventDefault();

            const date = document.getElementById('delivery-date').value;
            const time = document.getElementById('delivery-time').value;
            const datetime = new Date(`${date}T${time}`).toISOString();

            const customerName = document.getElementById('customer-name').value;
            const itemName = currentDeliveryItem.title;

            const deliveryRequest = {
                id: 'delivery' + Date.now(),
                item: itemName,
                itemId: currentDeliveryItem.id,
                customer: customerName,
                address: document.getElementById('delivery-address').value,
                datetime: datetime,
                price: parseFloat(document.getElementById('final-price').value),
                paymentMethod: document.getElementById('payment-method').value,
                paymentStatus: document.getElementById('payment-status').value,
                tripStops: [],
                sentAt: new Date().toISOString()
            };

            pendingDeliveries.push(deliveryRequest);
            saveData();
            renderPendingDeliveries();

            hideDeliveryModal();

            // Success notification
            const deliveryDate = new Date(datetime);
            showNotification(
                'Delivery Created!',
                `${itemName} for ${customerName}\n${deliveryDate.toLocaleDateString()} at ${deliveryDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}\n\nUse "+ Add Stop" to plan your route!`,
                'üöö'
            );
        }

        function handleCompleteDelivery(e) {
            e.preventDefault();

            const mileage = parseFloat(document.getElementById('delivery-mileage').value);
            const mileageCost = mileage * MILEAGE_RATE;
            const notes = document.getElementById('delivery-notes').value;

            // Find the item
            const item = furnitureItems.find(i => i.id === currentCompletingDelivery.itemId);
            if (!item) return;

            // Calculate final costs
            const totalCost = calculateTotalCost(item) + mileageCost;
            const profit = currentCompletingDelivery.price - totalCost;

            // Create history entry
            const historyEntry = {
                id: 'history' + Date.now(),
                item: currentCompletingDelivery.item,
                customer: currentCompletingDelivery.customer,
                finalPrice: currentCompletingDelivery.price,
                purchasePrice: item.purchasePrice,
                travelCost: item.travelCost || 0,
                materialsCost: item.materialsCost || 0,
                repairCost: item.repairCost || 0,
                deliveryMileage: mileage,
                deliveryMileageCost: mileageCost,
                totalCost: totalCost,
                profit: profit,
                paymentMethod: currentCompletingDelivery.paymentMethod,
                paymentStatus: currentCompletingDelivery.paymentStatus,
                deliveryDate: currentCompletingDelivery.datetime,
                completedDate: new Date().toISOString(),
                notes: notes,
                photo: item.photo
            };

            salesHistory.push(historyEntry);

            // Remove from pending deliveries
            pendingDeliveries = pendingDeliveries.filter(d => d.id !== currentCompletingDelivery.id);

            // Remove from inventory
            furnitureItems = furnitureItems.filter(i => i.id !== currentCompletingDelivery.itemId);

            saveData();
            renderAll();
            hideCompleteDeliveryModal();

            // Success notification
            const profitStr = profit >= 0 ? `+$${profit.toFixed(2)}` : `-$${Math.abs(profit).toFixed(2)}`;
            showNotification(
                'Delivery Completed!',
                `${historyEntry.item}\nProfit: ${profitStr}\n\nCheck the History tab for details!`,
                '‚úÖ'
            );
        }

        // Item Actions
        function editItem(itemId) {
            const item = furnitureItems.find(item => item.id === itemId);
            if (!item) return;

            document.getElementById('item-title').value = item.title;
            document.getElementById('item-description').value = item.description || '';
            document.getElementById('item-purchase-price').value = item.purchasePrice;
            document.getElementById('item-sale-price').value = item.salePrice || '';
            document.getElementById('travel-cost').value = item.travelCost || '';
            document.getElementById('materials-cost').value = item.materialsCost || '';
            document.getElementById('repair-cost').value = item.repairCost || '';

            document.querySelector('#add-item-modal h3').textContent = 'Edit Item';
            document.querySelector('#add-item-form button[type="submit"]').textContent = 'Update Item';

            window.editingItemId = itemId;
            showAddItemModal();
        }

        function deleteItem(itemId) {
            const item = furnitureItems.find(item => item.id === itemId);
            if (confirm(`Delete "${item.title}"? This cannot be undone.`)) {
                furnitureItems = furnitureItems.filter(item => item.id !== itemId);
                saveData();
                renderAll();
            }
        }

        function viewPhoto(itemId) {
            const item = furnitureItems.find(item => item.id === itemId);
            if (item.photo) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 90vw; padding: 24px;">
                        <h3>${item.title}</h3>
                        <img src="${item.photo}" style="width: 100%; height: auto; max-height: 70vh; object-fit: contain; border-radius: 6px; margin-top: 16px;">
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                        </div>
                    </div>
                `;
                modal.onclick = (e) => {
                    if (e.target === modal) modal.remove();
                };
                document.body.appendChild(modal);
            }
        }

        // Delivery Management
        function renderPendingDeliveries() {
            const container = document.getElementById('pending-deliveries');
            const list = document.getElementById('deliveries-list');

            if (pendingDeliveries.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            list.innerHTML = '';

            pendingDeliveries.forEach(delivery => {
                const deliveryCard = document.createElement('div');
                deliveryCard.className = 'delivery-card';

                const datetime = new Date(delivery.datetime);
                const dateStr = datetime.toLocaleDateString();
                const timeStr = datetime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                // Build route with all stops including destination
                const allStops = [...(delivery.tripStops || [])];

                let routeHtml = '';
                if (allStops.length > 0 || delivery.address) {
                    routeHtml = `
                        <div class="route-container">
                            <div class="route-header">
                                <span class="route-label">üó∫Ô∏è Delivery Route</span>
                                <button class="add-stop-btn" onclick="addStopToDelivery('${delivery.id}')">
                                    ‚ûï Add Stop
                                </button>
                            </div>
                            <div class="stops-list" id="stops-${delivery.id}">
                                ${allStops.map((stop, index) => createStopTileHTML(delivery.id, stop, index)).join('')}
                                ${createDestinationTileHTML(delivery, allStops.length)}
                            </div>
                        </div>
                    `;
                }

                deliveryCard.innerHTML = `
                    <div style="font-weight: 600; color: #1f2937; margin-bottom: 8px;">üì¶ ${delivery.item}</div>
                    <div class="delivery-info">
                        üë§ ${delivery.customer}<br>
                        üìÖ ${dateStr} at ${timeStr}<br>
                        üí∞ $${delivery.price} - ${delivery.paymentMethod} (${delivery.paymentStatus})
                    </div>
                    ${routeHtml}
                    <button onclick="showCompleteDeliveryModal('${delivery.id}')" class="complete-delivery-btn">
                        ‚úÖ Mark Delivered
                    </button>
                `;

                list.appendChild(deliveryCard);
            });
        }

        function createStopTileHTML(deliveryId, stop, index) {
            return `
                <div class="stop-tile" draggable="true"
                     data-stop-id="${stop.id}"
                     ondragstart="handleStopDragStart(event, '${deliveryId}', '${stop.id}')"
                     ondragover="handleStopDragOver(event)"
                     ondrop="handleStopDrop(event, '${deliveryId}', '${stop.id}')"
                     ondragend="handleStopDragEnd(event)">
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <div class="stop-number">${index + 1}</div>
                    <div class="stop-content">
                        <div class="stop-name">${stop.name}</div>
                        ${stop.instructions ? `<div class="stop-instructions">${stop.instructions}</div>` : ''}
                    </div>
                    <div class="stop-actions">
                        <button class="stop-icon-btn" onclick="editStop('${deliveryId}', '${stop.id}')" title="Edit">
                            ‚úèÔ∏è
                        </button>
                        <button class="stop-icon-btn delete" onclick="removeStop('${deliveryId}', '${stop.id}')" title="Remove">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `;
        }

        function createDestinationTileHTML(delivery, stopCount) {
            return `
                <div class="stop-tile destination">
                    <span class="drag-handle">üéØ</span>
                    <div class="stop-number">${stopCount + 1}</div>
                    <div class="stop-content">
                        <div class="stop-name">Final Destination</div>
                        <div class="stop-instructions">${delivery.address}</div>
                    </div>
                </div>
            `;
        }

        function addStopToDelivery(deliveryId) {
            const delivery = pendingDeliveries.find(d => d.id === deliveryId);
            if (!delivery) return;

            const stopName = prompt('üìç Enter stop name:\n(e.g., Walmart, Gas Station, Home Depot)');
            if (!stopName || stopName.trim() === '') return;

            const instructions = prompt('üìù Add instructions (optional):\n(e.g., "Pick up screws", "Get cleaning supplies")') || '';

            const newStop = {
                id: 'stop' + Date.now(),
                name: stopName.trim(),
                instructions: instructions.trim()
            };

            if (!delivery.tripStops) {
                delivery.tripStops = [];
            }
            delivery.tripStops.push(newStop);

            saveData();
            renderPendingDeliveries();

            // Success notification
            showNotification(
                'Stop Added!',
                `${stopName}\n${instructions || 'No instructions'}\n\nDrag to reorder.`,
                'üìç'
            );
        }

        function editStop(deliveryId, stopId) {
            const delivery = pendingDeliveries.find(d => d.id === deliveryId);
            if (!delivery) return;

            const stop = delivery.tripStops.find(s => s.id === stopId);
            if (!stop) return;

            const newName = prompt('üìç Edit stop name:', stop.name);
            if (!newName || newName.trim() === '') return;

            const newInstructions = prompt('üìù Edit instructions:', stop.instructions || '');

            stop.name = newName.trim();
            stop.instructions = newInstructions.trim();

            saveData();
            renderPendingDeliveries();
        }

        function removeStop(deliveryId, stopId) {
            const delivery = pendingDeliveries.find(d => d.id === deliveryId);
            if (!delivery) return;

            const stop = delivery.tripStops.find(s => s.id === stopId);
            if (!confirm(`Remove stop: ${stop.name}?`)) return;

            delivery.tripStops = delivery.tripStops.filter(s => s.id !== stopId);
            saveData();
            renderPendingDeliveries();
        }

        // Drag and Drop for Route Stops
        function handleStopDragStart(event, deliveryId, stopId) {
            event.target.classList.add('dragging');
            draggedStop = { deliveryId, stopId };
        }

        function handleStopDragOver(event) {
            event.preventDefault();
        }

        function handleStopDrop(event, deliveryId, targetStopId) {
            if (!draggedStop) return;
            event.preventDefault();

            if (draggedStop.deliveryId !== deliveryId) return;
            if (draggedStop.stopId === targetStopId) return;

            const delivery = pendingDeliveries.find(d => d.id === deliveryId);
            if (!delivery) return;

            const draggedIndex = delivery.tripStops.findIndex(s => s.id === draggedStop.stopId);
            const targetIndex = delivery.tripStops.findIndex(s => s.id === targetStopId);

            if (draggedIndex === -1 || targetIndex === -1) return;

            const [draggedItem] = delivery.tripStops.splice(draggedIndex, 1);
            delivery.tripStops.splice(targetIndex, 0, draggedItem);

            saveData();
            renderPendingDeliveries();
        }

        function handleStopDragEnd(event) {
            event.target.classList.remove('dragging');
            draggedStop = null;
        }

        // Sales History
        function renderSalesHistory() {
            const list = document.getElementById('history-list');
            const emptyState = document.getElementById('history-empty');

            if (salesHistory.length === 0) {
                list.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            list.innerHTML = '';

            // Sort by completion date, newest first
            const sorted = [...salesHistory].sort((a, b) =>
                new Date(b.completedDate) - new Date(a.completedDate)
            );

            sorted.forEach(sale => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';

                const completedDate = new Date(sale.completedDate);
                const dateStr = completedDate.toLocaleDateString();

                const profitClass = sale.profit >= 0 ? 'positive' : 'negative';

                historyItem.innerHTML = `
                    <div class="history-item-header">
                        <div>
                            <div class="history-item-title">${sale.item}</div>
                            <div class="history-item-date">${dateStr} ‚Ä¢ ${sale.customer}</div>
                        </div>
                        <span class="profit-badge ${profitClass}">
                            ${sale.profit >= 0 ? '+' : ''}$${sale.profit.toFixed(2)}
                        </span>
                    </div>
                    <div class="cost-breakdown">
                        <div class="cost-row">
                            <span>Purchase:</span>
                            <span>$${sale.purchasePrice.toFixed(2)}</span>
                        </div>
                        ${sale.travelCost ? `<div class="cost-row"><span>Travel:</span><span>$${sale.travelCost.toFixed(2)}</span></div>` : ''}
                        ${sale.materialsCost ? `<div class="cost-row"><span>Materials:</span><span>$${sale.materialsCost.toFixed(2)}</span></div>` : ''}
                        ${sale.repairCost ? `<div class="cost-row"><span>Repairs:</span><span>$${sale.repairCost.toFixed(2)}</span></div>` : ''}
                        ${sale.deliveryMileageCost ? `<div class="cost-row"><span>Delivery (${sale.deliveryMileage} mi):</span><span>$${sale.deliveryMileageCost.toFixed(2)}</span></div>` : ''}
                        <div class="cost-row total">
                            <span>Total Cost:</span>
                            <span>$${sale.totalCost.toFixed(2)}</span>
                        </div>
                        <div class="cost-row" style="color: #1e40af; font-weight: 600;">
                            <span>Sale Price:</span>
                            <span>$${sale.finalPrice.toFixed(2)}</span>
                        </div>
                    </div>
                    ${sale.notes ? `<div style="margin-top: 12px; color: #6b7280; font-size: 0.875rem; font-style: italic;">${sale.notes}</div>` : ''}
                `;

                list.appendChild(historyItem);
            });
        }

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(
                URL.createObjectURL(new Blob([`
                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open('cozy-capital-v1').then(function(cache) {
                                return cache.addAll(['/']);
                            })
                        );
                    });

                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request).then(function(response) {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `], { type: 'application/javascript' }))
            ).then(registration => {
                console.log('Service Worker registered');
            }).catch(error => {
                console.log('Service Worker registration failed:', error);
            });
        }
    </script>
</body>
</html>
